* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
}

:root {
    --primary: #8B0000;
    --primary-dark: #600000;
    --primary-light: #330000;
    --secondary: #1A1A1A;
    --accent-red: #FF0000;
    --accent-pink: #CC0000;
    --text: #E0E0E0;
    --text-light: #A0A0A0;
    --border: #333333;
    --background: #0D0D0D;
    --radius: 8px;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    --success: #228B22;
    --warning: #FFA500;
    --info: #4285F4;
    --card-bg: rgba(26, 26, 26, 0.85);
    --border-color: rgba(51, 51, 51, 0.7);
    --accent-color: #8B0000;
    --text-color: #E0E0E0;
    --text-muted: #A0A0A0;
}

body {
    background: linear-gradient(rgba(13, 13, 13, 0.9), rgba(13, 13, 13, 0.9)), url('backgroundCars.jpg') center/cover fixed;
    color: var(--text);
    min-height: 100vh;
    /* ğŸ”¥ Î‘Î Î‘Î“ÎŸÎ¡Î•Î¥Î£Î— ZOOM OUT Î£Î¤Î‘ ÎšÎ™ÎÎ—Î¤Î‘ */
    touch-action: pan-y;
    -webkit-text-size-adjust: 100%;
    -moz-text-size-adjust: 100%;
    text-size-adjust: 100%;
    overflow-x: hidden;
}

/* ğŸ”¥ ÎšÎ¡Î™Î¤Î™ÎšÎ— Î‘Î›Î›Î‘Î“Î—: Î‘Î ÎŸÎšÎ¡Î¥Î¨Î— ÎšÎŸÎšÎšÎ™ÎÎŸÎ¥ Î£ÎšÎ¡ÎŸÎ› ÎœÎ Î‘Î¡ Î£Î¤ÎŸ NAVIGATION */
#main-nav {
    background: rgba(26, 26, 26, 0.95);
    backdrop-filter: blur(12px);
    padding: 8px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.7);
    border-bottom: 1px solid var(--border-color);
    position: sticky;
    top: 0;
    z-index: 100;
    width: 100%;
    overflow-x: hidden;
    /* ğŸ”¥ Î‘Î ÎŸÎšÎ¡Î¥Î¨Î— ÎšÎŸÎšÎšÎ™ÎÎŸÎ¥ Î£ÎšÎ¡ÎŸÎ› ÎœÎ Î‘Î¡ */
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
}

/* ğŸ”¥ ÎšÎ¡Î™Î¤Î™ÎšÎ— Î‘Î›Î›Î‘Î“Î—: Î‘Î ÎŸÎšÎ¡Î¥Î¨Î— ÎšÎŸÎšÎšÎ™ÎÎŸÎ¥ Î£ÎšÎ¡ÎŸÎ› ÎœÎ Î‘Î¡ Î“Î™Î‘ Chrome, Safari, Opera */
#main-nav::-webkit-scrollbar {
    display: none;
}

.nav-brand .nav-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    border-radius: var(--radius);
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 50px;
    width: 250px;
    min-width: 250px;
    max-width: 250px;
    overflow: hidden;
}

.nav-logo {
    width: 100%;
    height: 100%;
    object-fit: fill;
    display: block;
    min-width: 100%;
    min-height: 100%;
    filter: brightness(1.05) contrast(1.1);
    image-rendering: auto;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
    image-rendering: high-quality;
}

.nav-actions {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: nowrap;
    overflow-x: visible;
}

.nav-username {
    color: var(--text);
    font-weight: 600;
    padding: 0 12px;
    white-space: nowrap;
}

.nav-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 12px 16px;
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 600;
    font-size: 0.9rem;
    position: relative;
    white-space: nowrap;
    flex-shrink: 0;
}

.nav-btn:hover {
    background: var(--accent-red);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(255, 0, 0, 0.3);
}

/* Icons styling */
.nav-btn i,
.btn i,
.cta-btn i,
.send-btn i,
.action-btn i {
    margin-right: 8px;
    font-size: 0.9em;
}

.feature-icon i {
    font-size: 2.5rem;
    color: var(--accent-red);
}

.btn-icon i {
    font-size: 1.1rem;
}

.input-action-btn i {
    font-size: 1.2rem;
}

.nav-btn i,
.btn-primary i,
.cta-btn i,
.send-btn i {
    color: inherit;
}

.btn-icon i,
.input-action-btn i {
    color: var(--text-light);
}

.btn-icon:hover i,
.input-action-btn:hover i {
    color: var(--accent-red);
}

/* Pages */
.page {
    display: none;
    min-height: calc(100vh - 66px);
}

.page.active {
    display: block;
}

/* Home Page */
#home-page {
    padding: 0;
}

.hero-section {
    background: linear-gradient(rgba(13, 13, 13, 0.7), rgba(13, 13, 13, 0.7)), url('backgroundCars.jpg') center/cover fixed;
    color: white;
    padding: 80px 30px;
    text-align: center;
    position: relative;
    z-index: 1;
}

.hero-section h1 {
    font-size: 2.8rem;
    margin-bottom: 16px;
    font-weight: 700;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
}

.hero-section p {
    font-size: 1.1rem;
    margin-bottom: 30px;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
    opacity: 0.9;
    line-height: 1.5;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
}

/* ğŸ”¥ ÎšÎ¡Î™Î¤Î™ÎšÎ— Î‘Î›Î›Î‘Î“Î—: ÎœÎ•Î“Î‘Î›Î— Î‘Î ÎŸÎ£Î¤Î‘Î£Î— 25px Î‘ÎÎ‘ÎœÎ•Î£Î‘ Î£Î• ÎŸÎ›Î‘ Î¤Î‘ ÎšÎŸÎ¥ÎœÎ Î™Î‘ Î£Î¤Î—Î Î‘Î¡Î§Î™ÎšÎ— Î£Î•Î›Î™Î”Î‘ */
.hero-section #home-cta-logged-out,
.hero-section #home-cta-logged-in {
    display: flex;
    flex-direction: row; /* ğŸ”¥ Î£Ï„Î®Î½Îµ Ï„Î± ÎºÎ¿Ï…Î¼Ï€Î¹Î¬ Ï„Î¿ Î­Î½Î± Î´Î¯Ï€Î»Î± ÏƒÏ„Î¿ Î¬Î»Î»Î¿ */
    gap: 25px; /* ğŸ”¥ ÎœÎ•Î“Î‘Î›Î— Î‘Î ÎŸÎ£Î¤Î‘Î£Î— 25px */
    justify-content: center;
    align-items: center;
    margin-top: 20px;
    flex-wrap: wrap;
}

.cta-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 14px 28px;
    border-radius: var(--radius);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    flex: 0 0 auto; /* ğŸ”¥ ÎÎ± Î¼Î·Î½ Î±Î»Î»Î¬Î¶Î¿Ï…Î½ Î¼Î­Î³ÎµÎ¸Î¿Ï‚ */
    min-width: 180px; /* ğŸ”¥ Î•Î»Î¬Ï‡Î¹ÏƒÏ„Î¿ Ï€Î»Î¬Ï„Î¿Ï‚ Î³Î¹Î± Î½Î± ÎµÎ¯Î½Î±Î¹ Î¯Î´Î¹Î¿ Î¼Î­Î³ÎµÎ¸Î¿Ï‚ */
    text-align: center;
}

.cta-btn:hover {
    background: var(--accent-red);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 0, 0, 0.3);
}

.cta-btn-secondary {
    background: var(--primary);
    color: white;
    border: none;
    padding: 14px 28px;
    border-radius: var(--radius);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    flex: 0 0 auto; /* ğŸ”¥ ÎÎ± Î¼Î·Î½ Î±Î»Î»Î¬Î¶Î¿Ï…Î½ Î¼Î­Î³ÎµÎ¸Î¿Ï‚ */
    min-width: 180px; /* ğŸ”¥ Î•Î»Î¬Ï‡Î¹ÏƒÏ„Î¿ Ï€Î»Î¬Ï„Î¿Ï‚ Î³Î¹Î± Î½Î± ÎµÎ¯Î½Î±Î¹ Î¯Î´Î¹Î¿ Î¼Î­Î³ÎµÎ¸Î¿Ï‚ */
    text-align: center;
}

.cta-btn-secondary:hover {
    background: var(--accent-red);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 0, 0, 0.3);
}

/* ğŸ”¥ Î’Î•Î›Î¤Î™Î©Î£Î—: ÎšÎ¹Î½Î¿ÏÎ¼ÎµÎ½Î· ÏƒÎºÎ¹Î¬ Î³Î¹Î± Î½Î± Ï†Î±Î¯Î½Î¿Î½Ï„Î±Î¹ Î¾ÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„Î¬ */
.hero-section #home-cta-logged-out .cta-btn:hover,
.hero-section #home-cta-logged-out .cta-btn-secondary:hover,
.hero-section #home-cta-logged-in .cta-btn:hover,
.hero-section #home-cta-logged-in .cta-btn-secondary:hover {
    box-shadow: 0 8px 20px rgba(255, 0, 0, 0.4);
    transform: translateY(-3px);
}

.features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    padding: 60px 30px;
    max-width: 1000px;
    margin: 0 auto;
}

.feature-card {
    background: var(--card-bg);
    backdrop-filter: blur(10px);
    padding: 25px;
    border-radius: var(--radius);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    text-align: center;
    transition: all 0.2s ease;
    border: 1px solid var(--border-color);
}

.feature-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(139, 0, 0, 0.3);
    background: rgba(38, 38, 38, 0.9);
}

.feature-icon {
    margin-bottom: 15px;
}

.feature-card h3 {
    margin-bottom: 12px;
    color: var(--text);
    font-size: 1.2rem;
}

.feature-card p {
    color: var(--text-light);
    line-height: 1.5;
    font-size: 0.9rem;
}

/* Rooms Page */
.rooms-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 20px;
}

.rooms-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.rooms-header h2 {
    font-size: 2rem;
    color: var(--text);
}

.rooms-actions {
    display: flex;
    gap: 10px;
}

.rooms-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
}

.room-card {
    background: var(--card-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 20px;
    transition: all 0.2s ease;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    position: relative;
}

.room-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(139, 0, 0, 0.3);
    background: rgba(38, 38, 38, 0.9);
}

.room-card-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 15px;
}

.room-card-header h3 {
    font-size: 1.2rem;
    color: var(--text);
}

.room-invite-code {
    background: var(--primary-light);
    color: var(--accent-red);
    padding: 8px 12px;
    border-radius: var(--radius);
    font-weight: 600;
    font-size: 0.85rem;
}

.room-card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 15px;
    border-top: 1px solid var(--border-color);
}

.room-created {
    font-size: 0.85rem;
    color: var(--text-light);
}

.no-rooms {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-light);
}

.no-rooms p {
    margin-bottom: 10px;
}

/* Chat Layout - FIXED: Proper sidebar on left */
.chat-layout {
    display: flex;
    height: calc(100vh - 66px);
    background: rgba(26, 26, 26, 0.7);
    backdrop-filter: blur(8px);
    position: relative;
    overflow: hidden;
}

/* Sidebar - FIXED: Proper left positioning */
#sidebar {
    width: 280px;
    background: rgba(38, 38, 38, 0.8);
    backdrop-filter: blur(10px);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    position: relative;
    z-index: 1;
    flex-shrink: 0;
}

.sidebar-header {
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
}

.sidebar-header h2 {
    font-size: 1.3rem;
    margin-bottom: 6px;
    color: var(--text);
}

.room-info {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.85rem;
    color: var(--text-light);
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--success);
}

/* Room Details */
.room-details {
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
}

.invite-code-section label {
    display: block;
    font-size: 0.75rem;
    color: var(--text-light);
    text-transform: uppercase;
    margin-bottom: 6px;
    font-weight: 600;
}

.invite-code-display {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--primary-light);
    padding: 12px 16px;
    border-radius: var(--radius);
}

.invite-code-display span {
    flex: 1;
    font-weight: 600;
    color: var(--accent-red);
    font-size: 1.1rem;
    letter-spacing: 2px;
}

.btn-icon {
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 8px;
    border-radius: var(--radius);
    transition: all 0.2s ease;
}

.btn-icon:hover {
    background: rgba(139, 0, 0, 0.2);
}

/* Room Members */
.room-members-section {
    padding: 15px;
    flex: 1;
    overflow-y: auto;
}

.room-members-section h3 {
    font-size: 0.75rem;
    color: var(--text-light);
    text-transform: uppercase;
    margin-bottom: 10px;
    font-weight: 600;
}

#room-members-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.member-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px;
    border-radius: var(--radius);
    transition: all 0.2s ease;
    position: relative;
    cursor: pointer;
}

.member-item:hover {
    background: rgba(51, 51, 51, 0.5);
    transform: translateX(5px);
}

.member-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.75rem;
    color: white;
    flex-shrink: 0;
    overflow: hidden;
}

.member-info {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.member-name {
    font-weight: 500;
    font-size: 0.9rem;
    color: var(--text);
}

.member-joined {
    font-size: 0.75rem;
    color: var(--text-light);
}

/* User Profile - FIXED: At bottom of sidebar */
.user-profile {
    padding: 12px 15px;
    background: rgba(38, 38, 38, 0.8);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    gap: 10px;
    border-top: 1px solid var(--border-color);
    margin-top: auto;
}

.profile-avatar .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
    overflow: hidden;
}

.profile-info {
    flex: 1;
}

.profile-name {
    display: block;
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text);
}

.profile-status {
    font-size: 0.75rem;
    color: var(--text-light);
}

/* Main Chat - FIXED: Shows last message properly */
#main-chat {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: rgba(26, 26, 26, 0.5);
    position: relative;
    height: 100%;
    min-width: 0;
    overflow: hidden;
}

.chat-header {
    padding: 15px 20px;
    background: rgba(38, 38, 38, 0.8);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
}

.chat-info h2 {
    font-size: 1.2rem;
    color: var(--text);
    margin-bottom: 2px;
}

.chat-description {
    font-size: 0.8rem;
    color: var(--text-light);
}

.chat-actions {
    display: flex;
    gap: 8px;
}

.action-btn {
    background: transparent;
    border: 1px solid var(--border-color);
    padding: 10px 16px;
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.8rem;
    font-weight: 500;
}

.clear-btn {
    background: var(--accent-red);
    color: white;
    border-color: var(--accent-red);
}

.clear-btn:hover {
    background: #CC0000;
}

/* Messages - FIXED: Shows last message properly */
#messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: rgba(26, 26, 26, 0.5);
    display: flex;
    flex-direction: column;
    gap: 12px;
    position: relative;
    height: calc(100% - 140px);
    min-height: 0;
}

/* ğŸ”¥ ÎšÎ¡Î™Î¤Î™ÎšÎ— Î‘Î›Î›Î‘Î“Î—: Ensure last message is visible */
#messages-container::after {
    content: '';
    display: block;
    height: 10px;
    flex-shrink: 0;
}

.message {
    padding: 12px 16px;
    border-radius: var(--radius);
    max-width: 75%;
    animation: messageAppear 0.2s ease;
    word-wrap: break-word;
    overflow-wrap: break-word;
    word-break: break-word;
    flex-shrink: 0;
}

@keyframes messageAppear {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message.own {
    align-self: flex-end;
    background: var(--primary);
    color: white;
    border-bottom-right-radius: 8px;
}

.message.other {
    align-self: flex-start;
    background: rgba(38, 38, 38, 0.9);
    border: 1px solid var(--border-color);
    border-bottom-left-radius: 8px;
    padding: 12px 16px;
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.message-sender {
    font-weight: 600;
    font-size: 0.85rem;
}

.message.own .message-sender {
    color: rgba(255, 255, 255, 0.9);
}

.message.other .message-sender {
    color: var(--accent-red);
}

.message-time {
    font-size: 0.7rem;
    opacity: 0.8;
    margin-left: 8px;
}

.message-text {
    line-height: 1.4;
    font-size: 0.95rem;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    word-break: break-word;
}

/* Input Area - FIXED: Proper bottom positioning */
.message-input-container {
    padding: 15px 20px;
    background: rgba(38, 38, 38, 0.8);
    backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-color);
    position: relative;
    z-index: 10;
    flex-shrink: 0;
}

#chat-form {
    max-width: 800px;
    margin: 0 auto;
    display: flex;
    align-items: flex-end;
    gap: 8px;
}

.input-actions {
    display: flex;
    gap: 4px;
}

.input-action-btn {
    background: transparent;
    border: none;
    padding: 8px;
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--text-light);
}

.input-action-btn:hover {
    background: rgba(51, 51, 51, 0.5);
}

#message-input {
    flex: 1;
    padding: 12px 16px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    font-size: 0.95rem;
    transition: all 0.2s ease;
    background: rgba(26, 26, 26, 0.9);
    color: var(--text);
    resize: none;
    min-height: 44px;
    max-height: 120px;
    font-family: inherit;
    line-height: 1.4;
}

#message-input:focus {
    border-color: var(--accent-red);
    outline: none;
    box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.2);
    background: rgba(38, 38, 38, 0.9);
}

.send-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: var(--radius);
    cursor: pointer;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.2s ease;
}

.send-btn:hover {
    background: var(--accent-red);
}

/* Modals */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: rgba(38, 38, 38, 0.9);
    backdrop-filter: blur(20px);
    border-radius: var(--radius);
    padding: 25px;
    max-width: 400px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    border: 1px solid var(--border-color);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
}

.modal-header h3 {
    font-size: 1.3rem;
    color: var(--text);
}

.close-modal-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-light);
    transition: color 0.2s ease;
}

.close-modal-btn:hover {
    color: var(--accent-red);
}

.form-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.form-group label {
    font-weight: 600;
    color: var(--text);
    font-size: 0.9rem;
}

.form-group input,
.form-group textarea {
    padding: 12px 16px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    font-size: 0.95rem;
    transition: all 0.2s ease;
    font-family: inherit;
    background: rgba(26, 26, 26, 0.9);
    color: var(--text);
}

.form-group input:focus,
.form-group textarea:focus {
    border-color: var(--accent-red);
    outline: none;
    box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.2);
    background: rgba(38, 38, 38, 0.9);
}

.modal-buttons {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    flex: 1;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover {
    background: var(--accent-red);
    transform: translateY(-1px);
}

.btn-secondary {
    background: rgba(51, 51, 51, 0.8);
    color: var(--text);
    border: 1px solid var(--border-color);
}

.btn-secondary:hover {
    background: rgba(77, 77, 77, 0.8);
}

.btn-sm {
    padding: 8px 16px;
    font-size: 0.85rem;
}

.guest-section {
    text-align: center;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid var(--border-color);
}

.guest-section p {
    margin-bottom: 10px;
    color: var(--text-light);
    font-size: 0.9rem;
}

.btn-guest {
    background: transparent;
    border: 1px solid var(--primary);
    color: var(--primary);
}

.btn-guest:hover {
    background: var(--primary-light);
}

/* Friends Page Styles */
.friends-list-page {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 1rem;
}

.my-username-card {
    background: var(--card-bg);
    backdrop-filter: blur(10px);
    border-radius: var(--radius);
    padding: 1.5rem;
    margin-bottom: 1rem;
    border: 1px solid var(--border-color);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

.my-username-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.username-display {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.username-text {
    font-weight: 600;
    color: var(--accent-red);
    font-size: 1.1rem;
}

.username-hint {
    color: var(--text-muted);
    font-size: 0.9rem;
    margin: 0;
}

.friend-card {
    background: var(--card-bg);
    backdrop-filter: blur(10px);
    border-radius: var(--radius);
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid var(--border-color);
    transition: all 0.2s ease;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    position: relative;
}

.friend-card:hover {
    border-color: var(--accent-red);
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(139, 0, 0, 0.3);
    background: rgba(38, 38, 38, 0.9);
}

.friend-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.friend-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
    overflow: hidden;
    flex-shrink: 0;
}

.friend-details {
    display: flex;
    flex-direction: column;
}

.friend-name {
    font-weight: 600;
    color: var(--text-color);
}

.friend-since {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.friend-actions {
    display: flex;
    gap: 0.5rem;
}

.no-friends {
    text-align: center;
    padding: 3rem 2rem;
    color: var(--text-muted);
}

.no-friends p {
    margin: 0.5rem 0;
}

/* Button improvements */
.btn-danger {
    background: var(--accent-red);
    border: 1px solid var(--accent-red);
    color: white;
}

.btn-danger:hover {
    background: #CC0000;
}

/* Enhanced Friends System Styles */
.friends-section {
    margin-bottom: 2rem;
}

.friends-section h3 {
    color: var(--text-color);
    margin-bottom: 1rem;
    font-size: 1.1rem;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 0.5rem;
}

.pending-requests-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 2rem;
}

.friend-card.pending {
    background: rgba(139, 0, 0, 0.2);
    border: 1px solid var(--accent-red);
}

.btn-success {
    background: var(--success);
    border: 1px solid var(--success);
    color: white;
}

.btn-success:hover {
    background: #1E7A1E;
}

.friends-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

/* ========================================
   BEAUTIFUL NOTIFICATION SYSTEM
   ======================================== */

.notification-container {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 350px;
}

.notification {
    background: var(--card-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 15px 20px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    gap: 12px;
    transform: translateX(400px);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    max-width: 350px;
    position: relative;
}

.notification.active {
    transform: translateX(0);
    opacity: 1;
}

.notification.hiding {
    transform: translateX(400px);
    opacity: 0;
}

.notification.clickable {
    cursor: pointer;
    transition: all 0.3s ease;
}

.notification.clickable:hover {
    transform: translateX(-5px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.8);
    background: rgba(50, 50, 50, 0.95);
}

.notification-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-weight: bold;
    font-size: 0.9rem;
}

.notification-content {
    flex: 1;
}

.notification-title {
    font-weight: 600;
    font-size: 0.95rem;
    margin-bottom: 4px;
    color: var(--text);
}

.notification-message {
    font-size: 0.85rem;
    color: var(--text-light);
    line-height: 1.4;
}

.notification-close {
    background: none;
    border: none;
    color: var(--text-light);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.notification-close:hover {
    background: rgba(139, 0, 0, 0.3);
    color: var(--accent-red);
}

/* Notification Types */
.notification.success {
    border-left: 4px solid var(--success);
}

.notification.success .notification-icon {
    background: var(--success);
    color: white;
}

.notification.error {
    border-left: 4px solid var(--accent-red);
}

.notification.error .notification-icon {
    background: var(--accent-red);
    color: white;
}

.notification.warning {
    border-left: 4px solid var(--warning);
}

.notification.warning .notification-icon {
    background: var(--warning);
    color: white;
}

.notification.info {
    border-left: 4px solid var(--info);
}

.notification.info .notification-icon {
    background: var(--info);
    color: white;
}

/* Notification Count Badge */
.notification-count-badge {
    position: absolute;
    top: 10px;
    right: 35px;
    background: var(--primary);
    color: white;
    border-radius: 10px;
    min-width: 22px;
    height: 22px;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 6px;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
    animation: badgePop 0.3s ease-out;
}

/* Unread Notification Style */
.notification.unread {
    border-left: 6px solid var(--accent-red) !important;
    background: linear-gradient(90deg, rgba(139, 0, 0, 0.1) 0%, rgba(26, 26, 26, 0.9) 100%);
}

.notification.unread .notification-title {
    color: var(--accent-red);
    font-weight: bold;
}

.notification.unread .notification-title::after {
    content: " â—";
    color: var(--accent-red);
    animation: blink 1s infinite;
    font-size: 1.2em;
    vertical-align: middle;
    margin-left: 5px;
}

/* Offline Notification Style */
.notification.offline {
    border-left: 6px solid var(--warning);
    background: linear-gradient(90deg, rgba(255, 165, 0, 0.1) 0%, rgba(26, 26, 26, 0.9) 100%);
}

.notification.offline .notification-title {
    color: var(--warning);
}

/* ========================================
   UNREAD MESSAGES & BADGES SYSTEM
   ======================================== */

/* Badge Animations */
@keyframes badgePop {
    0% {
        transform: scale(0);
        opacity: 0;
    }
    70% {
        transform: scale(1.2);
        opacity: 1;
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

@keyframes badgePulse {
    0%,
    100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
}

@keyframes blink {
    0%,
    100% {
        opacity: 1;
    }
    50% {
        opacity: 0.3;
    }
}

@keyframes highlightPulse {
    0%,
    100% {
        box-shadow: 0 0 0 0 rgba(139, 0, 0, 0.7);
        transform: scale(1);
    }
    50% {
        box-shadow: 0 0 0 15px rgba(139, 0, 0, 0);
        transform: scale(1.02);
    }
}

/* Navigation Badges */
.nav-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--accent-red);
    color: white;
    border-radius: 10px;
    min-width: 20px;
    height: 20px;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 5px;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
    z-index: 100;
    animation: badgePop 0.3s ease-out;
}

/* Friend List Badges */
.friend-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--accent-red);
    color: white;
    border-radius: 10px;
    min-width: 20px;
    height: 20px;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 5px;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
    z-index: 1;
    animation: badgePop 0.3s ease-out;
}

/* Room List Badges */
.room-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--accent-red);
    color: white;
    border-radius: 10px;
    min-width: 20px;
    height: 20px;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 5px;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
    z-index: 1;
    animation: badgePop 0.3s ease-out;
}

/* Member Item Unread Indicator */
.member-item.unread {
    background: rgba(139, 0, 0, 0.15);
    border-left: 3px solid var(--accent-red);
}

.member-item.unread::after {
    content: "â—";
    color: var(--accent-red);
    font-size: 0.8rem;
    position: absolute;
    right: 15px;
    animation: blink 1s infinite;
}

/* Enhanced Hover Effects for Unread Items */
.friend-card.has-unread {
    border-left: 3px solid var(--accent-red);
    background: rgba(139, 0, 0, 0.1);
}

.room-card.has-unread {
    border-left: 3px solid var(--accent-red);
    background: rgba(139, 0, 0, 0.1);
}

.friend-card.has-unread:hover,
.room-card.has-unread:hover {
    background: rgba(139, 0, 0, 0.2);
    border-color: var(--accent-red);
}

/* Highlight Animation for Clicked Notifications */
.highlight-animation {
    animation: highlightPulse 2s ease-in-out;
    border: 2px solid var(--accent-red) !important;
}

/* ========================================
   PWA FLOATING INSTALL BUTTON
   ======================================== */

.pwa-floating-install-button {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 9999;
    background: linear-gradient(135deg, var(--primary) 0%, var(--accent-red) 100%);
    color: white;
    border: none;
    padding: 16px 24px;
    border-radius: 50px;
    cursor: pointer;
    font-weight: 700;
    font-size: 1rem;
    display: none;
    align-items: center;
    gap: 10px;
    box-shadow: 0 8px 25px rgba(139, 0, 0, 0.5), 0 4px 10px rgba(0, 0, 0, 0.3);
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    transform: scale(1);
    animation: floatPulse 3s ease-in-out infinite;
    border: 2px solid rgba(255, 255, 255, 0.1);
}

.pwa-floating-install-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.6s ease;
    border-radius: 50px;
}

.pwa-floating-install-button:hover::before {
    left: 100%;
}

.pwa-floating-install-button:hover {
    transform: scale(1.1) translateY(-3px);
    box-shadow: 0 12px 35px rgba(255, 0, 0, 0.6), 0 6px 15px rgba(0, 0, 0, 0.4);
    animation: none;
    background: linear-gradient(135deg, var(--accent-red) 0%, #CC0000 100%);
}

.pwa-floating-install-button:active {
    transform: scale(0.95);
}

.pwa-floating-install-button i {
    font-size: 1.3rem;
    animation: downloadBounce 2s ease-in-out infinite;
}

.pwa-floating-install-button:hover i {
    animation: none;
    transform: translateY(-2px);
}

.pwa-floating-install-button .install-text {
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    font-size: 0.9rem;
}

.pwa-floating-install-button.fade-in {
    display: flex !important;
    animation: fadeInSlideUp 0.5s ease-out forwards;
}

@keyframes floatPulse {
    0%,
    100% {
        transform: scale(1) translateY(0);
        box-shadow: 0 8px 25px rgba(139, 0, 0, 0.5), 0 4px 10px rgba(0, 0, 0, 0.3);
    }
    50% {
        transform: scale(1.05) translateY(-5px);
        box-shadow: 0 12px 35px rgba(139, 0, 0, 0.6), 0 6px 15px rgba(0, 0, 0, 0.4);
    }
}

@keyframes downloadBounce {
    0%,
    100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-5px);
    }
}

@keyframes fadeInSlideUp {
    from {
        opacity: 0;
        transform: translateY(50px) scale(0.8);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

body.pwa-mode .pwa-floating-install-button {
    display: none !important;
}

/* ========================================
   CONFIRMATION MODAL STYLING
   ======================================== */

#confirmation-modal .modal-content {
    max-width: 400px;
    text-align: center;
}

#confirmation-modal .form-group {
    padding: 20px 0;
    min-height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
}

#confirmation-modal #confirmation-message {
    font-size: 1rem;
    color: var(--text-color);
    line-height: 1.5;
    margin: 0;
}

#confirmation-modal .modal-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

#confirmation-modal .modal-buttons .btn {
    flex: 1;
    padding: 12px 24px;
    font-weight: 600;
}

#confirmation-modal .btn-primary {
    background: var(--accent-red);
    border-color: var(--accent-red);
}

#confirmation-modal .btn-primary:hover {
    background: #CC0000;
}

#confirmation-modal .btn-secondary:hover {
    background: rgba(77, 77, 77, 0.8);
}

/* Mobile responsive Î³Î¹Î± confirmation modal */
@media (max-width: 768px) {
    #confirmation-modal .modal-content {
        max-width: 90%;
        margin: 0 10px;
    }
    #confirmation-modal .modal-buttons {
        flex-direction: column;
    }
    #confirmation-modal .modal-buttons .btn {
        width: 100%;
    }
}

/* ========================================
   SCROLLBAR STYLING
   ======================================== */

::-webkit-scrollbar {
    width: 6px;
}

::-webkit-scrollbar-track {
    background: rgba(26, 26, 26, 0.5);
}

::-webkit-scrollbar-thumb {
    background: rgba(139, 0, 0, 0.6);
    border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 0, 0, 0.6);
}

/* ========================================
   PROFILE PAGE STYLES
   ======================================== */

.profile-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.profile-picture-section {
    text-align: center;
    margin-bottom: 30px;
}

.profile-picture-container {
    position: relative;
    display: inline-block;
    margin-bottom: 15px;
}

.profile-image-wrapper {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    overflow: hidden;
    position: relative;
    border: 4px solid var(--primary);
    background: var(--card-bg);
}

.profile-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.profile-image-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.profile-image-wrapper:hover .profile-image-overlay {
    opacity: 1;
}

#profile-username {
    font-size: 1.5rem;
    color: var(--text);
    margin-bottom: 5px;
}

.profile-email {
    color: var(--text-light);
    font-size: 0.9rem;
}

.profile-info-section {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.info-card,
.stats-card {
    background: var(--card-bg);
    backdrop-filter: blur(10px);
    border-radius: var(--radius);
    padding: 20px;
    border: 1px solid var(--border-color);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

.info-card h3,
.stats-card h3 {
    color: var(--text);
    margin-bottom: 15px;
    font-size: 1.1rem;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px;
}

.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid rgba(51, 51, 51, 0.3);
}

.info-item:last-child {
    border-bottom: none;
}

.info-item label {
    font-weight: 600;
    color: var(--text-light);
    font-size: 0.9rem;
}

.info-value {
    color: var(--text);
    font-weight: 500;
}

.status-online {
    color: var(--success);
}

.status-offline {
    color: var(--text-light);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
}

.stat-item {
    text-align: center;
    padding: 15px;
    background: rgba(26, 26, 26, 0.5);
    border-radius: var(--radius);
    border: 1px solid var(--border-color);
}

.stat-value {
    font-size: 1.8rem;
    font-weight: bold;
    color: var(--accent-red);
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.85rem;
    color: var(--text-light);
}

.profile-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.profile-actions .btn {
    flex: 1;
}

/* Profile Picture Upload */
.profile-picture-upload {
    margin-top: 10px;
}

.upload-preview {
    width: 150px;
    height: 150px;
    margin: 0 auto 15px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px dashed var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(26, 26, 26, 0.5);
}

.upload-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

#upload-placeholder {
    text-align: center;
    color: var(--text-light);
}

#upload-placeholder i {
    font-size: 3rem;
    margin-bottom: 10px;
    color: var(--accent-red);
}

.upload-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
}

/* User Info Modal Styles */
.user-info-container {
    text-align: center;
    padding: 20px 0;
}

.user-info-picture {
    width: 120px;
    height: 120px;
    margin: 0 auto 20px;
    border-radius: 50%;
    overflow: hidden;
    border: 4px solid var(--primary);
    background: var(--card-bg);
    position: relative;
}

.user-info-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.initials-avatar {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 2rem;
    color: white;
}

.user-info-details {
    margin-bottom: 20px;
    background: rgba(26, 26, 26, 0.5);
    border-radius: var(--radius);
    padding: 15px;
    border: 1px solid var(--border-color);
}

.user-info-details .info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(51, 51, 51, 0.3);
}

.user-info-details .info-item:last-child {
    border-bottom: none;
}

.user-info-details .info-item label {
    font-weight: 600;
    color: var(--text-light);
    font-size: 0.9rem;
    text-align: left;
}

.user-info-details .info-value {
    color: var(--text);
    font-weight: 500;
    text-align: right;
}

.status-online {
    color: var(--success);
}

.status-offline {
    color: var(--text-light);
}

.user-info-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 20px;
}

.user-info-actions .btn {
    flex: 1;
    min-width: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

/* Registration with Profile Picture */
.registration-avatar-section {
    margin: 15px 0;
    text-align: center;
}

.registration-avatar-preview {
    width: 100px;
    height: 100px;
    margin: 0 auto 10px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid var(--border-color);
    background: rgba(26, 26, 26, 0.5);
}

.registration-avatar-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.registration-avatar-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-light);
}

.registration-avatar-placeholder i {
    font-size: 2rem;
    margin-bottom: 5px;
}

.registration-avatar-buttons {
    display: flex;
    gap: 8px;
    justify-content: center;
}

/* ========================================
   USER INFO MODAL STYLING
   ======================================== */

/* Member item styling for clickable user info */
.member-item {
    transition: all 0.2s ease;
    cursor: pointer;
}

.member-item:hover {
    background: rgba(139, 0, 0, 0.15) !important;
    transform: translateX(5px);
}

.member-item:active {
    background: rgba(139, 0, 0, 0.25) !important;
}

/* User info modal specific styles */
#user-info-modal .modal-content {
    max-width: 420px;
    padding: 25px;
}

.user-info-container {
    text-align: center;
    padding: 10px 0;
}

.user-info-picture {
    width: 120px;
    height: 120px;
    margin: 0 auto 20px;
    border-radius: 50%;
    overflow: hidden;
    border: 4px solid var(--primary);
    background: var(--card-bg);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

.user-info-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.user-info-details {
    margin-bottom: 25px;
    background: rgba(26, 26, 26, 0.5);
    border-radius: var(--radius);
    padding: 15px;
    border: 1px solid var(--border-color);
}

.user-info-details .info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(51, 51, 51, 0.3);
}

.user-info-details .info-item:last-child {
    border-bottom: none;
}

.user-info-details .info-item label {
    font-weight: 600;
    color: var(--text-light);
    font-size: 0.9rem;
    text-align: left;
}

.user-info-details .info-value {
    color: var(--text);
    font-weight: 500;
    text-align: right;
}

.status-online {
    color: var(--success);
}

.status-offline {
    color: var(--text-light);
}

.user-info-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 20px;
}

.user-info-actions .btn {
    flex: 1;
    min-width: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

/* ========================================
   FIX: ÎšÎŸÎ™ÎÎŸ STYLING Î“Î™Î‘ ÎŸÎ›Î‘ Î¤Î‘ ÎœÎ—ÎÎ¥ÎœÎ‘Î¤Î‘
   ======================================== */

/* Î’Î•Î’Î‘Î™Î©Î£ÎŸÎ¥ ÏŒÏ„Î¹ Ï„Î± messages ÎµÎ¯Î½Î±Î¹ Î¯Î´Î¹Î± */
.message.other {
    display: block !important;
}

.message.other .message-header {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    margin-bottom: 8px !important;
    flex-direction: row !important;
}

.message.other .message-sender {
    display: inline !important;
    font-weight: 600 !important;
    font-size: 0.85rem !important;
    color: var(--accent-red) !important;
}

.message.other .message-text {
    margin-left: 0 !important;
    margin-top: 0 !important;
    line-height: 1.4 !important;
    font-size: 0.95rem !important;
}

/* Animations for user info modal */
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

#user-info-modal.active .modal-content {
    animation: slideInUp 0.3s ease-out;
}

/* ========================================
   PRIVATE CHAT - NO INVITE CODES
   ======================================== */

/* Hide entire invite code section for private chats */
#invite-code-container.hide-for-private {
    display: none !important;
}

/* Adjust layout when invite code section is hidden */
#sidebar:has(#invite-code-container.hide-for-private) .room-members-section {
    border-top: none;
    padding-top: 20px;
}

/* Hide copy button for private chats */
#copy-invite-btn.hidden-for-private {
    display: none !important;
}

/* Private chat indicator in sidebar */
#room-status.private-chat {
    color: var(--accent-red);
    font-weight: 600;
}

/* ========================================
   ğŸ”¥ ÎšÎ¡Î™Î¤Î™ÎšÎ•Î£ Î‘Î›Î›Î‘Î“Î•Î£ Î“Î™Î‘ MOBILE RESPONSIVE
   ======================================== */

@media (max-width: 768px) {
    /* ğŸ”¥ Î‘Î Î‘Î“ÎŸÎ¡Î•Î¥Î£Î— ZOOM OUT Î£Î¤Î‘ ÎšÎ™ÎÎ—Î¤Î‘ */
    body {
        touch-action: pan-y;
        -webkit-text-size-adjust: 100%;
        -moz-text-size-adjust: 100%;
        text-size-adjust: 100%;
        overflow-x: hidden;
    }
    
    /* ğŸ”¥ Î’Î•Î›Î¤Î™Î©ÎœÎ•ÎÎŸ NAVIGATION - Î£Î¤Î‘Î˜Î•Î¡ÎŸ Î£Î¤ÎŸ TOP */
    #main-nav {
        padding: 8px 12px;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        width: 100vw;
        z-index: 1000;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .nav-brand .nav-btn {
        width: 140px;
        min-width: 140px;
        max-width: 140px;
        height: 40px;
        flex-shrink: 0;
    }
    
    .nav-actions {
        gap: 5px;
        flex-wrap: nowrap;
        min-width: 0;
    }
    
    .nav-btn {
        padding: 8px 10px;
        font-size: 0.75rem;
        white-space: nowrap;
    }
    
    .nav-username {
        padding: 0 8px;
        font-size: 0.8rem;
        flex-shrink: 0;
    }
    
    /* ğŸ”¥ Î’Î•Î›Î¤Î™Î©ÎœÎ•ÎÎ— HOME PAGE */
    .hero-section {
        padding: 60px 20px 40px !important;
        min-height: auto;
        margin-top: 66px;
    }
    
    .hero-section h1 {
        font-size: 1.8rem !important;
        margin-bottom: 12px;
    }
    
    .hero-section p {
        font-size: 0.9rem;
        margin-bottom: 20px;
        padding: 0;
    }
    
    /* ğŸ”¥ Î“Î™Î‘ MOBILE: ÎšÎŸÎ¥ÎœÎ Î™Î‘ Î£Î• Î£Î¤Î—Î›Î— ÎœÎ• ÎœÎ•Î“Î‘Î›ÎŸ GAP */
    .hero-section #home-cta-logged-out,
    .hero-section #home-cta-logged-in {
        flex-direction: column; /* ğŸ”¥ Î£Îµ ÏƒÏ„Î®Î»Î· Î³Î¹Î± mobile */
        gap: 15px; /* ğŸ”¥ ÎœÎ•Î“Î‘Î›ÎŸ GAP 15px Î³Î¹Î± mobile */
        align-items: stretch; /* ğŸ”¥ Î¤ÎµÎ½Ï„ÏÏƒÏ„Îµ Ï„Î± Î³Î¹Î± Î½Î± Î³ÎµÎ¼Î¯ÏƒÎ¿Ï…Î½ */
    }
    
    .hero-section #home-cta-logged-out .cta-btn,
    .hero-section #home-cta-logged-out .cta-btn-secondary,
    .hero-section #home-cta-logged-in .cta-btn,
    .hero-section #home-cta-logged-in .cta-btn-secondary {
        width: 100%; /* ğŸ”¥ Î Î»Î®ÏÎµÏ‚ Ï€Î»Î¬Ï„Î¿Ï‚ ÏƒÎµ mobile */
        max-width: 280px; /* ğŸ”¥ Î‘Î»Î»Î¬ ÏŒÏ‡Î¹ Ï€Î¿Î»Ï Î¼ÎµÎ³Î¬Î»Î± */
        margin: 0 auto !important; /* ğŸ”¥ ÎšÎµÎ½Ï„ÏÎ¬ÏÎ¹ÏƒÎ¼Î± */
        padding: 12px 20px;
        font-size: 0.9rem;
        min-width: auto; /* ğŸ”¥ Î‘Ï†Î±Î¯ÏÎµÏƒÎ· min-width Î³Î¹Î± mobile */
    }
    
    /* ğŸ”¥ Î’Î•Î›Î¤Î™Î©ÎœÎ•ÎÎ‘ FEATURE CARDS */
    .features-grid {
        grid-template-columns: 1fr !important;
        gap: 15px;
        padding: 30px 20px !important;
        margin-bottom: 0;
    }
    
    .feature-card {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 !important;
        padding: 20px !important;
        min-height: auto;
    }
    
    .feature-icon i {
        font-size: 2rem !important;
    }
    
    .feature-card h3 {
        font-size: 1.1rem !important;
        margin-bottom: 8px;
    }
    
    .feature-card p {
        font-size: 0.85rem !important;
        line-height: 1.4;
        margin: 0;
    }
    
    /* ğŸ”¥ Î£Î—ÎœÎ‘ÎÎ¤Î™ÎšÎŸ: CHAT LAYOUT - Î£Î©Î£Î¤Î— Î”Î™Î‘Î¤Î‘ÎÎ— ÎœÎ• SIDEBAR Î‘Î¡Î™Î£Î¤Î•Î¡Î‘ */
    .chat-layout {
        flex-direction: row;
        height: calc(100vh - 66px);
        margin-top: 66px;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        overflow: hidden;
    }
    
    #sidebar {
        width: 70px;
        min-width: 70px;
        max-width: 70px;
        height: 100%;
        overflow-y: auto;
        border-right: 1px solid var(--border-color);
        transition: all 0.3s ease;
        z-index: 2;
    }
    
    /* Hide text in sidebar for mobile */
    .sidebar-header h2,
    .room-info span,
    .invite-code-section label,
    .room-members-section h3,
    .member-info,
    .profile-info,
    .invite-code-display span {
        display: none;
    }
    
    .sidebar-header,
    .room-details,
    .room-members-section,
    .user-profile {
        padding: 10px;
    }
    
    .invite-code-display {
        justify-content: center;
        padding: 8px;
    }
    
    .member-item {
        justify-content: center;
        padding: 8px;
    }
    
    .member-avatar {
        width: 36px;
        height: 36px;
        font-size: 0.65rem;
    }
    
    /* Expanded sidebar state */
    #sidebar.mobile-expanded {
        width: 280px;
        max-width: 280px;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.7);
    }
    
    #sidebar.mobile-expanded .member-info,
    #sidebar.mobile-expanded .profile-info,
    #sidebar.mobile-expanded .sidebar-header h2,
    #sidebar.mobile-expanded .room-info span,
    #sidebar.mobile-expanded .invite-code-section label,
    #sidebar.mobile-expanded .invite-code-display span,
    #sidebar.mobile-expanded .room-members-section h3 {
        display: block;
    }
    
    #sidebar.mobile-expanded .member-info,
    #sidebar.mobile-expanded .profile-info {
        display: flex;
    }
    
    /* ğŸ”¥ ÎÎ•ÎŸ: Overlay only for chat page - Î£Î©Î£Î¤Î— Î•ÎšÎ”ÎŸÎ£Î— */
    body:has(#chat-page.active) .sidebar-overlay {
        display: block !important;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
    }
    
    body:has(#chat-page.active) #sidebar.mobile-expanded + .sidebar-overlay {
        opacity: 1;
        pointer-events: auto;
    }
    
    /* Hide overlay on other pages */
    body:not(:has(#chat-page.active)) .sidebar-overlay {
        display: none !important;
    }
    
    /* ğŸ”¥ ÎœÎ•Î“Î‘Î›Î— Î’Î•Î›Î¤Î™Î©Î£Î—: MESSAGES CONTAINER - Î£Î©Î£Î¤ÎŸ Î£ÎšÎ¡ÎŸÎ› ÎšÎ‘Î™ Î¤Î•Î›Î•Î¥Î¤Î‘Î™ÎŸ ÎœÎ—ÎÎ¥ÎœÎ‘ */
    #main-chat {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100%;
        position: relative;
        min-width: 0;
    }
    
    #messages-container {
        flex: 1;
        padding: 15px 12px;
        height: 100% !important;
        min-height: 0;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    /* ğŸ”¥ ÎšÎ¡Î™Î¤Î™ÎšÎ— Î‘Î›Î›Î‘Î“Î—: Ensure last message is always visible */
    #messages-container::after {
        content: '';
        display: block;
        height: 20px;
        flex-shrink: 0;
    }
    
    .message {
        max-width: 85%;
        padding: 10px 12px;
        flex-shrink: 0;
    }
    
    .message-header {
        margin-bottom: 4px;
    }
    
    .message-sender {
        font-size: 0.8rem;
    }
    
    .message-time {
        font-size: 0.65rem;
    }
    
    .message-text {
        font-size: 0.9rem;
        line-height: 1.4;
    }
    
    /* ğŸ”¥ Î£Î—ÎœÎ‘ÎÎ¤Î™ÎšÎŸ: INPUT AREA - Î£Î¤Î‘Î˜Î•Î¡ÎŸ Î£Î¤ÎŸ BOTTOM, Î§Î©Î¡Î™Î£ ÎšÎ•ÎÎŸ ÎšÎ‘Î¤Î© */
    .message-input-container {
        position: relative;
        padding: 10px 12px;
        background: rgba(38, 38, 38, 0.95);
        border-top: 1px solid var(--border-color);
        flex-shrink: 0;
        height: 140px;
    }
    
    #chat-form {
        gap: 6px;
        height: 100%;
        align-items: stretch;
    }
    
    .input-actions {
        flex-direction: column;
        gap: 4px;
        justify-content: flex-start;
    }
    
    .input-action-btn {
        padding: 6px;
        font-size: 0.9rem;
    }
    
    #message-input {
        min-height: 50px;
        max-height: 80px;
        flex: 1;
        font-size: 0.9rem;
        padding: 10px 14px;
    }
    
    .send-btn {
        padding: 10px 16px;
        font-size: 0.85rem;
        height: 44px;
        align-self: flex-end;
    }
    
    /* ğŸ”¥ Rooms page */
    .rooms-container {
        padding: 20px 15px;
        margin-top: 66px;
    }
    
    .rooms-header {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
        margin-bottom: 20px;
    }
    
    .rooms-actions {
        justify-content: space-between;
        gap: 8px;
    }
    
    .rooms-list {
        grid-template-columns: 1fr !important;
        gap: 15px;
        padding-bottom: 20px;
    }
    
    /* ğŸ”¥ Friends page */
    .friends-list-page {
        margin-top: 66px;
        padding: 20px 15px;
    }
    
    .friend-card {
        padding: 12px;
        flex-direction: column;
        gap: 12px;
    }
    
    .friend-info {
        width: 100%;
        justify-content: flex-start;
    }
    
    .friend-actions {
        width: 100%;
        justify-content: space-between;
        gap: 8px;
    }
    
    .btn-sm {
        padding: 6px 12px;
        font-size: 0.75rem;
        flex: 1;
    }
    
    /* ğŸ”¥ Profile page */
    .profile-container {
        padding: 20px 15px;
        margin-top: 66px;
    }
    
    .profile-image-wrapper {
        width: 100px;
        height: 100px;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .stat-item {
        padding: 10px;
    }
    
    .stat-value {
        font-size: 1.3rem;
    }
    
    .profile-actions {
        flex-direction: column;
        gap: 8px;
    }
    
    .upload-preview {
        width: 100px;
        height: 100px;
    }
    
    .user-info-picture {
        width: 80px;
        height: 80px;
    }
    
    /* ğŸ”¥ Notifications */
    .notification-container {
        top: 70px;
        right: 8px;
        left: 8px;
        max-width: calc(100% - 16px);
    }
    
    .notification {
        max-width: 100%;
        padding: 10px 14px;
    }
    
    .notification-count-badge {
        top: 6px;
        right: 25px;
        min-width: 18px;
        height: 18px;
        font-size: 0.6rem;
    }
    
    /* Badges */
    .nav-badge {
        min-width: 16px;
        height: 16px;
        font-size: 0.5rem;
        top: -3px;
        right: -3px;
    }
    
    .friend-badge,
    .room-badge {
        top: 5px;
        right: 5px;
        min-width: 18px;
        height: 18px;
        font-size: 0.6rem;
    }
    
    /* PWA Button */
    .pwa-floating-install-button {
        bottom: 15px;
        right: 15px;
        padding: 10px 14px;
        font-size: 0.8rem;
        border-radius: 40px;
    }
    
    .pwa-floating-install-button .install-text {
        font-size: 0.75rem;
    }
    
    .pwa-floating-install-button i {
        font-size: 1rem;
    }
    
    /* Private chat mobile */
    #invite-code-container.hide-for-private {
        display: none !important;
    }
    
    /* ğŸ”¥ Î”Î™ÎŸÎ¡Î˜Î©Î£Î—: ÎšÎ¿Ï…Î¼Ï€Î¹Î¬ ÎºÎ¿Î»Î»Î·Ï„Î¬ ÏƒÏ„Î¿ mobile Î³Î¹Î± logged in users */
    .hero-section #home-cta-logged-out .cta-btn,
    .hero-section #home-cta-logged-out .cta-btn-secondary,
    .hero-section #home-cta-logged-in .cta-btn,
    .hero-section #home-cta-logged-in .cta-btn-secondary {
        margin-bottom: 20px !important;
    }
    
    .hero-section #home-cta-logged-out .cta-btn:last-child,
    .hero-section #home-cta-logged-out .cta-btn-secondary:last-child,
    .hero-section #home-cta-logged-in .cta-btn:last-child,
    .hero-section #home-cta-logged-in .cta-btn-secondary:last-child {
        margin-bottom: 0 !important;
    }
    
    /* Ensure pages don't have extra padding */
    .page.active {
        padding-bottom: 0;
    }
}

/* Extra small devices */
@media (max-width: 480px) {
    /* ğŸ”¥ Î’Î•Î›Î¤Î™Î©ÎœÎ•ÎÎŸ NAV - ÎšÎ‘Î›Î¥Î¤Î•Î¡Î— Î•ÎœÎ¦Î‘ÎÎ™Î£Î— Î£Î• Î ÎŸÎ›Î¥ ÎœÎ™ÎšÎ¡Î•Î£ ÎŸÎ˜ÎŸÎÎ•Î£ */
    .nav-brand .nav-btn {
        width: 120px;
        min-width: 120px;
        max-width: 120px;
        height: 35px;
    }
    
    .nav-actions {
        gap: 3px;
    }
    
    .nav-btn {
        padding: 6px 8px;
        font-size: 0.7rem;
    }
    
    .nav-btn i {
        margin-right: 3px;
        font-size: 0.7em;
    }
    
    .nav-username {
        font-size: 0.75rem;
        padding: 0 6px;
    }
    
    /* ğŸ”¥ Hero Section Î³Î¹Î± Ï€Î¿Î»Ï Î¼Î¹ÎºÏÎ­Ï‚ Î¿Î¸ÏŒÎ½ÎµÏ‚ */
    .hero-section {
        padding: 50px 15px 30px !important;
    }
    
    .hero-section h1 {
        font-size: 1.5rem !important;
    }
    
    .hero-section p {
        font-size: 0.85rem;
    }
    
    /* ğŸ”¥ ÎšÎŸÎ¥ÎœÎ Î™Î‘ Î“Î™Î‘ Î ÎŸÎ›Î¥ ÎœÎ™ÎšÎ¡Î•Î£ ÎŸÎ˜ÎŸÎÎ•Î£ */
    .hero-section #home-cta-logged-out .cta-btn,
    .hero-section #home-cta-logged-out .cta-btn-secondary,
    .hero-section #home-cta-logged-in .cta-btn,
    .hero-section #home-cta-logged-in .cta-btn-secondary {
        padding: 10px 16px;
        font-size: 0.85rem;
        max-width: 220px;
    }
    
    /* ğŸ”¥ BETTER FEATURE CARDS FOR VERY SMALL SCREENS */
    .features-grid {
        padding: 25px 15px !important;
        gap: 12px;
    }
    
    .feature-card {
        padding: 18px 15px !important;
    }
    
    .feature-icon i {
        font-size: 1.8rem !important;
    }
    
    .feature-card h3 {
        font-size: 1rem !important;
    }
    
    .feature-card p {
        font-size: 0.8rem !important;
        line-height: 1.3;
    }
    
    /* ğŸ”¥ Chat improvements for very small screens */
    #sidebar {
        width: 60px;
        min-width: 60px;
        max-width: 60px;
    }
    
    .member-item {
        padding: 6px;
    }
    
    .member-avatar {
        width: 28px;
        height: 28px;
        font-size: 0.6rem;
    }
    
    #sidebar.mobile-expanded {
        width: 240px;
        max-width: 240px;
    }
    
    .message {
        max-width: 90%;
        padding: 8px 10px;
    }
    
    .message-text {
        font-size: 0.85rem;
    }
    
    /* ğŸ”¥ Rooms page */
    .rooms-list {
        grid-template-columns: 1fr !important;
    }
    
    .room-card {
        padding: 15px;
    }
    
    /* ğŸ”¥ Profile page */
    .profile-image-wrapper {
        width: 80px;
        height: 80px;
    }
    
    .stats-grid {
        grid-template-columns: 1fr !important;
        gap: 8px;
    }
    
    .stat-item {
        padding: 10px;
    }
    
    .stat-value {
        font-size: 1.3rem;
    }
    
    .upload-preview {
        width: 80px;
        height: 80px;
    }
    
    .user-info-picture {
        width: 60px;
        height: 60px;
    }
    
    .user-info-actions {
        flex-direction: column;
    }
    
    .user-info-actions .btn {
        width: 100%;
    }
    
    /* ğŸ”¥ PWA Button mobile */
    .pwa-floating-install-button {
        bottom: 12px;
        right: 12px;
        padding: 8px 10px;
        font-size: 0.75rem;
    }
    
    .pwa-floating-install-button .install-text {
        display: none;
    }
    
    .pwa-floating-install-button i {
        font-size: 1.1rem;
        margin: 0;
    }
    
    .pwa-floating-install-button {
        width: 48px;
        height: 48px;
        padding: 0;
        border-radius: 50%;
        justify-content: center;
        align-items: center;
    }
    
    /* Notification count badge hide on very small screens */
    .notification-count-badge {
        display: none;
    }
    
    /* Smaller badges */
    .friend-badge,
    .room-badge {
        min-width: 14px;
        height: 14px;
        font-size: 0.5rem;
        top: 3px;
        right: 3px;
    }
}

/* Extra small devices */
@media (max-width: 360px) {
    .pwa-floating-install-button {
        bottom: 10px;
        right: 10px;
        width: 44px;
        height: 44px;
    }
    
    .pwa-floating-install-button i {
        font-size: 1rem;
    }
    
    .notification-container {
        right: 5px;
        left: 5px;
        max-width: calc(100% - 10px);
    }
    
    .notification {
        max-width: 100%;
        padding: 8px 12px;
    }
    
    /* ğŸ”¥ NAVIGATION ÎœÎ™ÎšÎ¡ÎŸÎ¤Î•Î¡ÎŸ Î“Î™Î‘ Î ÎŸÎ›Î¥ ÎœÎ™ÎšÎ¡Î•Î£ ÎŸÎ˜ÎŸÎÎ•Î£ */
    .nav-brand .nav-btn {
        width: 100px;
        min-width: 100px;
        max-width: 100px;
        height: 30px;
    }
    
    .nav-btn {
        padding: 5px 6px;
        font-size: 0.65rem;
    }
    
    .nav-username {
        font-size: 0.7rem;
        padding: 0 4px;
    }
    
    /* ğŸ”¥ Even smaller sidebar for very small screens */
    #sidebar {
        width: 50px;
        min-width: 50px;
        max-width: 50px;
    }
    
    #sidebar.mobile-expanded {
        width: 200px;
        max-width: 200px;
    }
}

/* Tablet responsive (landscape) */
@media (max-width: 1024px) and (orientation: landscape) {
    .pwa-floating-install-button {
        bottom: 20px;
        right: 20px;
        padding: 12px 16px;
        font-size: 0.85rem;
    }
    
    .pwa-floating-install-button i {
        font-size: 1rem;
    }
    
    /* ğŸ”¥ FIX: Feature cards Î³Î¹Î± tablets - 2 columns */
    .features-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 15px;
        padding: 40px 20px !important;
    }
    
    /* Î‘Î½ Î¿ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Ï„Ï‰Î½ feature cards ÎµÎ¯Î½Î±Î¹ Ï€ÎµÏÎ¹Ï„Ï„ÏŒÏ‚, Ï„Î¿ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿ Î½Î± ÎµÎ¯Î½Î±Î¹ full-width */
    .features-grid .feature-card:nth-child(3):last-child {
        grid-column: 1 / -1;
        max-width: 400px;
        margin: 0 auto;
    }
    
    /* Better chat layout for landscape - wider sidebar */
    #sidebar {
        width: 80px;
    }
    
    #sidebar.mobile-expanded {
        width: 300px;
    }
}

/* Special case: Avoid overlap with notification container */
.notification-container~.pwa-floating-install-button {
    bottom: 25px;
}

/* Ensure buttons with badges have proper spacing */
.nav-btn.has-badge {
    padding-right: 30px;
}

/* Loading states */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

/* Empty states styling */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: var(--accent-red);
    opacity: 0.5;
}

.empty-state h3 {
    margin-bottom: 0.5rem;
    color: var(--text);
}

.empty-state p {
    margin-bottom: 1.5rem;
}

/* Error states */
.error-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--accent-red);
}

.error-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.error-state h3 {
    margin-bottom: 0.5rem;
}

/* Success states */
.success-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--success);
}

.success-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.success-state h3 {
    margin-bottom: 0.5rem;
}

/* Connection status indicator */
.connection-status {
    position: fixed;
    bottom: 10px;
    left: 10px;
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 5px;
    background: rgba(26, 26, 26, 0.9);
    padding: 5px 10px;
    border-radius: var(--radius);
    font-size: 0.8rem;
    color: var(--text-light);
}

.connection-status.connected {
    color: var(--success);
}

.connection-status.disconnected {
    color: var(--accent-red);
}

.connection-status.connecting {
    color: var(--warning);
}

.connection-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.connection-dot.connected {
    background: var(--success);
    animation: pulse 2s infinite;
}

.connection-dot.disconnected {
    background: var(--accent-red);
}

.connection-dot.connecting {
    background: var(--warning);
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0%,
    100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}

/* Better message text wrapping */
.message-text {
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    word-break: break-word;
    line-height: 1.5;
}

/* ğŸ”¥ Î£Î—ÎœÎ‘ÎÎ¤Î™ÎšÎ— Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—: Ensure chat page has no bottom gap */
#chat-page.active {
    height: calc(100vh - 66px);
    overflow: hidden;
}

/* ğŸ”¥ Î’Î•Î›Î¤Î™Î©Î£Î—: Auto-scroll to bottom when new message is added */
#messages-container {
    scroll-behavior: smooth;
}

/* ğŸ”¥ FIX: Force messages container to show last message */
.message:last-of-type {
    margin-bottom: 10px;
}

/* ğŸ”¥ Î’Î•Î›Î¤Î™Î©Î£Î—: Better viewport handling for iOS */
@supports (-webkit-touch-callout: none) {
    body {
        min-height: -webkit-fill-available;
    }
    
    #chat-page.active {
        height: -webkit-fill-available;
    }
    
    #messages-container {
        height: -webkit-fill-available;
    }
}

/* ========================================
   FILE UPLOAD & EMOJI PICKER SYSTEM
   ======================================== */

/* File Upload Container */
.file-upload-container {
    position: relative;
    margin: 10px 0;
}

#file-upload-input {
    display: none;
}

.file-upload-btn {
    background: transparent;
    border: none;
    color: var(--text-light);
    padding: 10px;
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.file-upload-btn:hover {
    background: rgba(139, 0, 0, 0.2);
    color: var(--accent-red);
}

.file-upload-btn i {
    font-size: 1.2rem;
}

/* File Preview */
#file-preview {
    display: none;
    background: rgba(38, 38, 38, 0.9);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 15px;
    margin: 10px 0;
    flex-direction: column;
    gap: 10px;
    animation: slideInUp 0.3s ease-out;
}

.file-preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.file-preview-title {
    font-weight: 600;
    color: var(--text);
    font-size: 0.9rem;
}

.file-preview-content {
    display: flex;
    align-items: center;
    gap: 15px;
}

#preview-image {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: var(--radius);
    display: none;
}

.file-info {
    flex: 1;
}

.file-info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

#file-name {
    font-weight: 600;
    color: var(--text);
    font-size: 0.9rem;
}

#file-size {
    font-size: 0.8rem;
    color: var(--text-light);
}

/* Upload Progress */
.upload-progress-container {
    margin-top: 10px;
    background: rgba(26, 26, 26, 0.5);
    border-radius: var(--radius);
    overflow: hidden;
    height: 6px;
}

#upload-progress {
    height: 100%;
    background: var(--accent-red);
    width: 0%;
    transition: width 0.3s ease;
    position: relative;
}

#upload-progress::after {
    content: attr(data-progress);
    position: absolute;
    right: 5px;
    top: -20px;
    font-size: 0.7rem;
    color: var(--text-light);
}

#upload-status {
    font-size: 0.8rem;
    color: var(--text-light);
    margin-top: 5px;
    text-align: center;
}

/* File Upload Actions */
.file-upload-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

#send-file-btn {
    flex: 1;
    background: var(--primary);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: var(--radius);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-weight: 600;
    transition: all 0.2s ease;
}

#send-file-btn:hover:not(:disabled) {
    background: var(--accent-red);
}

#send-file-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

#cancel-upload-btn {
    background: rgba(51, 51, 51, 0.8);
    color: var(--text);
    border: 1px solid var(--border-color);
    padding: 8px 16px;
    border-radius: var(--radius);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s ease;
}

#cancel-upload-btn:hover {
    background: rgba(77, 77, 77, 0.8);
}

/* Emoji Picker Modal */
#emoji-picker-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px);
}

#emoji-picker-modal.active {
    display: flex;
    animation: fadeIn 0.3s ease-out;
}

.emoji-picker-content {
    background: var(--card-bg);
    border-radius: var(--radius);
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow: hidden;
    border: 1px solid var(--border-color);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    display: flex;
    flex-direction: column;
}

.emoji-picker-header {
    padding: 15px 20px;
    background: rgba(38, 38, 38, 0.9);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.emoji-picker-header h3 {
    color: var(--text);
    font-size: 1.1rem;
    margin: 0;
}

#close-emoji-picker {
    background: none;
    border: none;
    color: var(--text-light);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
}

#close-emoji-picker:hover {
    background: rgba(139, 0, 0, 0.3);
    color: var(--accent-red);
}

.emoji-categories {
    display: flex;
    gap: 2px;
    padding: 10px;
    background: rgba(38, 38, 38, 0.9);
    border-bottom: 1px solid var(--border-color);
    overflow-x: auto;
}

.emoji-category-btn {
    background: transparent;
    border: none;
    padding: 8px 12px;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 1.2rem;
    transition: all 0.2s ease;
    flex-shrink: 0;
    min-width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.emoji-category-btn.active {
    background: var(--primary);
    color: white;
    transform: scale(1.1);
}

.emoji-category-btn:hover:not(.active) {
    background: rgba(139, 0, 0, 0.2);
    transform: scale(1.05);
}

.emoji-grid-container {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
}

.emoji-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
    gap: 10px;
}

.emoji-item {
    background: transparent;
    border: none;
    padding: 10px;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 1.5rem;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 50px;
}

.emoji-item:hover {
    background: rgba(139, 0, 0, 0.2);
    transform: scale(1.2);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.emoji-item:active {
    transform: scale(1.1);
}

/* Message with files */
.message-file {
    margin-top: 8px;
    background: rgba(38, 38, 38, 0.7);
    border-radius: var(--radius);
    padding: 10px;
    border: 1px solid var(--border-color);
}

.file-preview-in-message {
    display: flex;
    align-items: center;
    gap: 12px;
}

.file-image-preview {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.2s ease;
}

.file-image-preview:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
}

.file-info-message {
    flex: 1;
}

.file-name-message {
    display: block;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 5px;
    word-break: break-all;
}

.file-download-btn {
    background: var(--primary);
    color: white;
    padding: 6px 12px;
    border-radius: var(--radius);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.85rem;
    transition: all 0.2s ease;
}

.file-download-btn:hover {
    background: var(--accent-red);
    transform: translateY(-2px);
}

/* File icon for non-image files */
.file-icon-large {
    width: 80px;
    height: 80px;
    background: rgba(139, 0, 0, 0.2);
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    color: var(--accent-red);
}

.file-item-message {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px;
    background: rgba(38, 38, 38, 0.7);
    border-radius: var(--radius);
    border: 1px solid var(--border-color);
}

.file-icon-message i {
    font-size: 1.8rem;
    color: var(--accent-red);
}

.file-details-message {
    flex: 1;
}

.file-download-link {
    color: var(--accent-red);
    text-decoration: none;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    transition: all 0.2s ease;
}

.file-download-link:hover {
    text-decoration: underline;
    color: var(--accent-pink);
}

/* Image Preview Modal */
.image-preview-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 20000;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
}

.image-preview-modal.active {
    display: flex;
    animation: fadeIn 0.3s ease-out;
}

.image-preview-content {
    position: relative;
    max-width: 90%;
    max-height: 90vh;
    background: var(--card-bg);
    border-radius: var(--radius);
    overflow: hidden;
    border: 1px solid var(--border-color);
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7);
}

.close-image-preview {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(0, 0, 0, 0.7);
    border: none;
    color: white;
    font-size: 1.8rem;
    cursor: pointer;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    transition: all 0.2s ease;
}

.close-image-preview:hover {
    background: var(--accent-red);
    transform: rotate(90deg);
}

.full-size-image {
    max-width: 100%;
    max-height: 80vh;
    display: block;
    margin: 0 auto;
}

.image-actions {
    padding: 15px;
    background: rgba(38, 38, 38, 0.9);
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 10px;
    justify-content: center;
}

.image-actions .btn {
    min-width: 120px;
}

/* Chat Input Area with new buttons */
.message-input-container {
    padding: 10px 15px;
    background: rgba(38, 38, 38, 0.95);
    border-top: 1px solid var(--border-color);
    position: relative;
    z-index: 10;
}

#chat-form {
    max-width: 100%;
    margin: 0 auto;
    display: flex;
    align-items: flex-end;
    gap: 10px;
}

.input-actions {
    display: flex;
    gap: 5px;
    align-items: center;
}

.emoji-picker-btn,
.file-upload-btn {
    background: transparent;
    border: none;
    padding: 10px;
    border-radius: var(--radius);
    cursor: pointer;
    color: var(--text-light);
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 44px;
    min-height: 44px;
}

.emoji-picker-btn:hover,
.file-upload-btn:hover {
    background: rgba(139, 0, 0, 0.2);
    color: var(--accent-red);
    transform: scale(1.1);
}

.emoji-picker-btn i,
.file-upload-btn i {
    font-size: 1.3rem;
}

#message-input {
    flex: 1;
    padding: 12px 16px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    font-size: 0.95rem;
    transition: all 0.2s ease;
    background: rgba(26, 26, 26, 0.9);
    color: var(--text);
    resize: none;
    min-height: 44px;
    max-height: 120px;
    font-family: inherit;
    line-height: 1.4;
}

#message-input:focus {
    border-color: var(--accent-red);
    outline: none;
    box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.2);
    background: rgba(38, 38, 38, 0.9);
}

.send-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: var(--radius);
    cursor: pointer;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    min-width: 100px;
    min-height: 44px;
}

.send-btn:hover:not(:disabled) {
    background: var(--accent-red);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 0, 0, 0.3);
}

.send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* ========================================
   SOCIAL MEDIA FOOTER
   ======================================== */

.social-media-section {
    margin-top: 60px;
    padding: 40px 20px;
    background: rgba(26, 26, 26, 0.8);
    border-top: 1px solid var(--border-color);
    text-align: center;
}

.social-media-section h2 {
    color: var(--text);
    margin-bottom: 30px;
    font-size: 1.8rem;
}

.social-media-section p {
    color: var(--text-light);
    margin-bottom: 30px;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
    line-height: 1.6;
}

.social-icons-grid {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
    max-width: 800px;
    margin: 0 auto;
}

.social-icon-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.8rem;
    text-decoration: none;
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    position: relative;
    overflow: hidden;
}

.social-icon-circle::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.6s ease;
}

.social-icon-circle:hover::before {
    left: 100%;
}

.social-icon-circle:hover {
    transform: translateY(-10px) scale(1.1);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
}

.social-icon-circle.instagram {
    background: linear-gradient(45deg, #405DE6, #5851DB, #833AB4, #C13584, #E1306C, #FD1D1D);
}

.social-icon-circle.facebook {
    background: #1877F2;
}

.social-icon-circle.twitter {
    background: #1DA1F2;
}

.social-icon-circle.youtube {
    background: #FF0000;
}

.social-icon-circle.tiktok {
    background: #000000;
}

.social-icon-circle.discord {
    background: #5865F2;
}

.social-icon-circle.github {
    background: #333333;
}

.social-icon-circle.linkedin {
    background: #0077B5;
}

.social-icon-circle.reddit {
    background: #FF4500;
}

.social-icon-circle.whatsapp {
    background: #25D366;
}

.social-icon-circle.telegram {
    background: #0088CC;
}

.social-icon-circle i {
    position: relative;
    z-index: 1;
}

.social-icon-label {
    position: absolute;
    bottom: -25px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.7rem;
    color: var(--text-light);
    white-space: nowrap;
    opacity: 0;
    transition: all 0.3s ease;
}

.social-icon-circle:hover .social-icon-label {
    opacity: 1;
    bottom: -20px;
}

/* Follow Us Text */
.follow-us {
    margin-top: 40px;
    color: var(--text-light);
    font-size: 0.9rem;
}

.follow-us a {
    color: var(--accent-red);
    text-decoration: none;
    font-weight: 600;
}

.follow-us a:hover {
    text-decoration: underline;
}

/* ========================================
   ANIMATIONS
   ======================================== */

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideInDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
}

/* ========================================
   RESPONSIVE DESIGN FOR NEW FEATURES
   ======================================== */

@media (max-width: 768px) {
    /* File Upload */
    .file-preview-content {
        flex-direction: column;
        align-items: flex-start;
    }
    
    #preview-image {
        width: 100%;
        height: 150px;
    }
    
    .file-upload-actions {
        flex-direction: column;
    }
    
    /* Emoji Picker */
    .emoji-picker-content {
        width: 95%;
        height: 70vh;
        position: fixed;
        bottom: 0;
        border-radius: var(--radius) var(--radius) 0 0;
        animation: slideInUp 0.3s ease-out;
    }
    
    .emoji-grid {
        grid-template-columns: repeat(6, 1fr);
        gap: 8px;
    }
    
    .emoji-item {
        min-height: 45px;
        font-size: 1.3rem;
    }
    
    .emoji-categories {
        justify-content: flex-start;
        padding: 8px;
    }
    
    .emoji-category-btn {
        padding: 6px 10px;
        font-size: 1.1rem;
        min-width: 35px;
        height: 35px;
    }
    
    /* Chat Input */
    #chat-form {
        flex-wrap: wrap;
    }
    
    .input-actions {
        order: 1;
        width: 100%;
        justify-content: center;
        margin-bottom: 10px;
    }
    
    #message-input {
        order: 2;
        min-height: 50px;
    }
    
    .send-btn {
        order: 3;
        min-width: 80px;
        padding: 10px 15px;
        margin-top: 10px;
    }
    
    /* Social Media */
    .social-icons-grid {
        gap: 15px;
    }
    
    .social-icon-circle {
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
    }
    
    .social-icon-label {
        font-size: 0.6rem;
        bottom: -22px;
    }
    
    .social-icon-circle:hover .social-icon-label {
        bottom: -18px;
    }
}

@media (max-width: 480px) {
    /* File Upload */
    #file-preview {
        padding: 10px;
    }
    
    .file-preview-content {
        gap: 10px;
    }
    
    /* Emoji Picker */
    .emoji-grid {
        grid-template-columns: repeat(5, 1fr);
        gap: 6px;
    }
    
    .emoji-item {
        min-height: 40px;
        font-size: 1.2rem;
        padding: 8px;
    }
    
    /* Social Media */
    .social-icons-grid {
        gap: 10px;
    }
    
    .social-icon-circle {
        width: 45px;
        height: 45px;
        font-size: 1.3rem;
    }
    
    .social-media-section h2 {
        font-size: 1.5rem;
    }
    
    .social-media-section p {
        font-size: 0.9rem;
        padding: 0 10px;
    }
}

/* Tablet Landscape */
@media (min-width: 769px) and (max-width: 1024px) {
    .emoji-grid {
        grid-template-columns: repeat(7, 1fr);
    }
    
    .social-icons-grid {
        gap: 25px;
    }
    
    .social-icon-circle {
        width: 55px;
        height: 55px;
    }
}

/* Desktop Large Screens */
@media (min-width: 1200px) {
    .emoji-picker-content {
        max-width: 450px;
    }
    
    .emoji-grid {
        grid-template-columns: repeat(8, 1fr);
    }
}

/* Dark mode adjustments for file upload */
@media (prefers-color-scheme: dark) {
    .file-upload-btn:hover {
        background: rgba(139, 0, 0, 0.3);
    }
    
    .emoji-item:hover {
        background: rgba(139, 0, 0, 0.3);
    }
    
    #file-preview {
        background: rgba(30, 30, 30, 0.95);
    }
}

/* Print styles (hide unnecessary elements when printing) */
@media print {
    .file-upload-btn,
    .emoji-picker-btn,
    .send-btn,
    .social-media-section {
        display: none !important;
    }
    
    #message-input {
        border: 1px solid #ccc;
        background: white;
        color: black;
    }
}

/* High contrast mode support */
@media (prefers-contrast: high) {
    .file-upload-btn,
    .emoji-picker-btn {
        border: 2px solid currentColor;
    }
    
    #file-preview {
        border: 2px solid var(--border-color);
    }
    
    .emoji-item {
        border: 1px solid rgba(139, 0, 0, 0.3);
    }
}

/* Reduced motion preferences */
@media (prefers-reduced-motion: reduce) {
    .social-icon-circle,
    .emoji-item,
    .file-upload-btn,
    .emoji-picker-btn,
    .send-btn {
        transition: none !important;
        animation: none !important;
    }
    
    .social-icon-circle::before {
        display: none;
    }
}

/* Touch device optimizations */
@media (hover: none) and (pointer: coarse) {
    .emoji-item {
        min-height: 55px;
        padding: 15px;
    }
    
    .file-upload-btn,
    .emoji-picker-btn {
        min-width: 50px;
        min-height: 50px;
    }
    
    .social-icon-circle {
        width: 65px;
        height: 65px;
    }
    
    /* Larger tap targets for mobile */
    .emoji-category-btn {
        min-width: 45px;
        height: 45px;
        padding: 10px;
    }
}

/* Landscape mode adjustments */
@media (orientation: landscape) and (max-height: 500px) {
    .emoji-picker-content {
        max-height: 90vh;
        height: auto;
    }
    
    .emoji-grid-container {
        max-height: 50vh;
    }
    
    .social-media-section {
        padding: 20px;
        margin-top: 30px;
    }
    
    .social-icons-grid {
        gap: 15px;
    }
}

/* Custom scrollbar for emoji picker */
.emoji-grid-container::-webkit-scrollbar {
    width: 8px;
}

.emoji-grid-container::-webkit-scrollbar-track {
    background: rgba(26, 26, 26, 0.5);
    border-radius: 4px;
}

.emoji-grid-container::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 4px;
}

.emoji-grid-container::-webkit-scrollbar-thumb:hover {
    background: var(--accent-red);
}

/* Loading animation for file upload */
@keyframes uploadPulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.7;
    }
}

.uploading {
    animation: uploadPulse 1.5s infinite ease-in-out;
}

/* Success animation for file upload */
@keyframes uploadSuccess {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
    100% {
        transform: scale(1);
    }
}

.upload-success {
    animation: uploadSuccess 0.5s ease-out;
}

/* Error state for file upload */
.upload-error {
    border-color: var(--accent-red) !important;
    background: rgba(139, 0, 0, 0.1) !important;
}

/* Tooltip for buttons */
[title] {
    position: relative;
}

[title]:hover::after {
    content: attr(title);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 5px 10px;
    border-radius: var(--radius);
    font-size: 0.8rem;
    white-space: nowrap;
    z-index: 1000;
    margin-bottom: 5px;
}

[title]:hover::before {
    content: '';
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-top-color: rgba(0, 0, 0, 0.8);
    margin-bottom: -5px;
    z-index: 1000;
}

ÎŸÏÎ¹ÏƒÏ„Îµ ÎºÎ±Î¹ Ï„Î¿ client.js:
// client.js - RatRoom Client with Enhanced Security, Notifications & UNREAD SYSTEM - UPDATED WITH FILE UPLOAD & EMOJI PICKER
const socket = io();

// Current user state
let currentUser = {
    username: null,
    email: null,
    authenticated: false,
    sessionId: null,
};

// Current room state
let currentRoom = {
    id: null,
    name: null,
    inviteCode: null,
    isPrivate: false,
};

// ===== FILE UPLOAD SYSTEM =====
let fileUploadInProgress = false;
let selectedFile = null;

// ===== EMOJI PICKER SYSTEM =====
const emojiCategories = {
    smileys: ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥³'],
    hearts: ['â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’'],
    hands: ['ğŸ‘', 'ğŸ‘', 'ğŸ‘Š', 'âœŠ', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ‘Œ', 'ğŸ¤', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ‘‡', 'â˜ï¸', 'âœ‹', 'ğŸ¤š', 'ğŸ–ï¸', 'ğŸ––', 'ğŸ‘‹', 'ğŸ¤™', 'ğŸ’ª', 'ğŸ¦¾'],
    vehicles: ['ğŸš—', 'ğŸš•', 'ğŸš™', 'ğŸšŒ', 'ğŸš', 'ğŸï¸', 'ğŸš“', 'ğŸš‘', 'ğŸš’', 'ğŸš', 'ğŸšš', 'ğŸš›', 'ğŸšœ', 'ğŸ›´', 'ğŸš²', 'ğŸ›µ', 'ğŸï¸', 'ğŸ›º', 'ğŸš¨', 'ğŸš”', 'ğŸš', 'ğŸš˜', 'ğŸš–', 'ğŸš¡', 'ğŸš ', 'ğŸšŸ', 'ğŸšƒ', 'ğŸš‹', 'ğŸš', 'ğŸšˆ', 'ğŸš‚', 'ğŸš†', 'ğŸš‡', 'ğŸšŠ', 'ğŸš‰', 'âœˆï¸', 'ğŸ›«', 'ğŸ›¬', 'ğŸ›©ï¸', 'ğŸ’º', 'ğŸ›°ï¸', 'ğŸš€', 'ğŸ›¸', 'ğŸš', 'ğŸ›¶', 'â›µ', 'ğŸš¤', 'ğŸ›¥ï¸', 'ğŸ›³ï¸', 'â›´ï¸', 'ğŸš¢'],
    symbols: ['ğŸ”¥', 'ğŸ’¯', 'âœ¨', 'ğŸŒŸ', 'â­', 'ğŸŒ ', 'ğŸ‡', 'ğŸ†', 'ğŸŒˆ', 'â˜€ï¸', 'ğŸŒ¤ï¸', 'â›…', 'ğŸŒ¥ï¸', 'â˜ï¸', 'â›ˆï¸', 'ğŸŒ©ï¸', 'ğŸŒ§ï¸', 'â„ï¸', 'â˜ƒï¸', 'â›„', 'ğŸ’§', 'ğŸ’¦', 'â˜”', 'ğŸ’¥', 'âš¡', 'ğŸ¯', 'ğŸ®', 'ğŸ²', 'ğŸ§©', 'ğŸ¨', 'ğŸµ', 'ğŸ¶', 'ğŸ¸', 'ğŸ¹', 'ğŸ¥', 'ğŸº', 'ğŸ»', 'ğŸ¬', 'ğŸ†', 'ğŸª', 'ğŸ­', 'ğŸ©°', 'ğŸ¤', 'ğŸ§', 'ğŸ¼', 'ğŸ·'],
    objects: ['ğŸ”‘', 'ğŸ’¼', 'ğŸ“', 'ğŸ“', 'âœ‚ï¸', 'ğŸ“', 'ğŸ“', 'ğŸ“Œ', 'ğŸ“', 'ğŸ“Œ', 'ğŸ–ï¸', 'ğŸ–Œï¸', 'ğŸ–Šï¸', 'âœ’ï¸', 'ğŸ“', 'ğŸ“’', 'ğŸ“”', 'ğŸ“•', 'ğŸ“—', 'ğŸ“˜', 'ğŸ“™', 'ğŸ“š', 'ğŸ“–', 'ğŸ”–', 'ğŸ·ï¸', 'ğŸ’°', 'ğŸ’³', 'ğŸ’', 'âš™ï¸', 'ğŸ”§', 'ğŸ”¨', 'â›ï¸', 'âš’ï¸', 'ğŸ› ï¸', 'ğŸ”—', 'â›“ï¸', 'ğŸ§±', 'ğŸ”©', 'âš–ï¸', 'ğŸ§°', 'ğŸ§²', 'ğŸ”¬', 'ğŸ”­', 'ğŸ“¡', 'ğŸ’‰', 'ğŸ©¹', 'ğŸ’Š'],
    flags: ['ğŸ', 'ğŸš©', 'ğŸŒ', 'ğŸ´', 'ğŸ³ï¸', 'ğŸ³ï¸â€ğŸŒˆ', 'ğŸ´â€â˜ ï¸', 'ğŸ‡¬ğŸ‡·', 'ğŸ‡ºğŸ‡¸', 'ğŸ‡¬ğŸ‡§', 'ğŸ‡©ğŸ‡ª', 'ğŸ‡«ğŸ‡·', 'ğŸ‡®ğŸ‡¹', 'ğŸ‡ªğŸ‡¸', 'ğŸ‡¯ğŸ‡µ', 'ğŸ‡¨ğŸ‡³', 'ğŸ‡°ğŸ‡·', 'ğŸ‡·ğŸ‡º', 'ğŸ‡®ğŸ‡³']
};

// ===== UNREAD MESSAGES SYSTEM =====
let unreadMessages = {
    private: {},    // {friendUsername: count}
    groups: {},     // {roomId: count}
    total: 0
};

// ===== USER INFO SYSTEM =====
let currentViewedUser = null;

// ===== AVATAR SYSTEM =====
let userAvatars = {}; // Cache Î³Î¹Î± Ï„Î± avatars Ï„Ï‰Î½ Ï‡ÏÎ·ÏƒÏ„ÏÎ½

// ===== CHAT STATE PERSISTENCE =====

function saveChatState() {
    if (currentRoom.id) {
        const chatState = {
            roomId: currentRoom.id,
            roomName: currentRoom.name,
            inviteCode: currentRoom.inviteCode,
            isPrivate: currentRoom.isPrivate,
            timestamp: Date.now()
        };
        localStorage.setItem('ratscape_chat_state', JSON.stringify(chatState));
        console.log('ğŸ’¾ Chat state saved:', chatState);
    }
}

function loadChatState() {
    const savedState = localStorage.getItem('ratscape_chat_state');
    if (savedState) {
        try {
            const state = JSON.parse(savedState);
            const oneHour = 60 * 60 * 1000; // 1 ÏÏÎ± expiry
            if (Date.now() - state.timestamp < oneHour) {
                return state;
            }
        } catch (error) {
            console.error('Error loading chat state:', error);
        }
    }
    return null;
}

function clearChatState() {
    localStorage.removeItem('ratscape_chat_state');
}

// ===== INITIALIZE FILE UPLOAD & EMOJI PICKER =====

// ğŸ”¥ Î‘Î¡Î§Î™ÎšÎŸÎ ÎŸÎ™Î—Î£Î— FILE UPLOAD SYSTEM
function initFileUploadSystem() {
    const fileInput = document.getElementById('file-upload-input');
    const fileUploadBtn = document.querySelector('.file-upload-btn');
    
    if (fileInput && fileUploadBtn) {
        // Î‘Î½Î¿Î¹Î³Î¼Î± file dialog ÏŒÏ„Î±Î½ Ï€Î±Ï„Î¹Î­Ï„Î±Î¹ Ï„Î¿ Î±Ï€ÏŒÎ¸ÎµÎ¼Î¿
        fileUploadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            fileInput.click();
        });
        
        // Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿Ï… Î±ÏÏ‡ÎµÎ¯Î¿Ï…
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                handleFileSelection(file);
            }
        });
    }
}

// ğŸ”¥ Î‘Î¡Î§Î™ÎšÎŸÎ ÎŸÎ™Î—Î£Î— EMOJI PICKER
function initEmojiPickerSystem() {
    const emojiBtn = document.querySelector('.emoji-picker-btn');
    
    if (emojiBtn) {
        emojiBtn.addEventListener('click', function(e) {
            e.preventDefault();
            showEmojiPicker();
        });
    }
}

// ğŸ”¥ HANDLE FILE SELECTION
function handleFileSelection(file) {
    // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Ï„ÏÏ€Î¿Ï… Î±ÏÏ‡ÎµÎ¯Î¿Ï…
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'application/pdf', 'text/plain', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
    
    if (!allowedTypes.includes(file.type)) {
        showNotification('ÎœÏŒÎ½Î¿ ÎµÎ¹ÎºÏŒÎ½ÎµÏ‚, PDF ÎºÎ±Î¹ Word Î±ÏÏ‡ÎµÎ¯Î± ÎµÏ€Î¹Ï„ÏÎ­Ï€Î¿Î½Ï„Î±Î¹!', 'error', 'Î›Î¬Î¸Î¿Ï‚ Î‘ÏÏ‡ÎµÎ¯Î¿');
        return;
    }
    
    // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î¼ÎµÎ³Î­Î¸Î¿Ï…Ï‚ (10MB)
    if (file.size > 10 * 1024 * 1024) {
        showNotification('Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Ï Î¼ÎµÎ³Î¬Î»Î¿! ÎœÎ­Î³Î¹ÏƒÏ„Î¿ Î¼Î­Î³ÎµÎ¸Î¿Ï‚: 10MB', 'error', 'ÎœÎµÎ³Î¬Î»Î¿ Î‘ÏÏ‡ÎµÎ¯Î¿');
        return;
    }
    
    selectedFile = file;
    showFilePreview(file);
}

// ğŸ”¥ SHOW FILE PREVIEW
function showFilePreview(file) {
    const filePreview = document.getElementById('file-preview');
    const previewImage = document.getElementById('preview-image');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    const uploadProgress = document.getElementById('upload-progress');
    
    if (!filePreview || !previewImage) return;
    
    // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· preview
    const reader = new FileReader();
    reader.onload = function(e) {
        // Î‘Î½ ÎµÎ¯Î½Î±Î¹ ÎµÎ¹ÎºÏŒÎ½Î±, Î´ÎµÎ¯Î¾Îµ preview
        if (file.type.startsWith('image/')) {
            previewImage.src = e.target.result;
            previewImage.style.display = 'block';
        } else {
            // Î‘Î½ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ ÎµÎ¹ÎºÏŒÎ½Î±, Î´ÎµÎ¯Î¾Îµ Î¼ÏŒÎ½Î¿ ÎµÎ¹ÎºÎ¿Î½Î¯Î´Î¹Î¿
            previewImage.style.display = 'none';
        }
        
        filePreview.style.display = 'block';
        
        // Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ Î±ÏÏ‡ÎµÎ¯Î¿Ï…
        if (fileName) {
            fileName.textContent = file.name.length > 25 ? file.name.substring(0, 25) + '...' : file.name;
        }
        
        if (fileSize) {
            const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
            fileSize.textContent = sizeInMB + ' MB';
        }
        
        // Reset progress bar
        if (uploadProgress) {
            uploadProgress.style.width = '0%';
            uploadProgress.textContent = '0%';
        }
    };
    reader.readAsDataURL(file);
}

// ğŸ”¥ CANCEL FILE UPLOAD
function cancelFileUpload() {
    const filePreview = document.getElementById('file-preview');
    const fileInput = document.getElementById('file-upload-input');
    const uploadProgress = document.getElementById('upload-progress');
    const uploadStatus = document.getElementById('upload-status');
    
    if (filePreview) {
        filePreview.style.display = 'none';
    }
    
    if (fileInput) {
        fileInput.value = '';
    }
    
    if (uploadProgress) {
        uploadProgress.style.width = '0%';
        uploadProgress.textContent = '';
    }
    
    if (uploadStatus) {
        uploadStatus.textContent = '';
    }
    
    selectedFile = null;
    fileUploadInProgress = false;
}

// ğŸ”¥ UPLOAD FILE TO SERVER
async function uploadFile() {
    if (!selectedFile || fileUploadInProgress) return;
    
    fileUploadInProgress = true;
    
    const uploadProgress = document.getElementById('upload-progress');
    const uploadStatus = document.getElementById('upload-status');
    const sendFileBtn = document.getElementById('send-file-btn');
    const originalBtnText = sendFileBtn ? sendFileBtn.innerHTML : '';
    
    // Î ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î±ÏƒÎ¯Î± FormData
    const formData = new FormData();
    formData.append('file', selectedFile);
    
    if (currentRoom.id) {
        formData.append('roomId', currentRoom.id);
    }
    
    formData.append('sender', currentUser.username);
    formData.append('type', currentRoom.isPrivate ? 'private' : 'group');
    
    if (currentRoom.isPrivate) {
        formData.append('receiver', currentRoom.name);
    }
    
    try {
        // Î ÏÎ¿ÏƒÎ¿Î¼Î¿Î¯Ï‰ÏƒÎ· Ï€ÏÎ¿ÏŒÎ´Î¿Ï…
        if (uploadProgress) {
            uploadProgress.style.width = '30%';
            uploadProgress.textContent = '30%';
        }
        
        if (uploadStatus) {
            uploadStatus.textContent = 'Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î±ÏÏ‡ÎµÎ¯Î¿Ï…...';
        }
        
        if (sendFileBtn) {
            sendFileBtn.disabled = true;
            sendFileBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®...';
        }
        
        // Î ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÏŒ upload
        const response = await fetch('/upload-file', {
            method: 'POST',
            headers: {
                'X-Session-ID': currentUser.sessionId
            },
            body: formData
        });
        
        if (uploadProgress) {
            uploadProgress.style.width = '70%';
            uploadProgress.textContent = '70%';
        }
        
        if (!response.ok) {
            throw new Error('Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î±Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚ Î±ÏÏ‡ÎµÎ¯Î¿Ï…');
        }
        
        const data = await response.json();
        
        if (uploadProgress) {
            uploadProgress.style.width = '100%';
            uploadProgress.textContent = '100%';
        }
        
        if (uploadStatus) {
            uploadStatus.textContent = 'Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® ÎµÏ€Î¹Ï„Ï…Ï‡Î®Ï‚!';
        }
        
        if (data.success) {
            // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚ ÏƒÏ„Î¿ chat
            const messageData = {
                text: `ğŸ“ ${selectedFile.name}`,
                sender: currentUser.username,
                time: getCurrentTime(),
                isFile: true,
                file_data: {
                    fileId: data.fileId || `file_${Date.now()}`,
                    fileName: selectedFile.name,
                    fileType: selectedFile.type,
                    fileSize: data.fileSize || formatFileSize(selectedFile.size),
                    fileUrl: data.fileUrl
                }
            };
            
            if (currentRoom.isPrivate) {
                messageData.receiver = currentRoom.name;
                socket.emit("private message", messageData);
                addMessageToChat(messageData);
            } else {
                messageData.room_id = currentRoom.id;
                socket.emit("chat message", messageData);
                addMessageToChat(messageData);
            }
            
            showNotification('Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ ÏƒÏ„Î¬Î»Î¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!', 'success', 'Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î‘ÏÏ‡ÎµÎ¯Î¿Ï…');
            
            // Î‘Ï€ÏŒÎºÏÏ…ÏˆÎ· preview Î¼ÎµÏ„Î¬ Î±Ï€ÏŒ 1 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î¿
            setTimeout(() => {
                cancelFileUpload();
            }, 1000);
        }
        
    } catch (error) {
        console.error('Error uploading file:', error);
        showNotification('Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Î±Ï€Î¿ÏƒÏ„Î¿Î»Î® Î±ÏÏ‡ÎµÎ¯Î¿Ï…: ' + error.message, 'error', 'Î£Ï†Î¬Î»Î¼Î±');
        
        if (uploadStatus) {
            uploadStatus.textContent = 'Î£Ï†Î¬Î»Î¼Î±!';
            uploadStatus.style.color = 'var(--accent-red)';
        }
    } finally {
        fileUploadInProgress = false;
        
        if (sendFileBtn) {
            sendFileBtn.disabled = false;
            sendFileBtn.innerHTML = originalBtnText;
        }
    }
}

// ğŸ”¥ SHOW EMOJI PICKER
function showEmojiPicker() {
    const emojiPicker = document.getElementById('emoji-picker-modal');
    if (emojiPicker) {
        emojiPicker.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
}

// ğŸ”¥ HIDE EMOJI PICKER
function hideEmojiPicker() {
    const emojiPicker = document.getElementById('emoji-picker-modal');
    if (emojiPicker) {
        emojiPicker.classList.remove('active');
        document.body.style.overflow = '';
    }
}

// ğŸ”¥ INITIALIZE EMOJI PICKER CONTENT
function initEmojiPickerContent() {
    const emojiCategoriesContainer = document.getElementById('emoji-categories');
    const emojiGrid = document.getElementById('emoji-grid');
    
    if (!emojiCategoriesContainer || !emojiGrid) return;
    
    // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎºÎ±Ï„Î·Î³Î¿ÏÎ¹ÏÎ½
    Object.keys(emojiCategories).forEach((category, index) => {
        const button = document.createElement('button');
        button.className = `emoji-category-btn ${index === 0 ? 'active' : ''}`;
        button.dataset.category = category;
        button.innerHTML = emojiCategories[category][0];
        button.title = getCategoryName(category);
        
        button.addEventListener('click', function() {
            // Î‘Ï†Î±Î¯ÏÎµÏƒÎ· active class Î±Ï€ÏŒ ÏŒÎ»Î±
            document.querySelectorAll('.emoji-category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· active class ÏƒÏ„Î¿ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿
            this.classList.add('active');
            // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· emoji Ï„Î·Ï‚ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±Ï‚
            loadEmojiCategory(category);
        });
        
        emojiCategoriesContainer.appendChild(button);
    });
    
    // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï€ÏÏÏ„Î·Ï‚ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±Ï‚
    loadEmojiCategory(Object.keys(emojiCategories)[0]);
    
    // Close button
    const closeBtn = document.getElementById('close-emoji-picker');
    if (closeBtn) {
        closeBtn.addEventListener('click', hideEmojiPicker);
    }
    
    // ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Î¼Îµ click Î­Î¾Ï‰
    const emojiPickerModal = document.getElementById('emoji-picker-modal');
    if (emojiPickerModal) {
        emojiPickerModal.addEventListener('click', function(e) {
            if (e.target === this) {
                hideEmojiPicker();
            }
        });
    }
}

// ğŸ”¥ LOAD EMOJI CATEGORY
function loadEmojiCategory(category) {
    const emojiGrid = document.getElementById('emoji-grid');
    if (!emojiGrid) return;
    
    emojiGrid.innerHTML = '';
    const emojis = emojiCategories[category];
    
    emojis.forEach(emoji => {
        const emojiBtn = document.createElement('button');
        emojiBtn.className = 'emoji-item';
        emojiBtn.textContent = emoji;
        emojiBtn.title = `Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® ${emoji}`;
        
        emojiBtn.addEventListener('click', function() {
            insertEmoji(emoji);
        });
        
        emojiGrid.appendChild(emojiBtn);
    });
}

// ğŸ”¥ INSERT EMOJI INTO MESSAGE INPUT
function insertEmoji(emoji) {
    const messageInput = document.getElementById('message-input');
    if (!messageInput) return;
    
    const start = messageInput.selectionStart;
    const end = messageInput.selectionEnd;
    const text = messageInput.value;
    const newText = text.substring(0, start) + emoji + text.substring(end);
    
    messageInput.value = newText;
    messageInput.focus();
    messageInput.selectionStart = messageInput.selectionEnd = start + emoji.length;
    
    // Trigger input event Î³Î¹Î± Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î±Î»Î»Î±Î³Î® ÏÏˆÎ¿Ï…Ï‚
    messageInput.dispatchEvent(new Event('input'));
    
    // ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ emoji picker Î¼ÏŒÎ½Î¿ ÏƒÎµ mobile
    if (window.innerWidth <= 768) {
        setTimeout(() => {
            hideEmojiPicker();
        }, 300);
    }
}

// ğŸ”¥ GET CATEGORY NAME
function getCategoryName(category) {
    const names = {
        smileys: 'Smileys & People',
        hearts: 'Hearts & Emotions',
        hands: 'Hands & Gestures',
        vehicles: 'Vehicles & Travel',
        symbols: 'Symbols & Objects',
        objects: 'Objects & Tools',
        flags: 'Flags & Countries'
    };
    return names[category] || category;
}

// ğŸ”¥ FORMAT FILE SIZE
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ğŸ”¥ INITIALIZE EVENT LISTENERS FOR FILE UPLOAD & EMOJI
function initializeUploadAndEmojiListeners() {
    // Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· file upload system
    initFileUploadSystem();
    
    // Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· emoji picker system
    initEmojiPickerSystem();
    
    // Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· emoji picker content
    initEmojiPickerContent();
    
    // Send file button
    const sendFileBtn = document.getElementById('send-file-btn');
    if (sendFileBtn) {
        sendFileBtn.addEventListener('click', function(e) {
            e.preventDefault();
            uploadFile();
        });
    }
    
    // Cancel upload button
    const cancelUploadBtn = document.getElementById('cancel-upload-btn');
    if (cancelUploadBtn) {
        cancelUploadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            cancelFileUpload();
        });
    }
}

// ===== BEAUTIFUL NOTIFICATION SYSTEM WITH CLICKABLE =====

function showNotification(message, type = "info", title = null, action = null, unreadCount = 1) {
    const container = document.getElementById("notification-container");
    if (!container) {
        createNotificationContainer();
    }

    const notification = document.createElement("div");
    notification.className = `notification ${type}`;
    
    if (action) {
        notification.dataset.action = JSON.stringify(action);
    }

    // Set icon based on type
    let icon, notificationTitle;
    switch (type) {
        case "success":
            icon = "âœ“";
            notificationTitle = title || "Success";
            break;
        case "error":
            icon = "âœ•";
            notificationTitle = title || "Error";
            break;
        case "warning":
            icon = "âš ";
            notificationTitle = title || "Warning";
            break;
        case "avatar_upload_success":
            icon = "âœ“";
            notificationTitle = title || "Profile Picture Updated";
            break;
        default:
            icon = "â„¹";
            notificationTitle = title || "Info";
    }

    // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· unread count ÏƒÏ„Î¿ message Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹
    let displayMessage = message;
    if (unreadCount > 1) {
        displayMessage = `(${unreadCount}) ${message}`;
    }

    notification.innerHTML = `
        <div class="notification-icon">${icon}</div>
        <div class="notification-content">
            <div class="notification-title">${notificationTitle}</div>
            <div class="notification-message">${displayMessage}</div>
        </div>
        <button class="notification-close">Ã—</button>
    `;

    // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· unread count badge Î±Î½ ÎµÎ¯Î½Î±Î¹ > 1
    if (unreadCount > 1) {
        const countBadge = document.createElement('div');
        countBadge.className = 'notification-count-badge';
        countBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
        notification.appendChild(countBadge);
    }

    document.getElementById("notification-container").appendChild(notification);

    // CLICK HANDLER Î³Î¹Î± notifications Î¼Îµ action
    if (action) {
        notification.style.cursor = 'pointer';
        notification.classList.add('clickable');
        
        notification.addEventListener('click', function(e) {
            if (!e.target.classList.contains('notification-close')) {
                handleNotificationAction(action);
                hideNotification(notification);
                
                // Auto-clear unread ÏŒÏ„Î±Î½ Ï€Î±Ï„Î¬Ï‚ Ï„Î¿ notification
                if (action.type === 'private_message') {
                    clearUnread('private', action.sender);
                } else if (action.type === 'room_message') {
                    clearUnread('group', action.sender, action.roomId);
                }
            }
        });
        
        // Hover effect
        notification.addEventListener('mouseenter', function() {
            this.style.transform = 'translateX(-5px)';
            this.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.8)';
        });
        
        notification.addEventListener('mouseleave', function() {
            this.style.transform = '';
            this.style.boxShadow = '';
        });
    }

    // Animate in
    setTimeout(() => {
        notification.classList.add("active");
    }, 10);

    // Add close event
    notification.querySelector(".notification-close").addEventListener("click", (e) => {
        e.stopPropagation();
        hideNotification(notification);
    });

    // Auto hide after 8 seconds Î³Î¹Î± notifications Î¼Îµ action
    if (action) {
        setTimeout(() => {
            if (notification.parentElement) {
                hideNotification(notification);
            }
        }, 8000);
    } else if (type !== "error") {
        setTimeout(() => {
            if (notification.parentElement) {
                hideNotification(notification);
            }
        }, 5000);
    }

    return notification;
}

function hideNotification(notification) {
    notification.classList.remove("active");
    notification.classList.add("hiding");

    setTimeout(() => {
        if (notification.parentElement) {
            notification.parentElement.removeChild(notification);
        }
    }, 300);
}

function createNotificationContainer() {
    const container = document.createElement("div");
    container.id = "notification-container";
    container.className = "notification-container";
    document.body.appendChild(container);
}

// ===== CONFIRMATION MODAL SYSTEM =====

function showConfirmationModal(message, title = "Confirm", onConfirm = null, onCancel = null) {
    // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± modal container Î±Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹
    let modal = document.getElementById("confirmation-modal");
    if (!modal) {
        modal = document.createElement("div");
        modal.id = "confirmation-modal";
        modal.className = "modal";
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="confirmation-title">Confirm</h3>
                    <button class="close-modal-btn" id="close-confirmation-modal">Ã—</button>
                </div>
                <div class="form-container active">
                    <div class="form-group" style="text-align: center; padding: 20px 0;">
                        <p id="confirmation-message" style="font-size: 1rem; color: var(--text); margin: 0;"></p>
                    </div>
                    <div class="modal-buttons">
                        <button class="btn btn-primary" id="confirm-yes-btn">Yes</button>
                        <button class="btn btn-secondary" id="confirm-no-btn">No</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· event listeners
        document.getElementById("close-confirmation-modal").addEventListener("click", hideConfirmationModal);
        document.getElementById("confirm-no-btn").addEventListener("click", hideConfirmationModal);
        
        document.getElementById("confirm-yes-btn").addEventListener("click", function() {
            if (onConfirm) onConfirm();
            hideConfirmationModal();
        });
    }
    
    // ÎŸÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚ ÎºÎ±Î¹ Ï„Î¯Ï„Î»Î¿Ï…
    document.getElementById("confirmation-title").textContent = title;
    document.getElementById("confirmation-message").textContent = message;
    
    // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· modal
    modal.classList.add("active");
}

function hideConfirmationModal() {
    const modal = document.getElementById("confirmation-modal");
    if (modal) {
        modal.classList.remove("active");
    }
}

// ===== AVATAR SYSTEM FUNCTIONS =====

// ğŸ”¥ ÎœÎ™ÎšÎ¡Î— Î’Î•Î›Î¤Î™Î©Î£Î—: Î¦ÏŒÏÏ„Ï‰ÏƒÎ· avatar Î³Î¹Î± Î­Î½Î±Î½ Ï‡ÏÎ®ÏƒÏ„Î·
async function loadUserAvatar(username, element, isCurrentUser = false) {
    if (!username) return;
    
    // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ cache
    if (userAvatars[username]) {
        updateAvatarElement(element, userAvatars[username], username, isCurrentUser);
        return;
    }
    
    try {
        const response = await fetch(`/get-profile-picture/${username}`);
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.profile_picture) {
                // ğŸ”¥ Î•Î”Î© Î‘Î›Î›Î‘Î“Î—: Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Base64 string Î±Ï€ÎµÏ…Î¸ÎµÎ¯Î±Ï‚ ÏƒÏ„Î¿ cache
                userAvatars[username] = data.profile_picture;
                updateAvatarElement(element, data.profile_picture, username, isCurrentUser);
            } else {
                // Î§ÏÎ®ÏƒÎ· initials Î±Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ avatar
                updateAvatarElement(element, null, username, isCurrentUser);
            }
        }
    } catch (error) {
        console.error("Error loading avatar:", error);
        updateAvatarElement(element, null, username, isCurrentUser);
    }
}

// Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎµÎ½ÏŒÏ‚ avatar element
function updateAvatarElement(element, avatarUrl, username, isCurrentUser = false) {
    if (!element) return;
    
    if (avatarUrl) {
        // ğŸ”¥ Î•Î”Î© Î‘Î›Î›Î‘Î“Î—: Î§ÎµÎ¹ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Base64 string Î±Ï€ÎµÏ…Î¸ÎµÎ¯Î±Ï‚
        // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ Ï„Î¿ element ÎµÎ¯Î½Î±Î¹ div Î® img
        if (element.tagName === 'DIV') {
            element.innerHTML = `<img src="${avatarUrl}" alt="${username}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            element.style.background = 'none';
        } else if (element.tagName === 'IMG') {
            element.src = avatarUrl;
            element.alt = username;
            element.style.display = 'block';
        }
    } else {
        // Î§ÏÎ®ÏƒÎ· initials
        if (element.tagName === 'DIV') {
            const initials = username ? username.substring(0, 2).toUpperCase() : '??';
            const color = getAvatarColor(username);
            element.innerHTML = initials;
            element.style.background = color;
            element.style.color = 'white';
            element.style.display = 'flex';
            element.style.alignItems = 'center';
            element.style.justifyContent = 'center';
            element.style.fontWeight = '600';
            element.style.fontSize = '0.75rem';
        }
    }
}

// Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï„Î¿Ï… avatar Ï„Î¿Ï… Ï„ÏÎ­Ï‡Î¿Î½Ï„Î¿Ï‚ Ï‡ÏÎ®ÏƒÏ„Î· Ï€Î±Î½Ï„Î¿Ï
async function loadCurrentUserAvatar() {
    if (!currentUser.authenticated) return;
    
    // Sidebar avatar
    const sidebarAvatar = document.getElementById("sidebar-avatar");
    if (sidebarAvatar) {
        await loadUserAvatar(currentUser.username, sidebarAvatar, true);
    }
    
    // Profile page avatar
    const profileImage = document.getElementById("profile-image");
    if (profileImage) {
        await loadUserAvatar(currentUser.username, profileImage, true);
    }
    
    // User info modal avatar
    const userInfoImage = document.getElementById("user-info-image");
    if (userInfoImage) {
        await loadUserAvatar(currentUser.username, userInfoImage, true);
    }
}

// Î¦ÏŒÏÏ„Ï‰ÏƒÎ· avatars Î³Î¹Î± ÏŒÎ»Î± Ï„Î± Î¼Î­Î»Î· ÏƒÎµ room
async function loadMemberAvatars() {
    const memberItems = document.querySelectorAll('.member-item');
    
    for (const item of memberItems) {
        const username = item.dataset.username;
        if (username) {
            const avatarElement = item.querySelector('.member-avatar');
            if (avatarElement) {
                await loadUserAvatar(username, avatarElement, username === currentUser.username);
            }
        }
    }
}

// ===== UNREAD SYSTEM FUNCTIONS =====

let lastClearTime = 0;
const CLEAR_DEBOUNCE_TIME = 1000; // 1 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î¿

// ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ unread messages - FIXED Î³Î¹Î± console spam
function clearUnread(type, sender, roomId = null) {
    const now = Date.now();
    
    // Debounce Î³Î¹Î± Î½Î± Î±Ï€Î¿Ï†ÏÎ³Î¿Ï…Î¼Îµ Ï€Î¿Î»Î»Î±Ï€Î»Î¬ calls
    if (now - lastClearTime < CLEAR_DEBOUNCE_TIME) {
        return;
    }
    
    lastClearTime = now;
    
    if (type === 'private') {
        if (unreadMessages.private[sender]) {
            delete unreadMessages.private[sender];
        }
    } else if (type === 'group') {
        if (unreadMessages.groups[roomId]) {
            delete unreadMessages.groups[roomId];
        }
    }
    
    updateUnreadBadges();
    
    // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· server Î¼ÏŒÎ½Î¿ Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÏŒÎ½Ï„Ï‰Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Î±
    if (type || sender || roomId) {
        socket.emit('mark_as_read', { type, sender, roomId });
    }
}

// Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· unread message
function addUnreadMessage(type, sender, roomId = null) {
    const key = roomId || sender;
    
    if (type === 'private') {
        if (!unreadMessages.private[sender]) {
            unreadMessages.private[sender] = 0;
        }
        unreadMessages.private[sender]++;
    } else if (type === 'group') {
        if (!unreadMessages.groups[roomId]) {
            unreadMessages.groups[roomId] = 0;
        }
        unreadMessages.groups[roomId]++;
    }
    
    updateUnreadBadges();
    
    // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· UI Î±Î½ ÎµÎ¯Î¼Î±ÏƒÏ„Îµ ÏƒÏ„Î· ÏƒÏ‰ÏƒÏ„Î® ÏƒÎµÎ»Î¯Î´Î±
    updateFriendsListBadges();
    updateRoomsListBadges();
}

// Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ badges
function updateUnreadBadges() {
    // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ total
    const privateTotal = Object.values(unreadMessages.private).reduce((a, b) => a + b, 0);
    const groupsTotal = Object.values(unreadMessages.groups).reduce((a, b) => a + b, 0);
    unreadMessages.total = privateTotal + groupsTotal;
    
    // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· title
    updateTitleBadge();
    
    // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· navigation buttons
    updateNavBadges();
}

// Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· badge ÏƒÏ„Î¿ title
function updateTitleBadge() {
    if (unreadMessages.total > 0) {
        document.title = `(${unreadMessages.total}) RatScape`;
    } else {
        document.title = 'RatScape';
    }
}

// Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· badges ÏƒÏ„Î¿ navigation
function updateNavBadges() {
    const friendsBtn = document.getElementById('my-friends-btn');
    const roomsBtn = document.getElementById('my-rooms-btn');
    
    if (friendsBtn) {
        const privateTotal = Object.values(unreadMessages.private).reduce((a, b) => a + b, 0);
        updateButtonBadge(friendsBtn, privateTotal, 'friends');
    }
    
    if (roomsBtn) {
        const groupsTotal = Object.values(unreadMessages.groups).reduce((a, b) => a + b, 0);
        updateButtonBadge(roomsBtn, groupsTotal, 'rooms');
    }
}

// Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·/ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· badge ÏƒÎµ button
function updateButtonBadge(button, count, type) {
    // Î‘Ï†Î±Î¯ÏÎµÏƒÎ· Ï…Ï€Î¬ÏÏ‡Î¿Î½Ï„Î¿Ï‚ badge
    const existingBadge = button.querySelector('.nav-badge');
    if (existingBadge) {
        existingBadge.remove();
    }
    
    // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î½Î­Î¿Ï… badge Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ unread
    if (count > 0) {
        const badge = document.createElement('span');
        badge.className = 'nav-badge';
        badge.textContent = count > 99 ? '99+' : count;
        badge.style.cssText = `
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-red);
            color: white;
            border-radius: 10px;
            min-width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            z-index: 100;
            animation: badgePop 0.3s ease-out;
        `;
        
        button.style.position = 'relative';
        button.appendChild(badge);
    }
}

// Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· badges ÏƒÏ„Î· Î»Î¯ÏƒÏ„Î± Ï†Î¯Î»Ï‰Î½
function updateFriendsListBadges() {
    const friendCards = document.querySelectorAll('.friend-card:not(.pending)');
    friendCards.forEach(card => {
        const nameElement = card.querySelector('.friend-name');
        if (nameElement) {
            const friendName = nameElement.textContent;
            const unreadCount = unreadMessages.private[friendName] || 0;
            
            // Î‘Ï†Î±Î¯ÏÎµÏƒÎ· Ï…Ï€Î¬ÏÏ‡Î¿Î½Ï„Î¿Ï‚ badge
            const existingBadge = card.querySelector('.friend-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î½Î­Î¿Ï… badge
            if (unreadCount > 0) {
                const badge = document.createElement('span');
                badge.className = 'friend-badge';
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: var(--accent-red);
                    color: white;
                    border-radius: 10px;
                    min-width: 20px;
                    height: 20px;
                    font-size: 0.7rem;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 0 5px;
                    font-weight: bold;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
                    z-index: 1;
                    animation: badgePop 0.3s ease-out;
                `;
                
                card.style.position = 'relative';
                card.appendChild(badge);
            }
        }
    });
}

// Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· badges ÏƒÏ„Î· Î»Î¯ÏƒÏ„Î± Î´Ï‰Î¼Î±Ï„Î¯Ï‰Î½
function updateRoomsListBadges() {
    const roomCards = document.querySelectorAll('.room-card');
    roomCards.forEach(card => {
        const enterBtn = card.querySelector('.enter-room-btn');
        if (enterBtn) {
            const roomId = enterBtn.dataset.roomId;
            const unreadCount = unreadMessages.groups[roomId] || 0;
            
            // Î‘Ï†Î±Î¯ÏÎµÏƒÎ· Ï…Ï€Î¬ÏÏ‡Î¿Î½Ï„Î¿Ï‚ badge
            const existingBadge = card.querySelector('.room-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î½Î­Î¿Ï… badge
            if (unreadCount > 0) {
                const badge = document.createElement('span');
                badge.className = 'room-badge';
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: var(--accent-red);
                    color: white;
                    border-radius: 10px;
                    min-width: 20px;
                    height: 20px;
                    font-size: 0.7rem;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 0 5px;
                    font-weight: bold;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
                    z-index: 1;
                    animation: badgePop 0.3s ease-out;
                `;
                
                card.style.position = 'relative';
                card.appendChild(badge);
            }
        }
    });
}

// Î¦ÏŒÏÏ„Ï‰ÏƒÎ· offline notifications ÏŒÏ„Î±Î½ ÏƒÏ…Î½Î´Î­ÎµÏ„Î±Î¹ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚
async function loadOfflineNotifications() {
    if (!currentUser.authenticated) return;
    
    try {
        const response = await fetch(`/offline-notifications/${currentUser.username}`, {
            headers: {
                "X-Session-ID": currentUser.sessionId,
            },
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                console.log(`ğŸ“¬ Loaded ${data.total} offline notifications`);
                
                // Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· unreadMessages Î±Ï€ÏŒ summary
                if (data.summary) {
                    unreadMessages.private = data.summary.private || {};
                    unreadMessages.groups = data.summary.groups || {};
                    unreadMessages.total = data.summary.total || 0;
                    updateUnreadBadges();
                }
                
                // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· welcome notification
                if (data.total > 0) {
                    setTimeout(() => {
                        showNotification(
                            `You have ${data.unread_count} unread messages`,
                            "info",
                            "Welcome Back!",
                            null,
                            data.unread_count
                        );
                    }, 1000);
                }
                
                // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î»ÎµÏ€Ï„Î¿Î¼ÎµÏÏÎ½ notifications
                data.notifications.forEach((notification, index) => {
                    setTimeout(() => {
                        let type = "info";
                        let title = "Notification";
                        
                        switch (notification.type) {
                            case 'offline_private_message':
                                type = "info";
                                title = "Unread Message";
                                break;
                            case 'offline_group_message':
                                type = "info";
                                title = "Unread Group Message";
                                break;
                            case 'offline_friend_request':
                                type = "info";
                                title = "Pending Friend Request";
                                break;
                        }
                        
                        showNotification(
                            `${notification.sender}: ${notification.message || 'Friend request'}`,
                            type,
                            title,
                            notification.action,
                            notification.count || 1
                        );
                    }, 1500 + (index * 300));
                });
            }
        }
    } catch (error) {
        console.error("Error loading offline notifications:", error);
    }
}

// ===== HANDLE NOTIFICATION ACTIONS =====

function handleNotificationAction(action) {
    console.log("ğŸ”” Handling notification action:", action);
    
    hideAllModals();
    
    switch (action.type) {
        case 'private_message':
            const friendUsername = action.sender;
            if (friendUsername) {
                // Clear unread Î³Î¹Î± Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Ï†Î¯Î»Î¿
                clearUnread('private', friendUsername);
                
                // Î Î®Î³Î±Î¹Î½Îµ ÏƒÏ„Î· ÏƒÎµÎ»Î¯Î´Î± Ï†Î¯Î»Ï‰Î½
                loadUserFriends();
                showPage("friends-page");
                
                // Highlight ÎºÎ±Î¹ Î¬Î½Î¿Î¹Î³Î¼Î± chat
                setTimeout(() => {
                    highlightAndOpenFriendChat(friendUsername);
                }, 800);
            }
            break;
            
        case 'room_message':
            if (action.roomId) {
                // Clear unread Î³Î¹Î± Î±Ï…Ï„ÏŒ Ï„Î¿ room
                clearUnread('group', action.sender, action.roomId);
                
                // Î Î®Î³Î±Î¹Î½Îµ ÏƒÏ„Î· ÏƒÎµÎ»Î¯Î´Î± Î´Ï‰Î¼Î±Ï„Î¯Ï‰Î½
                loadUserRooms();
                showPage("rooms-page");
                
                // Highlight ÎºÎ±Î¹ ÎµÎ¯ÏƒÎ¿Î´Î¿Ï‚ ÏƒÏ„Î¿ room
                setTimeout(() => {
                    highlightAndEnterRoom(action.roomId);
                }, 800);
            }
            break;
            
        case 'friend_request':
            // Î Î®Î³Î±Î¹Î½Îµ ÏƒÏ„Î· ÏƒÎµÎ»Î¯Î´Î± Ï†Î¯Î»Ï‰Î½
            loadUserFriends();
            showPage("friends-page");
            
            // Highlight pending requests
            setTimeout(() => {
                highlightPendingRequests();
            }, 800);
            break;
            
        case 'friend_request_accepted':
            // Î Î®Î³Î±Î¹Î½Îµ ÏƒÏ„Î· ÏƒÎµÎ»Î¯Î´Î± Ï†Î¯Î»Ï‰Î½
            loadUserFriends();
            showPage("friends-page");
            break;
    }
}

// Î’Î¿Î·Î¸Î·Ï„Î¹ÎºÎ­Ï‚ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚ Î³Î¹Î± highlight
function highlightAndOpenFriendChat(friendUsername) {
    const friendCards = document.querySelectorAll('.friend-card:not(.pending)');
    friendCards.forEach(card => {
        const nameElement = card.querySelector('.friend-name');
        if (nameElement && nameElement.textContent === friendUsername) {
            // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· animation
            card.style.animation = 'highlightPulse 2s ease-in-out';
            card.style.border = '2px solid var(--accent-red)';
            
            // ÎšÎ¬Î½Îµ click ÏƒÏ„Î¿ chat button
            const chatBtn = card.querySelector('.chat-friend-btn');
            if (chatBtn) {
                setTimeout(() => {
                    chatBtn.click();
                }, 1000);
            }
        }
    });
}

function highlightAndEnterRoom(roomId) {
    const roomCards = document.querySelectorAll('.room-card');
    roomCards.forEach(card => {
        const enterBtn = card.querySelector('.enter-room-btn');
        if (enterBtn && enterBtn.dataset.roomId === roomId) {
            card.style.animation = 'highlightPulse 2s ease-in-out';
            card.style.border = '2px solid var(--accent-red)';
            
            setTimeout(() => {
                enterBtn.click();
            }, 1500);
        }
    });
}

function highlightPendingRequests() {
    const pendingSection = document.querySelector('.pending-requests-list');
    if (pendingSection) {
        pendingSection.scrollIntoView({ behavior: 'smooth' });
        pendingSection.style.animation = 'highlightPulse 2s ease-in-out';
        pendingSection.style.border = '2px solid var(--accent-red)';
        pendingSection.style.padding = '10px';
        pendingSection.style.borderRadius = 'var(--radius)';
    }
}

// ===== UTILITY FUNCTIONS =====

function showPage(pageId) {
    document.querySelectorAll(".page").forEach((p) => p.classList.remove("active"));
    document.getElementById(pageId).classList.add("active");

    if (currentUser.authenticated) {
        saveCurrentPage(pageId);
    }
    
    // ğŸ”¥ Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—: Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï„Î·Ï‚ ÏƒÎµÎ»Î¯Î´Î±Ï‚ Î³Î¹Î± refresh
    if (typeof setCurrentPageId === 'function') {
        setCurrentPageId(pageId);
    }
    
    // ğŸ”¥ Î•Ï€Î¯ÏƒÎ·Ï‚ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· ÏƒÏ„Î¿ localStorage
    localStorage.setItem('ratscape_last_page', pageId);
    
    // ğŸ”¥ Î•Î™Î”Î™ÎšÎŸ: Î‘Î½ Ï†ÎµÏÎ³Î¿Ï…Î¼Îµ Î±Ï€ÏŒ chat page, Î±Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Ï…Î¼Îµ Ï„Î·Î½ ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·
    if (pageId === 'chat-page') {
        saveChatState();
    } else if (pageId !== 'chat-page' && currentRoom.id) {
        // Î‘Î½ Ï†ÎµÏÎ³Î¿Ï…Î¼Îµ Î±Ï€ÏŒ chat page Ï€ÏÎ¿Ï‚ Î¬Î»Î»Î· ÏƒÎµÎ»Î¯Î´Î±, ÎºÏÎ±Ï„Î¬Î¼Îµ Ï„Î·Î½ ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·
        saveChatState();
    }
}

function showModal(modalId) {
    document.getElementById(modalId).classList.add("active");
}

function hideModal(modalId) {
    document.getElementById(modalId).classList.remove("active");
}

function hideAllModals() {
    document.querySelectorAll(".modal").forEach((m) => m.classList.remove("active"));
}

function getCurrentTime() {
    const now = new Date();
    return now.toLocaleTimeString("en-US", {
        hour: "2-digit",
        minute: "2-digit",
        hour12: false,
    });
}

function saveUserToLocalStorage(user) {
    localStorage.setItem(
        "ratroom_user",
        JSON.stringify({
            username: user.username,
            email: user.email,
            authenticated: user.authenticated,
            sessionId: user.sessionId,
            timestamp: Date.now(),
        })
    );
}

function getUserFromLocalStorage() {
    const userData = localStorage.getItem("ratroom_user");
    if (!userData) return null;

    try {
        const user = JSON.parse(userData);
        const oneWeek = 7 * 24 * 60 * 60 * 1000;
        if (Date.now() - user.timestamp > oneWeek) {
            clearUserFromLocalStorage();
            return null;
        }
        return user;
    } catch (error) {
        clearUserFromLocalStorage();
        return null;
    }
}

function clearUserFromLocalStorage() {
    localStorage.removeItem("ratroom_user");
    localStorage.removeItem("ratroom_last_page");
}

function saveCurrentPage(pageId) {
    localStorage.setItem("ratroom_last_page", pageId);
}

function getLastPage() {
    return localStorage.getItem("ratroom_last_page") || "home-page";
}

// Î’Î¿Î·Î¸Î·Ï„Î¹ÎºÎ® ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Î³Î¹Î± avatar colors
function getAvatarColor(username) {
    const colors = [
        "#8B0000", "#1A1A1A", "#228B22", "#FFA500", "#4285F4",
        "#9932CC", "#20B2AA", "#FF4500", "#4682B4", "#32CD32"
    ];
    let hash = 0;
    for (let i = 0; i < username.length; i++) {
        hash = username.charCodeAt(i) + ((hash << 5) - hash);
    }
    return colors[Math.abs(hash) % colors.length];
}

// ===== UI UPDATE FUNCTIONS =====

function updateUIForAuthState() {
    const loggedOutNav = document.getElementById("nav-logged-out");
    const loggedInNav = document.getElementById("nav-logged-in");
    const homeCTALoggedOut = document.getElementById("home-cta-logged-out");
    const homeCTALoggedIn = document.getElementById("home-cta-logged-in");
    const navUsername = document.getElementById("nav-username");

    if (currentUser.authenticated) {
        loggedOutNav.style.display = "none";
        loggedInNav.style.display = "flex";
        homeCTALoggedOut.style.display = "none";
        homeCTALoggedIn.style.display = "block";
        navUsername.textContent = currentUser.username;

        socket.emit("authenticate", {
            username: currentUser.username,
            sessionId: currentUser.sessionId,
        });

        document.getElementById("display-my-username").textContent = currentUser.username;
        document.getElementById("sidebar-username").textContent = currentUser.username;
        
        // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· avatar Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î·
        loadCurrentUserAvatar();
        
        // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· offline notifications ÏŒÏ„Î±Î½ ÏƒÏ…Î½Î´Î­ÎµÏ„Î±Î¹
        setTimeout(() => {
            loadOfflineNotifications();
        }, 1000);
        
    } else {
        loggedOutNav.style.display = "flex";
        loggedInNav.style.display = "none";
        homeCTALoggedOut.style.display = "block";
        homeCTALoggedIn.style.display = "none";
        localStorage.removeItem("ratroom_last_page");
    }
}

function addMessageToChat(message) {
    const messagesContainer = document.getElementById("messages-container");
    const messageDiv = document.createElement("div");
    const isOwn = message.sender === currentUser.username;

    messageDiv.className = `message ${isOwn ? "own" : "other"}`;
    
    // Î•Î¹Î´Î¹ÎºÎ® ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î³Î¹Î± Î±ÏÏ‡ÎµÎ¯Î±
    if (message.isFile) {
        const fileExtension = message.fileName ? message.fileName.split('.').pop().toLowerCase() : '';
        const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(fileExtension);
        
        if (isImage && message.fileUrl) {
            // Î•Î¹ÎºÏŒÎ½Î± - ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ· preview
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-sender">${message.sender}</span>
                    <span class="message-time">${message.time || getCurrentTime()}</span>
                </div>
                <div class="message-file">
                    <div class="file-preview">
                        <img src="${message.fileUrl}" alt="${message.fileName}" class="file-image-preview" onclick="openImagePreview('${message.fileUrl}')">
                        <div class="file-info">
                            <span class="file-name">${message.fileName}</span>
                            <a href="${message.fileUrl}" download="${message.fileName}" class="file-download-btn">
                                <i class="fas fa-download"></i> Download
                            </a>
                        </div>
                    </div>
                </div>
            `;
        } else {
            // Î†Î»Î»Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ - Î¼ÏŒÎ½Î¿ download link
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-sender">${message.sender}</span>
                    <span class="message-time">${message.time || getCurrentTime()}</span>
                </div>
                <div class="message-file">
                    <div class="file-item">
                        <i class="fas fa-file"></i>
                        <div class="file-details">
                            <span class="file-name">${message.fileName}</span>
                            <a href="${message.fileUrl}" download="${message.fileName}" class="file-download-link">
                                <i class="fas fa-download"></i> ÎšÎ±Ï„Î­Î²Î±ÏƒÎ¼Î±
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }
    } else {
        // ÎšÎ±Î½Î¿Î½Î¹ÎºÏŒ Î¼Î®Î½Ï…Î¼Î± ÎºÎµÎ¹Î¼Î­Î½Î¿Ï…
        messageDiv.innerHTML = `
            <div class="message-header">
                <span class="message-sender">${message.sender}</span>
                <span class="message-time">${message.time || getCurrentTime()}</span>
            </div>
            <div class="message-text">${message.text}</div>
        `;
    }

    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Î£Ï…Î½Î¬ÏÏ„Î·ÏƒÎ· Î³Î¹Î± Ï€ÏÎ¿Î²Î¿Î»Î® ÎµÎ¹ÎºÏŒÎ½Î±Ï‚ ÏƒÎµ Ï€Î»Î®ÏÎ· Î¿Î¸ÏŒÎ½Î·
function openImagePreview(imageUrl) {
    const modal = document.createElement('div');
    modal.className = 'image-preview-modal active';
    modal.innerHTML = `
        <div class="image-preview-content">
            <button class="close-image-preview" onclick="closeImagePreview()">Ã—</button>
            <img src="${imageUrl}" alt="Preview" class="full-size-image">
            <div class="image-actions">
                <a href="${imageUrl}" download class="btn btn-primary">
                    <i class="fas fa-download"></i> ÎšÎ±Ï„Î­Î²Î±ÏƒÎ¼Î±
                </a>
                <button class="btn btn-secondary" onclick="closeImagePreview()">
                    <i class="fas fa-times"></i> ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';
}

function closeImagePreview() {
    const modal = document.querySelector('.image-preview-modal');
    if (modal) {
        modal.remove();
        document.body.style.overflow = '';
    }
}

function updateRoomMembers(members) {
    const membersList = document.getElementById("room-members-list");
    membersList.innerHTML = "";

    members.forEach(async (member) => {
        const memberDiv = document.createElement("div");
        memberDiv.className = "member-item";
        memberDiv.dataset.username = member.username;
        
        // Î‘ÏÏ‡Î¹ÎºÎ¬ Î²Î¬Î¶Î¿Ï…Î¼Îµ initials
        memberDiv.innerHTML = `
            <div class="member-avatar">${member.username.substring(0, 2).toUpperCase()}</div>
            <div class="member-info">
                <span class="member-name">${member.username}</span>
                <span class="member-joined">${new Date(member.joined_at).toLocaleDateString()}</span>
            </div>
        `;
        
        // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· click event Î³Î¹Î± Î½Î± Î±Î½Î¿Î¯Î³ÎµÎ¹ Ï„Î¿ user info modal
        memberDiv.addEventListener("click", (e) => {
            e.stopPropagation();
            showUserInfo(member.username);
        });
        
        membersList.appendChild(memberDiv);
        
        // ğŸ”¥ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï„Î¿Ï… Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÎ¿Ï avatar Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹
        const avatarElement = memberDiv.querySelector('.member-avatar');
        if (avatarElement) {
            await loadUserAvatar(member.username, avatarElement, member.username === currentUser.username);
        }
    });
}

function loadUserRooms() {
    if (!currentUser.authenticated) return;

    fetch(`/user-rooms/${currentUser.username}`, {
            headers: {
                "X-Session-ID": currentUser.sessionId,
            },
        })
        .then((res) => {
            if (!res.ok) throw new Error("Session expired");
            return res.json();
        })
        .then((data) => {
            if (data.success) {
                displayUserRooms(data.rooms);
            }
        })
        .catch((error) => {
            console.error("Error loading rooms:", error);
            if (error.message === "Session expired") {
                handleSessionExpired();
            }
        });
}

function displayUserRooms(rooms) {
    const roomsList = document.getElementById("rooms-list");
    roomsList.innerHTML = "";

    if (rooms.length === 0) {
        roomsList.innerHTML = `
            <div class="no-rooms">
                <p>You haven't joined any rooms yet.</p>
                <p>Create a new room or join with an invite code!</p>
            </div>
        `;
        return;
    }

    rooms.forEach((room) => {
        const roomCard = document.createElement("div");
        roomCard.className = "room-card";
        roomCard.innerHTML = `
            <div class="room-card-header">
                <h3>${room.name}</h3>
                <span class="room-invite-code">${room.invite_code}</span>
            </div>
            <div class="room-card-footer">
                <span class="room-created">Created ${new Date(room.created_at).toLocaleDateString()}</span>
                <button class="btn btn-primary btn-sm enter-room-btn" data-room-id="${room.id}">Enter Room</button>
            </div>
        `;

        roomCard.querySelector(".enter-room-btn").addEventListener("click", () => {
            enterRoom(room.id, room.name, room.invite_code);
            
            // Clear unread ÏŒÏ„Î±Î½ Î¼Ï€Î±Î¯Î½ÎµÎ¹Ï‚ ÏƒÏ„Î¿ room
            clearUnread('group', null, room.id);
        });

        roomsList.appendChild(roomCard);
    });
    
    // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· badges Î¼ÎµÏ„Î¬ Ï„Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ·
    updateRoomsListBadges();
}

function enterRoom(roomId, roomName, inviteCode) {
    console.log("ğŸš€ Entering room:", { roomId, roomName, inviteCode });
    
    currentRoom = { 
        id: roomId, 
        name: roomName, 
        inviteCode: inviteCode,
        isPrivate: false 
    };

    // Update UI
    document.getElementById("room-name-sidebar").textContent = roomName;
    document.getElementById("room-name-header").textContent = roomName;
    
    // ğŸ”¥ Î“Î™Î‘ ÎšÎ‘ÎÎŸÎÎ™ÎšÎ‘ ROOMS - Î•ÎœÎ¦Î‘ÎÎ™Î–ÎŸÎ¥ÎœÎ• ÎÎŸÎ¡ÎœÎ‘Î› Î¤ÎŸ INVITE CODE
    document.getElementById("room-invite-code").textContent = inviteCode;
    
    // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Ï„Î¿Ï… invite code section
    document.getElementById("invite-code-container").classList.remove("hide-for-private");
    
    // Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Ï„Î¿ copy button Î³Î¹Î± ÎºÎ±Î½Î¿Î½Î¹ÎºÎ¬ rooms
    document.getElementById("copy-invite-btn").style.display = "flex";
    document.getElementById("copy-invite-btn").disabled = false;
    document.getElementById("copy-invite-btn").title = "Copy invite code";
    document.getElementById("copy-invite-btn").style.opacity = "1";
    document.getElementById("copy-invite-btn").style.cursor = "pointer";

    // Clear messages
    document.getElementById("messages-container").innerHTML = "";

    // Emit join room
    console.log("ğŸ“¡ Emitting join room event...");
    
    socket.emit("join room", {
        roomId: roomId,
        username: currentUser.username,
        sessionId: currentUser.sessionId,
    });

    showPage("chat-page");
    
    // ğŸ”¥ Î£Î—ÎœÎ‘ÎÎ¤Î™ÎšÎŸ: Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï„Î·Ï‚ ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚
    saveChatState();
    
    // ğŸ”¥ Î£Î—ÎœÎ‘ÎÎ¤Î™ÎšÎŸ: Request room data Î±Î¼Î­ÏƒÏ‰Ï‚
    // ÎšÎ¬Î½Î¿Ï…Î¼Îµ Ï„Î± requests Î¼Î±Î¶Î¯ Î³Î¹Î± Î½Î± Î±Ï€Î¿Ï†ÏÎ³Î¿Ï…Î¼Îµ race conditions
    socket.emit("get room info", { roomId: roomId });
    socket.emit("get room members", { roomId: roomId });
    
    // ğŸ”¥ Î•Î Î™Î Î›Î•ÎŸÎ: ÎšÎ¬Î½Î¿Ï…Î¼Îµ Î­Î½Î± Î´ÎµÏÏ„ÎµÏÎ¿ request Î¼ÎµÏ„Î¬ Î±Ï€ÏŒ 500ms Î³Î¹Î± Î½Î± ÎµÎ¯Î¼Î±ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹
    setTimeout(() => {
        socket.emit("get room members", { roomId: roomId });
    }, 500);
}

// ===== FRIENDS SYSTEM FUNCTIONS =====

async function loadUserFriends() {
    if (!currentUser.authenticated) return;

    try {
        const [friendsResponse, pendingResponse] = await Promise.all([
            fetch(`/friends/${currentUser.username}`, {
                headers: {
                    "X-Session-ID": currentUser.sessionId,
                },
            }),
            fetch(`/pending-requests/${currentUser.username}`, {
                headers: {
                    "X-Session-ID": currentUser.sessionId,
                },
            }),
        ]);

        if (!friendsResponse.ok || !pendingResponse.ok) {
            throw new Error("Session expired");
        }

        const friendsData = await friendsResponse.json();
        const pendingData = await pendingResponse.json();

        if (friendsData.success && pendingData.success) {
            displayUserFriends(friendsData.friends, pendingData.requests);
            document.getElementById("display-my-username").textContent = currentUser.username;
        }
    } catch (error) {
        console.error("Error loading friends:", error);
        if (error.message === "Session expired") {
            handleSessionExpired();
        }
    }
}

function displayUserFriends(friends, pendingRequests) {
    const friendsList = document.getElementById("friends-list");
    friendsList.innerHTML = "";

    if (pendingRequests.length > 0) {
        const pendingSection = document.createElement("div");
        pendingSection.className = "friends-section";
        pendingSection.innerHTML = `
            <h3>Pending Friend Requests</h3>
            <div class="pending-requests-list">
                ${pendingRequests
                  .map(
                    (request) => `
                    <div class="friend-card pending">
                        <div class="friend-info">
                            <div class="friend-avatar">${request.friend_username.substring(0, 2).toUpperCase()}</div>
                            <div class="friend-details">
                                <span class="friend-name">${request.friend_username}</span>
                                <span class="friend-since">Request sent ${new Date(request.created_at).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div class="friend-actions">
                            <button class="btn btn-success btn-sm accept-request-btn" data-friend="${request.friend_username}">âœ“ Accept</button>
                            <button class="btn btn-danger btn-sm decline-request-btn" data-friend="${request.friend_username}">âœ— Decline</button>
                        </div>
                    </div>
                `
                  )
                  .join("")}
            </div>
        `;
        friendsList.appendChild(pendingSection);

        pendingSection.querySelectorAll(".accept-request-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                const friendUsername = e.target.dataset.friend;
                handleRespondToFriendRequest(friendUsername, true);
            });
        });

        pendingSection.querySelectorAll(".decline-request-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                const friendUsername = e.target.dataset.friend;
                handleRespondToFriendRequest(friendUsername, false);
            });
        });
    }

    const friendsSection = document.createElement("div");
    friendsSection.className = "friends-section";

    if (friends.length === 0 && pendingRequests.length === 0) {
        friendsSection.innerHTML = `
            <div class="no-friends">
                <p>You haven't added any friends yet.</p>
                <p>Add friends to start private conversations!</p>
            </div>
        `;
    } else if (friends.length > 0) {
        friendsSection.innerHTML = `
            <h3>Your Friends (${friends.length})</h3>
            <div class="friends-list">
                ${friends
                  .map(
                    (friend) => `
                    <div class="friend-card">
                        <div class="friend-info">
                            <div class="friend-avatar">${friend.friend_username.substring(0, 2).toUpperCase()}</div>
                            <div class="friend-details">
                                <span class="friend-name">${friend.friend_username}</span>
                                <span class="friend-since">Friends since ${new Date(friend.created_at).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div class="friend-actions">
                            <button class="btn btn-primary btn-sm chat-friend-btn" data-friend="${friend.friend_username}">ğŸ’¬ Chat</button>
                            <button class="btn btn-danger btn-sm remove-friend-btn" data-friend="${friend.friend_username}">Remove</button>
                        </div>
                    </div>
                `
                  )
                  .join("")}
            </div>
        `;

        // ğŸ”¥ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· avatars Î³Î¹Î± Ï„Î¿Ï…Ï‚ Ï†Î¯Î»Î¿Ï…Ï‚
        friendsSection.querySelectorAll(".friend-avatar").forEach(async (avatarElement, index) => {
            const friend = friends[index];
            if (friend) {
                await loadUserAvatar(friend.friend_username, avatarElement, false);
            }
        });

        friendsSection.querySelectorAll(".chat-friend-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                const friendUsername = e.target.dataset.friend;
                startPrivateChatWithFriend(friendUsername);
                
                // Clear unread ÏŒÏ„Î±Î½ Î±Î½Î¿Î¯Î³ÎµÎ¹Ï‚ chat
                clearUnread('private', friendUsername);
            });
        });

        friendsSection.querySelectorAll(".remove-friend-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                const friendUsername = e.target.dataset.friend;
                showConfirmationModal(
                    `Remove ${friendUsername} from friends?`,
                    "Remove Friend",
                    () => handleRemoveFriend(friendUsername)
                );
            });
        });
    }

    friendsList.appendChild(friendsSection);
    
    // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· badges Î¼ÎµÏ„Î¬ Ï„Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ·
    updateFriendsListBadges();
}

// ===== FRIENDS SYSTEM FUNCTIONS - FIXED =====

async function handleAddFriend(friendUsername) {
    const trimmedUsername = friendUsername.trim();
    
    if (!trimmedUsername) {
        showNotification("Please enter a username!", "warning", "Missing Info");
        return;
    }

    if (trimmedUsername.toLowerCase() === currentUser.username.toLowerCase()) {
        showNotification("You cannot add yourself as a friend!", "warning", "Invalid Action");
        return;
    }

    try {
        const response = await fetch("/send-friend-request", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-Session-ID": currentUser.sessionId,
            },
            body: JSON.stringify({
                fromUser: currentUser.username,
                toUser: trimmedUsername,
            }),
        });

        const data = await response.json();

        if (response.ok && data.success) {
            showNotification(data.message, "success", "Friend Request Sent");
            hideAllModals();
            document.getElementById("friend-username-input").value = "";
            loadUserFriends();
        } else {
            let errorMessage = data.error || "Failed to send friend request";
            let errorTitle = "Friend Request Failed";

            if (response.status === 404) {
                errorMessage = `User "${trimmedUsername}" does not exist!`;
                errorTitle = "User Not Found";
            } else if (response.status === 400) {
                if (data.error.includes("Already friends")) {
                    errorTitle = "Already Friends";
                } else if (data.error.includes("already sent")) {
                    errorTitle = "Request Already Sent";
                }
            } else if (response.status === 401) {
                handleSessionExpired();
                return;
            }

            showNotification(errorMessage, "error", errorTitle);
        }
    } catch (error) {
        console.error("Error sending friend request:", error);
        showNotification(
            "Connection error. Please check your internet and try again.",
            "error",
            "Connection Error"
        );
    }
}

async function handleRespondToFriendRequest(friendUsername, accept) {
    try {
        const response = await fetch("/respond-friend-request", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-Session-ID": currentUser.sessionId,
            },
            body: JSON.stringify({
                username: currentUser.username,
                friendUsername: friendUsername,
                accept: accept,
            }),
        });

        if (!response.ok) {
            throw new Error("Session expired");
        }

        const data = await response.json();

        if (data.success) {
            showNotification(data.message, "success", accept ? "Friend Added" : "Request Declined");
            loadUserFriends();
        } else {
            showNotification(data.error || "Failed to respond to request", "error", "Action Failed");
        }
    } catch (error) {
        if (error.message === "Session expired") {
            handleSessionExpired();
        } else {
            showNotification(
                "Error responding to request: " + error.message,
                "error",
                "Connection Error"
            );
        }
    }
}

async function handleRemoveFriend(friendUsername) {
    try {
        const response = await fetch("/remove-friend", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-Session-ID": currentUser.sessionId,
            },
            body: JSON.stringify({
                username: currentUser.username,
                friendUsername: friendUsername,
            }),
        });

        if (!response.ok) {
            throw new Error("Session expired");
        }

        const data = await response.json();

        if (data.success) {
            showNotification("Friend removed", "info", "Friend Removed");
            loadUserFriends();
        } else {
            showNotification(data.error || "Failed to remove friend", "error", "Action Failed");
        }
    } catch (error) {
        if (error.message === "Session expired") {
            handleSessionExpired();
        } else {
            showNotification("Error removing friend: " + error.message, "error", "Connection Error");
        }
    }
}

function startPrivateChatWithFriend(friendUsername) {
    // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î¼Î¿Î½Î±Î´Î¹ÎºÎ¿Ï ÎºÏ‰Î´Î¹ÎºÎ¿Ï Î³Î¹Î± Ï„Î¿ private chat Î§Î©Î¡Î™Î£ invite code
    const privateChatId = `private_${currentUser.username}_${friendUsername}`;
    
    currentRoom = {
        id: privateChatId,
        name: friendUsername,
        inviteCode: null,
        isPrivate: true,
    };

    document.getElementById("room-name-sidebar").textContent = friendUsername;
    document.getElementById("room-name-header").textContent = `Private Chat with ${friendUsername}`;
    
    // ğŸ”¥ Î‘Î¥Î¤ÎŸ Î•Î™ÎÎ‘Î™ Î¤ÎŸ ÎšÎ¥Î¡Î™ÎŸ Î¦Î™Î - ÎšÎ¡Î¥Î’ÎŸÎ¥ÎœÎ• ÎŸÎ›ÎŸÎšÎ›Î—Î¡ÎŸ Î¤ÎŸ INVITE CODE SECTION
    document.getElementById("room-invite-code").textContent = "";
    document.getElementById("invite-code-container").classList.add("hide-for-private");
    
    // Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ ÎµÎ½Ï„ÎµÎ»ÏÏ‚ Ï„Î¿ copy button Î³Î¹Î± private chats
    document.getElementById("copy-invite-btn").style.display = "none";
    
    document.getElementById("sidebar-username").textContent = currentUser.username;
    
    // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï„Î¿Ï… avatar Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î·
    const sidebarAvatar = document.getElementById("sidebar-avatar");
    if (sidebarAvatar) {
        loadUserAvatar(currentUser.username, sidebarAvatar, true);
    }

    document.getElementById("room-description").textContent =
        `Private conversation with ${friendUsername}`;
    document.getElementById("room-status").textContent = "Private chat";
    document.getElementById("room-status").classList.add("private-chat");

    // Make the private chat members clickable too
    document.getElementById("room-members-list").innerHTML = `
        <div class="member-item" data-username="${currentUser.username}">
            <div class="member-avatar"></div>
            <div class="member-info">
                <span class="member-name">${currentUser.username}</span>
                <span class="member-joined">You</span>
            </div>
        </div>
        <div class="member-item" data-username="${friendUsername}">
            <div class="member-avatar"></div>
            <div class="member-info">
                <span class="member-name">${friendUsername}</span>
                <span class="member-joined">Friend</span>
            </div>
        </div>
    `;

    document.getElementById("messages-container").innerHTML = "";
    loadPrivateMessages(friendUsername);
    showPage("chat-page");
    
    // ğŸ”¥ Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï„Î·Ï‚ ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚
    saveChatState();
    
    // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· avatars Î³Î¹Î± Ï„Î± Î¼Î­Î»Î·
    setTimeout(() => {
        loadMemberAvatars();
        makeMemberItemsClickable();
    }, 100);
}

async function loadPrivateMessages(friendUsername) {
    try {
        const response = await fetch(`/private-messages/${currentUser.username}/${friendUsername}`, {
            headers: {
                "X-Session-ID": currentUser.sessionId,
            },
        });

        if (!response.ok) {
            throw new Error("Session expired");
        }

        const data = await response.json();

        if (data.success) {
            const messagesContainer = document.getElementById("messages-container");
            messagesContainer.innerHTML = "";
            data.messages.forEach((msg) => addMessageToChat(msg));
        }
    } catch (error) {
        if (error.message === "Session expired") {
            handleSessionExpired();
        } else {
            console.error("Error loading private messages:", error);
        }
    }
}

// ===== USER INFO SYSTEM FUNCTIONS =====

async function showUserInfo(username) {
    if (!username || username === currentUser.username) return;
    
    currentViewedUser = username;
    
    try {
        // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î²Î±ÏƒÎ¹ÎºÏÎ½ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½ Ï‡ÏÎ®ÏƒÏ„Î·
        const response = await fetch(`/user-info/${username}`, {
            headers: {
                "X-Session-ID": currentUser.sessionId,
            },
        });
        
        if (!response.ok) {
            if (response.status === 401) {
                handleSessionExpired();
                return;
            }
            throw new Error(`Server returned ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            updateUserInfoModal(data.user);
            showModal("user-info-modal");
            
            // Check friendship status
            await checkFriendshipStatus(username);
        } else {
            showNotification(data.error || "Could not load user information", "error", "Error");
        }
    } catch (error) {
        console.error("Error loading user info:", error);
        showNotification("Could not load user information. Please try again.", "error", "Error");
    }
}

async function checkFriendshipStatus(friendUsername) {
    try {
        const response = await fetch(`/check-friendship/${currentUser.username}/${friendUsername}`, {
            headers: {
                "X-Session-ID": currentUser.sessionId,
            },
        });
        
        if (response.ok) {
            const data = await response.json();
            const addFriendBtn = document.getElementById("add-as-friend-btn");
            
            if (data.success) {
                if (data.areFriends) {
                    addFriendBtn.style.display = 'none';
                } else if (data.hasPendingRequest) {
                    addFriendBtn.innerHTML = '<i class="fas fa-clock"></i> Request Pending';
                    addFriendBtn.disabled = true;
                    addFriendBtn.style.display = 'block';
                } else {
                    addFriendBtn.innerHTML = '<i class="fas fa-user-plus"></i> Add Friend';
                    addFriendBtn.disabled = false;
                    addFriendBtn.style.display = 'block';
                }
            }
        }
    } catch (error) {
        console.error("Error checking friendship status:", error);
        // ÎœÎ·Î½ ÎµÎ¼Ï†Î±Î½Î¯ÏƒÎµÎ¹Ï‚ error, Î±Ï€Î»Î¬ Î¼Î·Î½ Î´ÎµÎ¯Î¾ÎµÎ¹Ï‚ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯
        const addFriendBtn = document.getElementById("add-as-friend-btn");
        addFriendBtn.style.display = 'none';
    }
}

function updateUserInfoModal(user) {
    document.getElementById("user-info-title").textContent = `${user.username}'s Profile`;
    document.getElementById("user-info-username").textContent = user.username;
    document.getElementById("user-info-status").textContent = user.status || "Offline";
    document.getElementById("user-info-status").className = `info-value status-${user.status?.toLowerCase() || 'offline'}`;
    
    if (user.created_at) {
        const joinedDate = new Date(user.created_at).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        document.getElementById("user-info-joined").textContent = joinedDate;
    } else {
        document.getElementById("user-info-joined").textContent = "Unknown";
    }
    
    // Profile picture
    const userInfoImage = document.getElementById("user-info-image");
    if (user.profile_picture) {
        // ğŸ”¥ Î•Î”Î© Î‘Î›Î›Î‘Î“Î—: Î§ÏÎ®ÏƒÎ· Base64 string Î±Ï€ÎµÏ…Î¸ÎµÎ¯Î±Ï‚
        userInfoImage.src = user.profile_picture;
        userInfoImage.style.display = 'block';
    } else {
        // Default avatar Î±Î½ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÎ¹ÎºÏŒÎ½Î±
        const initials = user.username.substring(0, 2).toUpperCase();
        const color = getAvatarColor(user.username);
        userInfoImage.style.display = 'none';
        
        // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± div Î³Î¹Î± initials
        const avatarContainer = userInfoImage.parentElement;
        let initialsDiv = avatarContainer.querySelector('.initials-avatar');
        if (!initialsDiv) {
            initialsDiv = document.createElement('div');
            initialsDiv.className = 'initials-avatar';
            initialsDiv.style.cssText = `
                width: 100%;
                height: 100%;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 2rem;
                color: white;
            `;
            avatarContainer.appendChild(initialsDiv);
        }
        initialsDiv.textContent = initials;
        initialsDiv.style.background = color;
    }
    
    const addFriendBtn = document.getElementById("add-as-friend-btn");
    const sendMessageBtn = document.getElementById("send-private-message-btn");
    
    if (user.username === currentUser.username) {
        addFriendBtn.style.display = 'none';
        sendMessageBtn.disabled = true;
        sendMessageBtn.innerHTML = '<i class="fas fa-user"></i> This is you';
        sendMessageBtn.classList.remove("btn-primary");
        sendMessageBtn.classList.add("btn-secondary");
    } else {
        // Î‘ÏÏ‡Î¹ÎºÎ¬ ÎºÏÏÏˆÎµ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ Î¼Î­Ï‡ÏÎ¹ Î½Î± ÎµÎ»ÎµÎ³Ï‡Î¸ÎµÎ¯ Î· Ï†Î¹Î»Î¯Î±
        addFriendBtn.style.display = 'none';
        sendMessageBtn.disabled = false;
        sendMessageBtn.innerHTML = '<i class="fas fa-comment"></i> Send Message';
        sendMessageBtn.classList.remove("btn-secondary");
        sendMessageBtn.classList.add("btn-primary");
    }
}

// Make member items clickable for user info
function makeMemberItemsClickable() {
    const memberItems = document.querySelectorAll(".member-item");
    memberItems.forEach(item => {
        item.style.cursor = "pointer";
        
        item.addEventListener("mouseenter", function() {
            this.style.backgroundColor = "rgba(51, 51, 51, 0.5)";
            this.style.transform = "translateX(5px)";
        });
        
        item.addEventListener("mouseleave", function() {
            this.style.backgroundColor = "";
            this.style.transform = "";
        });
        
        item.addEventListener("click", function(e) {
            e.stopPropagation();
            const username = this.dataset.username || this.querySelector(".member-name")?.textContent;
            if (username) {
                showUserInfo(username);
            }
        });
    });
}

// ===== AUTHENTICATION FUNCTIONS =====

async function handleLogin(email, password) {
    try {
        const response = await fetch("/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
        });

        const data = await response.json();

        if (data.success) {
            currentUser = {
                username: data.user.username,
                email: data.user.email,
                authenticated: true,
                sessionId: data.sessionId,
            };

            saveUserToLocalStorage(currentUser);
            updateUIForAuthState();
            hideAllModals();
            showNotification("Welcome back, " + currentUser.username + "!", "success", "Welcome!");

            socket.emit("authenticate", {
                username: currentUser.username,
                sessionId: currentUser.sessionId,
            });

            loadUserRooms();
        } else {
            showNotification(data.error || "Login failed", "error", "Login Error");
        }
    } catch (error) {
        showNotification("Login error: " + error.message, "error", "Connection Error");
    }
}

async function handleRegister(email, username, password, confirmPassword) {
    if (password !== confirmPassword) {
        showNotification("Passwords do not match!", "error", "Registration Error");
        return;
    }

    try {
        const formData = new FormData();
        formData.append("email", email);
        formData.append("username", username);
        formData.append("password", password);
        
        const avatarInput = document.getElementById("register-avatar-input");
        if (avatarInput.files[0]) {
            formData.append("avatar", avatarInput.files[0]);
        }
        
        const response = await fetch("/register", {
            method: "POST",
            body: formData,
        });

        const data = await response.json();

        if (data.success) {
            showNotification("Account created! Please login.", "success", "Registration Successful");
            hideAllModals();
            showModal("login-modal");
        } else {
            showNotification(data.error || "Registration failed", "error", "Registration Error");
        }
    } catch (error) {
        showNotification("Registration error: " + error.message, "error", "Connection Error");
    }
}

function handleLogout() {
    if (currentUser.authenticated) {
        fetch("/logout", {
            method: "POST",
            headers: {
                "X-Session-ID": currentUser.sessionId,
            },
            body: JSON.stringify({
                username: currentUser.username,
            }),
        }).catch((error) => {
            console.error("Logout error:", error);
        });
    }

    currentUser = { username: null, email: null, authenticated: false, sessionId: null };
    currentRoom = { id: null, name: null, inviteCode: null, isPrivate: false };
    
    // Clear local unread data
    unreadMessages = { private: {}, groups: {}, total: 0 };
    updateUnreadBadges();
    
    // Clear avatar cache
    userAvatars = {};
    
    clearUserFromLocalStorage();
    clearChatState(); // ğŸ”¥ ÎšÎ‘Î™ÎÎŸÎ¥Î¡Î“Î™ÎŸ: ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ chat state
    updateUIForAuthState();
    showPage("home-page");
    showNotification("Logged out successfully!", "info", "Goodbye!");

    socket.disconnect();
    socket.connect();
}

function handleSessionExpired() {
    showNotification("Session expired. Please login again.", "error", "Session Expired");
    handleLogout();
}

// ===== ROOM FUNCTIONS =====

async function handleCreateRoom(roomName) {
    if (!roomName.trim()) {
        showNotification("Please enter a room name!", "warning", "Missing Info");
        return;
    }

    try {
        const response = await fetch("/create-room", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-Session-ID": currentUser.sessionId,
            },
            body: JSON.stringify({ name: roomName, username: currentUser.username }),
        });

        if (!response.ok) {
            throw new Error("Session expired");
        }

        const data = await response.json();

        if (data.success) {
            showNotification(`Room created! Invite code: ${data.inviteCode}`, "success", "Room Created");
            hideAllModals();
            document.getElementById("room-name-input").value = "";
            enterRoom(data.roomId, roomName, data.inviteCode);
        } else {
            showNotification(data.error || "Failed to create room", "error", "Room Creation Failed");
        }
    } catch (error) {
        if (error.message === "Session expired") {
            handleSessionExpired();
        } else {
            showNotification("Error creating room: " + error.message, "error", "Connection Error");
        }
    }
}

async function handleJoinRoom(inviteCode) {
    if (!inviteCode.trim()) {
        showNotification("Please enter an invite code!", "warning", "Missing Info");
        return;
    }

    try {
        const response = await fetch("/join-room", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-Session-ID": currentUser.sessionId,
            },
            body: JSON.stringify({
                inviteCode: inviteCode.trim(),
                username: currentUser.username,
            }),
        });

        // Î Î‘Î¡Î‘Î£Î—ÎœÎ‘ÎÎ¤Î™ÎšÎŸ: Î”ÎµÎ½ ÎºÎ¬Î½Î¿Ï…Î¼Îµ throw error Î³Î¹Î± 404 Ï€Î¹Î±!
        // Î‘Ï€Î»Î¬ Ï€Î±Î¯ÏÎ½Î¿Ï…Î¼Îµ Ï„Î¿ JSON response
        const data = await response.json();

        if (data.success) {
            showNotification("Joined room successfully!", "success", "Room Joined");
            hideAllModals();
            document.getElementById("invite-code-input").value = "";
            enterRoom(data.roomId, data.roomName, inviteCode.trim());
        } else {
            // Î‘Ï€Î»Î¬ Î´ÎµÎ¯Ï‡Î½Î¿Ï…Î¼Îµ Ï„Î¿ Î¼Î®Î½Ï…Î¼Î± Î»Î¬Î¸Î¿Ï…Ï‚
            showNotification(data.error || "Failed to join room", "error", "Join Room Failed");
        }
    } catch (error) {
        // Î‘Ï…Ï„ÏŒ Ï„Î¿ catch Ï„ÏÏÎ± Î¸Î± Ï€Î¹Î¬ÏƒÎµÎ¹ Î¼ÏŒÎ½Î¿ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÎ¬ network errors
        console.error("Error joining room:", error);
        showNotification("Connection error. Please try again.", "error", "Connection Error");
    }
}

// ğŸ”¥ FIXED: LEAVE ROOM FUNCTION - WITH FRIEND REMOVAL FOR PRIVATE CHATS
async function handleLeaveRoom() {
    // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ ÎµÎ¯Î¼Î±ÏƒÏ„Îµ ÏƒÎµ private chat Î® ÎºÎ±Î½Î¿Î½Î¹ÎºÏŒ room
    if (!currentRoom.id) {
        showNotification("You are not in a room", "info", "No Room");
        return;
    }
    
    if (currentRoom.isPrivate) {
        // Î“Î¹Î± private chats - Î‘Î¦Î‘Î™Î¡Î•Î£Î— Î¦Î™Î›ÎŸÎ¥
        const friendUsername = currentRoom.name;
        
        showConfirmationModal(
            `Are you sure you want to leave the private chat with ${friendUsername} and remove them as friend?`,
            "Leave Private Chat",
            async () => {
                try {
                    // 1. Î‘Ï†Î±Î¯ÏÎµÏƒÎ· Ï†Î¯Î»Î¿Ï…
                    const response = await fetch("/remove-friend", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-Session-ID": currentUser.sessionId,
                        },
                        body: JSON.stringify({
                            username: currentUser.username,
                            friendUsername: friendUsername,
                        }),
                    });

                    if (!response.ok) {
                        throw new Error("Failed to remove friend");
                    }

                    const data = await response.json();

                    if (data.success) {
                        // 2. Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î· ÏƒÎµÎ»Î¯Î´Î± Ï†Î¯Î»Ï‰Î½
                        showNotification(
                            `Left private chat with ${friendUsername} and removed as friend`,
                            "info",
                            "Chat Closed"
                        );
                        
                        showPage("friends-page");
                        loadUserFriends();
                        
                        // 3. Reset current room
                        currentRoom = { id: null, name: null, inviteCode: null, isPrivate: false };
                        
                        // 4. Clear chat state
                        clearChatState();
                        
                        // 5. Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ UI
                        document.getElementById("room-name-sidebar").textContent = "RatScape";
                        document.getElementById("room-name-header").textContent = "Room Name";
                        document.getElementById("room-invite-code").textContent = "------";
                        document.getElementById("room-description").textContent = "Group chat";
                        document.getElementById("room-status").textContent = "Not in a room";
                        document.getElementById("room-status").classList.remove("private-chat");
                        
                        // 6. Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ Ï„Î¿Ï… invite code section
                        document.getElementById("invite-code-container").classList.remove("hide-for-private");
                        document.getElementById("copy-invite-btn").style.display = "flex";
                        document.getElementById("copy-invite-btn").disabled = false;
                        
                        // 7. Clear messages
                        document.getElementById("messages-container").innerHTML = "";
                        
                        // 8. Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· unread messages
                        clearUnread('private', friendUsername);
                    } else {
                        showNotification(data.error || "Failed to remove friend", "error", "Action Failed");
                    }
                } catch (error) {
                    console.error("Error leaving private chat:", error);
                    showNotification("Error: " + error.message, "error", "Connection Error");
                    
                    // Î‘ÎºÏŒÎ¼Î± ÎºÎ¹ Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ error, ÎµÏ€Î­ÏƒÏ„ÏÎµÏˆÎµ ÏƒÏ„Î· ÏƒÎµÎ»Î¯Î´Î± friends
                    showPage("friends-page");
                    loadUserFriends();
                    
                    // Reset current room
                    currentRoom = { id: null, name: null, inviteCode: null, isPrivate: false };
                    clearChatState();
                }
            },
            () => {
                // User cancelled
                console.log("User cancelled leaving private chat");
            }
        );
        return;
    }
    
    // Î“Î¹Î± ÎºÎ±Î½Î¿Î½Î¹ÎºÎ¬ rooms, Î¶Î®Ï„Î·ÏƒÎ· ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·Ï‚
    showConfirmationModal(
        "Are you sure you want to leave this room? You can rejoin anytime with the invite code.",
        "Leave Room",
        async () => {
            try {
                const response = await fetch("/leave-room", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-Session-ID": currentUser.sessionId,
                    },
                    body: JSON.stringify({
                        roomId: currentRoom.id,
                        username: currentUser.username,
                    }),
                });

                if (!response.ok) {
                    throw new Error("Failed to leave room");
                }

                const data = await response.json();

                if (data.success) {
                    showNotification("Left room successfully!", "success", "Room Left");
                    
                    // ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ WebSocket connection Î³Î¹Î± Î±Ï…Ï„ÏŒ Ï„Î¿ room
                    if (currentRoom.id) {
                        socket.emit("leave_room", {
                            roomId: currentRoom.id,
                            username: currentUser.username
                        });
                    }
                    
                    // Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î· ÏƒÎµÎ»Î¯Î´Î± rooms
                    showPage("rooms-page");
                    loadUserRooms();
                    
                    // Reset current room
                    currentRoom = { id: null, name: null, inviteCode: null, isPrivate: false };
                    
                    // Clear chat state
                    clearChatState();
                    
                    // Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ UI ÏƒÏ„Î¿ default state
                    document.getElementById("room-name-sidebar").textContent = "RatScape";
                    document.getElementById("room-name-header").textContent = "Room Name";
                    document.getElementById("room-invite-code").textContent = "------";
                    document.getElementById("room-description").textContent = "Group chat";
                    document.getElementById("room-status").textContent = "Not in a room";
                    document.getElementById("room-status").classList.remove("private-chat");
                    
                    // Clear messages
                    document.getElementById("messages-container").innerHTML = "";
                    
                    // Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ Ï„Î¿Ï… invite code section
                    document.getElementById("invite-code-container").classList.remove("hide-for-private");
                    document.getElementById("copy-invite-btn").style.display = "flex";
                    document.getElementById("copy-invite-btn").disabled = false;
                    
                    // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· unread messages
                    clearUnread('group', null, currentRoom.id);
                    
                } else {
                    showNotification(data.error || "Failed to leave room", "error", "Action Failed");
                }
            } catch (error) {
                console.error("Error leaving room:", error);
                showNotification("Error leaving room: " + error.message, "error", "Connection Error");
                
                // Î‘ÎºÏŒÎ¼Î± ÎºÎ¹ Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ error, ÎµÏ€Î­ÏƒÏ„ÏÎµÏˆÎµ ÏƒÏ„Î· ÏƒÎµÎ»Î¯Î´Î± rooms
                showPage("rooms-page");
                loadUserRooms();
                
                // Reset current room
                currentRoom = { id: null, name: null, inviteCode: null, isPrivate: false };
                clearChatState();
            }
        }
    );
}

// ğŸ”¥ FIXED: Î¤Î¿ ÎºÏÏÎ¹Î¿ Ï€ÏÏŒÎ²Î»Î·Î¼Î± - Î•ÎÎ—ÎœÎ•Î¡Î©ÎœÎ•ÎÎŸ send message Î¼Îµ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚ Î³Î¹Î± Î±ÏÏ‡ÎµÎ¯Î±
function handleSendMessage() {
    const input = document.getElementById("message-input");
    const text = input.value.trim();

    // Î‘Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿ Î±ÏÏ‡ÎµÎ¯Î¿, Î±Ï€Î¿ÏƒÏ„Î¿Î»Î® Î±ÏÏ‡ÎµÎ¯Î¿Ï…
    if (selectedFile && !fileUploadInProgress) {
        uploadFile();
        return;
    }

    // Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ Î® Î´ÎµÎ½ ÎµÎ¯Î¼Î±ÏƒÏ„Îµ ÏƒÎµ room
    if (!text || !currentRoom.id) return;

    const messageData = {
        text: text,
        sender: currentUser.username,
        time: getCurrentTime(),
    };

    if (currentRoom.isPrivate) {
        const friendUsername = currentRoom.name;
        messageData.receiver = friendUsername;
        socket.emit("private message", messageData);
    } else {
        messageData.room_id = currentRoom.id;
        socket.emit("chat message", messageData);
    }

    input.value = "";
    input.style.height = "auto";
}

// ===== PROFILE SYSTEM FUNCTIONS =====

async function loadUserProfile() {
    if (!currentUser.authenticated) return;
    
    try {
        const response = await fetch(`/user-profile/${currentUser.username}`, {
            headers: {
                "X-Session-ID": currentUser.sessionId,
            },
        });
        
        if (!response.ok) {
            throw new Error("Failed to load profile");
        }
        
        const data = await response.json();
        
        if (data.success) {
            updateProfileUI(data.profile);
            updateProfileStats(data.stats);
        }
    } catch (error) {
        console.error("Error loading profile:", error);
        showNotification("Could not load profile information", "error", "Profile Error");
    }
}

function updateProfileUI(profile) {
    // Basic info
    document.getElementById("profile-username").textContent = profile.username || currentUser.username;
    document.getElementById("profile-email").textContent = profile.email || currentUser.email;
    document.getElementById("info-username").textContent = profile.username || currentUser.username;
    document.getElementById("info-email").textContent = profile.email || currentUser.email;
    document.getElementById("info-status").textContent = profile.status || "Online";
    document.getElementById("info-status").className = `info-value status-${profile.status?.toLowerCase() || 'online'}`;
    
    // Joined date
    if (profile.created_at) {
        const joinedDate = new Date(profile.created_at).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        document.getElementById("info-joined").textContent = joinedDate;
    }
    
    // Profile picture
    const profileImage = document.getElementById("profile-image");
    if (profile.profile_picture) {
        // ğŸ”¥ Î•Î”Î© Î‘Î›Î›Î‘Î“Î—: Î§ÏÎ®ÏƒÎ· Base64 string Î±Ï€ÎµÏ…Î¸ÎµÎ¯Î±Ï‚
        profileImage.src = profile.profile_picture;
        profileImage.style.display = 'block';
    } else {
        profileImage.style.display = 'none';
    }
}

function updateProfileStats(stats) {
    document.getElementById("stat-friends").textContent = stats.friends || 0;
    document.getElementById("stat-rooms").textContent = stats.rooms || 0;
    document.getElementById("stat-messages").textContent = stats.messages || 0;
}

function showProfilePage() {
    loadUserProfile();
    showPage("profile-page");
}

// Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î±Ï…Ï„ÏÎ½ Ï„Ï‰Î½ Î³ÏÎ±Î¼Î¼ÏÎ½ ÏƒÏ„Î¿ uploadProfilePicture() ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ·:
async function uploadProfilePicture(file) {
    if (!file) return;
    
    // ğŸ”¥ Î’Î•Î›Î¤Î™Î©Î£Î—: Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· loading state
    const uploadBtn = document.getElementById("change-profile-pic-btn");
    const originalHTML = uploadBtn.innerHTML;
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
    uploadBtn.disabled = true;
    
    const formData = new FormData();
    formData.append("profile_picture", file);
    formData.append("username", currentUser.username);
    
    try {
        const response = await fetch("/upload-profile-picture", {
            method: "POST",
            headers: {
                "X-Session-ID": currentUser.sessionId,
            },
            body: formData,
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                showNotification("Profile picture updated successfully!", "avatar_upload_success", "Avatar Updated");
                
                // ğŸ”¥ Î‘Î›Î›Î‘Î“Î—: Clear cache ÎºÎ±Î¹ Î±Î½Î±Î½Î­Ï‰ÏƒÎ· Base64 string
                delete userAvatars[currentUser.username];
                
                // Update all avatar elements
                await loadCurrentUserAvatar();
                
                // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· cache Î¼Îµ Ï„Î¿ Î½Î­Î¿ Base64
                userAvatars[currentUser.username] = data.profile_picture;
            }
        } else {
            showNotification("Failed to upload profile picture", "error", "Upload Error");
        }
    } catch (error) {
        console.error("Error uploading profile picture:", error);
        showNotification("Failed to upload profile picture", "error", "Upload Error");
    } finally {
        // Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ Ï„Î¿Ï… ÎºÎ¿Ï…Î¼Ï€Î¹Î¿Ï
        uploadBtn.innerHTML = originalHTML;
        uploadBtn.disabled = false;
    }
}

// Edit profile
async function saveProfileChanges(username, email, profilePicture) {
    try {
        const updateData = {};
        if (username && username !== currentUser.username) {
            updateData.username = username;
        }
        if (email && email !== currentUser.email) {
            updateData.email = email;
        }
        
        if (Object.keys(updateData).length === 0 && !profilePicture) {
            showNotification("No changes to save", "info", "No Changes");
            return;
        }
        
        const response = await fetch("/update-profile", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-Session-ID": currentUser.sessionId,
            },
            body: JSON.stringify({
                username: currentUser.username,
                updates: updateData
            }),
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                // Update current user if username changed
                if (data.user) {
                    currentUser.username = data.user.username;
                    currentUser.email = data.user.email;
                    updateUIForAuthState();
                }
                
                showNotification("Profile updated successfully!", "success", "Profile Updated");
                hideAllModals();
                loadUserProfile();
            }
        }
    } catch (error) {
        console.error("Error updating profile:", error);
        showNotification("Failed to update profile", "error", "Update Error");
    }
}

// Change password
async function changePassword(currentPassword, newPassword, confirmPassword) {
    if (newPassword !== confirmPassword) {
        showNotification("Passwords do not match!", "error", "Password Error");
        return;
    }
    
    try {
        const response = await fetch("/change-password", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-Session-ID": currentUser.sessionId,
            },
            body: JSON.stringify({
                username: currentUser.username,
                currentPassword: currentPassword,
                newPassword: newPassword
            }),
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                showNotification("Password changed successfully!", "success", "Password Changed");
                hideAllModals();
            } else {
                showNotification(data.error || "Failed to change password", "error", "Password Error");
            }
        }
    } catch (error) {
        console.error("Error changing password:", error);
        showNotification("Failed to change password", "error", "Connection Error");
    }
}

// ===== SOCKET EVENT HANDLERS =====

socket.on("connect", () => {
    console.log("ğŸ”— Connected to server");
    if (currentUser.authenticated) {
        socket.emit("authenticate", {
            username: currentUser.username,
            sessionId: currentUser.sessionId,
        });
    }
});

socket.on("load messages", (messages) => {
    console.log("ğŸ’¬ Received messages:", messages.length);
    const messagesContainer = document.getElementById("messages-container");
    messagesContainer.innerHTML = "";
    messages.forEach((msg) => addMessageToChat(msg));
});

socket.on("chat message", (message) => {
    if (message.room_id === currentRoom.id) {
        addMessageToChat(message);
    } else if (message.sender !== currentUser.username) {
        // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· unread Î³Î¹Î± group message
        addUnreadMessage('group', message.sender, message.room_id);
        
        showNotification(
            `New message from ${message.sender} in a room`, 
            "info", 
            "New Room Message",
            {
                type: 'room_message',
                roomId: message.room_id,
                sender: message.sender
            }
        );
    }
});

socket.on("private message", (message) => {
    const isFromCurrentFriend =
        message.sender === currentRoom.name || message.receiver === currentRoom.name;
    if (currentRoom.isPrivate && isFromCurrentFriend) {
        addMessageToChat(message);
    } else if (message.sender !== currentUser.username) {
        // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· unread Î³Î¹Î± private message
        addUnreadMessage('private', message.sender);
        
        showNotification(
            `New private message from ${message.sender}: ${message.text.substring(0, 30)}...`, 
            "info", 
            "New Message",
            {
                type: 'private_message',
                sender: message.sender
            }
        );
    }
});

// ğŸ”¥ ÎÎ•ÎŸ: File upload Î±Ï€ÏŒ Î¬Î»Î»Î¿Ï…Ï‚ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚
socket.on("file_upload", (data) => {
    console.log("ğŸ“ File upload received:", data);
    
    if ((currentRoom.isPrivate && (data.sender === currentRoom.name || data.receiver === currentRoom.name)) ||
        (!currentRoom.isPrivate && data.room_id === currentRoom.id)) {
        
        // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Ï„Î¿Ï… Î±ÏÏ‡ÎµÎ¯Î¿Ï… ÏƒÏ„Î¿ chat
        addMessageToChat({
            text: `ğŸ“ ${data.fileName} (${data.fileSize})`,
            sender: data.sender,
            time: data.time || getCurrentTime(),
            fileUrl: data.fileUrl,
            fileName: data.fileName,
            fileType: data.fileType,
            isFile: true
        });
        
        // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· notification
        showNotification(
            `${data.sender} sent a file: ${data.fileName}`,
            "info",
            "New File",
            null,
            1
        );
    }
});

// ğŸ”¥ ÎÎ•ÎŸ: Unread summary Î±Ï€ÏŒ server
socket.on("unread_summary", (summary) => {
    console.log("ğŸ“Š Received unread summary:", summary);
    
    unreadMessages.private = summary.private || {};
    unreadMessages.groups = summary.groups || {};
    unreadMessages.total = summary.total || 0;
    
    updateUnreadBadges();
    updateFriendsListBadges();
    updateRoomsListBadges();
});

// ğŸ”¥ ÎÎ•ÎŸ: Real-time unread updates
socket.on("unread_update", (data) => {
    console.log("ğŸ“¬ Unread update:", data);
    
    if (data.type === 'private') {
        addUnreadMessage('private', data.sender);
    } else if (data.type === 'group') {
        addUnreadMessage('group', data.sender, data.roomId);
    }
});

// ğŸ”¥ ÎÎ•ÎŸ: Unread cleared confirmation - FIXED Î³Î¹Î± console spam
socket.on("unread_cleared", (data) => {
    // ÎœÏŒÎ½Î¿ Î±Î½ Î­Ï‡Î¿Ï…Î¼Îµ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÎ¬ Î´ÎµÎ´Î¿Î¼Î­Î½Î±
    if (data && (data.type || data.sender || data.roomId)) {
        console.log("âœ… Unread cleared:", data);
        clearUnread(data.type, data.sender, data.roomId);
    }
});

// ğŸ”¥ ÎÎ•ÎŸ: Server notifications Î¼Îµ actions
socket.on("notification", (data) => {
    console.log("ğŸ”” Server notification:", data);
    
    let notificationType = "info";
    let title = "Notification";
    
    switch (data.type) {
        case 'private_message':
            notificationType = "info";
            title = "New Message";
            addUnreadMessage('private', data.sender);
            break;
        case 'group_message':
            notificationType = "info";
            title = "Group Message";
            addUnreadMessage('group', data.sender, data.roomId);
            break;
        case 'friend_request':
            notificationType = "info";
            title = "Friend Request";
            break;
        case 'friend_request_accepted':
            notificationType = "success";
            title = "Friend Request Accepted";
            break;
        case 'avatar_upload_success':
            notificationType = "success";
            title = "Profile Picture Updated";
            break;
        case 'file_upload':
            notificationType = "info";
            title = "New File";
            break;
    }
    
    showNotification(
        `${data.sender}: ${data.message || 'Friend request'}`,
        notificationType,
        title,
        data.action,
        data.count || 1
    );
});

socket.on("room members", (members) => {
    console.log("ğŸ‘¥ Received room members:", members);
    if (!currentRoom.isPrivate) {
        updateRoomMembers(members);
        document.getElementById("room-status").textContent = `${members.length} members`;
        
        // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚ Î³Î¹Î± ÎºÎ¬Î¸Îµ Î¼Î­Î»Î¿Ï‚
        members.forEach(member => {
            // Î¥Ï€Î¿Î¸Î­Ï„Î¿Ï…Î¼Îµ ÏŒÏ„Î¹ ÎµÎ¯Î½Î±Î¹ online ÏŒÏ„Î±Î½ ÎµÎ¼Ï†Î±Î½Î¯Î¶ÎµÏ„Î±Î¹ ÏƒÏ„Î· Î»Î¯ÏƒÏ„Î±
            // ÎœÏ€Î¿ÏÎµÎ¯Ï‚ Î½Î± Î²ÎµÎ»Ï„Î¹ÏÏƒÎµÎ¹Ï‚ Î±Ï…Ï„ÏŒ Î¼Îµ WebSocket status updates
            updateUserStatusInUI(member.username, true);
        });
        
        // Make member items clickable Î³Î¹Î± Ï„Î¿ user info modal
        setTimeout(() => {
            makeMemberItemsClickable();
            loadMemberAvatars();
        }, 100);
    }
});

socket.on("room info", (room) => {
    console.log("ğŸ“¦ Received room info:", room);
    if (room && room.id === currentRoom.id) {
        document.getElementById("room-name-sidebar").textContent = room.name;
        document.getElementById("room-name-header").textContent = room.name;
        document.getElementById("room-description").textContent = `Created by ${room.created_by}`;
    }
});

socket.on("friend_request", (data) => {
    showNotification(
        `New friend request from ${data.from}`, 
        "info", 
        "Friend Request",
        {
            type: 'friend_request',
            from: data.from
        }
    );
    if (document.getElementById("friends-page").classList.contains("active")) {
        loadUserFriends();
    }
});

socket.on("friend_request_accepted", (data) => {
    showNotification(
        `${data.by} accepted your friend request!`, 
        "success", 
        "Friend Request Accepted",
        {
            type: 'friend_request_accepted',
            by: data.by
        }
    );
    if (document.getElementById("friends-page").classList.contains("active")) {
        loadUserFriends();
    }
});

// ğŸ”¥ Î•ÎÎ—ÎœÎ•Î¡Î©Î£Î—: WebSocket event ÏŒÏ„Î±Î½ Î­Î½Î±Ï‚ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Ï†ÎµÏÎ³ÎµÎ¹ Î±Ï€ÏŒ Ï„Î¿ room ÎœÎ‘ÎÎŸÎ¥Î‘Î›Î™Î‘
socket.on("user_left", (data) => {
    console.log(`ğŸ‘‹ User ${data.username} left room ${data.roomId}`);
    
    // Î‘Î½ ÎµÎ¯Î¼Î±ÏƒÏ„Îµ ÏƒÏ„Î¿ Î¯Î´Î¹Î¿ room, Î±Î½Î±Î½Î­Ï‰ÏƒÎµ Ï„Î· Î»Î¯ÏƒÏ„Î± Î¼ÎµÎ»ÏÎ½
    if (currentRoom.id === data.roomId) {
        // Î•Ï€Î±Î½Î±Ï†ÏŒÏÏ„Ï‰ÏƒÎ· Ï„Î·Ï‚ Î»Î¯ÏƒÏ„Î±Ï‚ Î¼ÎµÎ»ÏÎ½
        socket.emit("get room members", { roomId: currentRoom.id });
    }
    
    // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· notification Î¼ÏŒÎ½Î¿ Î±Î½ Î´ÎµÎ½ ÎµÎ¯Î¼Î±ÏƒÏ„Îµ ÎµÎ¼ÎµÎ¯Ï‚ Ï€Î¿Ï… Ï†ÏÎ³Î±Î¼Îµ
    if (data.username !== currentUser.username) {
        showNotification(`${data.username} left the room`, "info", "User Left");
    }
});

// ğŸ”¥ Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—: WebSocket event ÏŒÏ„Î±Î½ Î­Î½Î±Ï‚ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î±Ï€Î¿ÏƒÏ…Î½Î´Î­ÎµÏ„Î±Î¹ (Î±Î»Î»Î¬ Ï€Î±ÏÎ±Î¼Î­Î½ÎµÎ¹ ÏƒÏ„Î¿ room)
socket.on("user_disconnected", (data) => {
    console.log(`ğŸ“¡ User ${data.username} disconnected from room ${data.roomId} (still a member)`);
    
    // Î‘Î½ ÎµÎ¯Î¼Î±ÏƒÏ„Îµ ÏƒÏ„Î¿ Î¯Î´Î¹Î¿ room, ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎµ ÏŒÏ„Î¹ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ ÎµÎ¯Î½Î±Î¹ offline
    if (currentRoom.id === data.roomId) {
        // ÎœÏ€Î¿ÏÎ¿ÏÎ¼Îµ Î½Î± ÎµÎ½Î·Î¼ÎµÏÏÏƒÎ¿Ï…Î¼Îµ Ï„Î¿ UI ÏŒÏ„Î¹ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ ÎµÎ¯Î½Î±Î¹ offline
        // Î±Î»Î»Î¬ Î”Î•Î Ï„Î¿Î½ Î±Ï†Î±Î¹ÏÎ¿ÏÎ¼Îµ Î±Ï€ÏŒ Ï„Î· Î»Î¯ÏƒÏ„Î±
        const memberItem = document.querySelector(`.member-item[data-username="${data.username}"]`);
        if (memberItem) {
            const statusDot = memberItem.querySelector('.status-dot');
            if (statusDot) {
                statusDot.style.background = 'var(--warning)';
                statusDot.title = 'Offline';
            }
        }
    }
});

// ğŸ”¥ Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—: Î•Î½Ï„Î¿Î»Î® Î³Î¹Î± leave room ÏƒÏ„Î¿ WebSocket
socket.on("leave_room_success", (data) => {
    console.log("âœ… Successfully left room:", data.roomId);
    showNotification("Left room successfully", "info", "Room Left");
});

socket.on("session_expired", () => {
    handleSessionExpired();
});

socket.on("error", (data) => {
    showNotification(data.message, "error", "Error");
});

socket.on("disconnect", (reason) => {
    console.log("ğŸ”Œ Disconnected from server:", reason);
    if (reason === "io server disconnect") {
        socket.connect();
    }
});

socket.on("connect_error", (error) => {
    console.error("ğŸ”Œ Connection error:", error);
});

// ===== EVENT LISTENERS =====

function initializeEventListeners() {
    document.getElementById("home-btn").addEventListener("click", () => showPage("home-page"));
    document.getElementById("my-rooms-btn").addEventListener("click", () => {
        loadUserRooms();
        showPage("rooms-page");
    });

    document.getElementById("my-friends-btn").addEventListener("click", () => {
        loadUserFriends();
        showPage("friends-page");
    });

    // Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—: Profile button listener
    document.getElementById("my-profile-btn").addEventListener("click", showProfilePage);

    document.getElementById("logout-btn").addEventListener("click", handleLogout);

    document
        .getElementById("login-nav-btn")
        .addEventListener("click", () => showModal("login-modal"));
    document
        .getElementById("home-login-btn")
        .addEventListener("click", () => showModal("login-modal"));

    document
        .getElementById("register-nav-btn")
        .addEventListener("click", () => showModal("register-modal"));
    document
        .getElementById("home-register-btn")
        .addEventListener("click", () => showModal("register-modal"));

    document
        .getElementById("create-room-btn")
        .addEventListener("click", () => showModal("create-room-modal"));
    document
        .getElementById("create-room-btn-2")
        .addEventListener("click", () => showModal("create-room-modal"));

    document
        .getElementById("join-room-btn")
        .addEventListener("click", () => showModal("join-room-modal"));
    document
        .getElementById("join-room-btn-2")
        .addEventListener("click", () => showModal("join-room-modal"));

    document.getElementById("add-friend-btn").addEventListener("click", () => {
        showModal("add-friend-modal");
    });

    document.querySelectorAll(".close-modal-btn").forEach((btn) => {
        btn.addEventListener("click", hideAllModals);
    });

    document.querySelectorAll('[id$="-cancel"]').forEach((btn) => {
        btn.addEventListener("click", hideAllModals);
    });

    document.getElementById("switch-to-register").addEventListener("click", () => {
        hideAllModals();
        showModal("register-modal");
    });

    document.getElementById("switch-to-login").addEventListener("click", () => {
        hideAllModals();
        showModal("login-modal");
    });

    document.getElementById("login-submit").addEventListener("click", () => {
        const email = document.getElementById("login-email").value;
        const password = document.getElementById("login-password").value;
        handleLogin(email, password);
    });

    document.getElementById("register-submit").addEventListener("click", () => {
        const email = document.getElementById("register-email").value;
        const username = document.getElementById("register-username").value;
        const password = document.getElementById("register-password").value;
        const confirm = document.getElementById("register-confirm").value;
        handleRegister(email, username, password, confirm);
    });

    document.getElementById("create-room-submit").addEventListener("click", () => {
        const roomName = document.getElementById("room-name-input").value;
        handleCreateRoom(roomName);
    });

    document.getElementById("join-room-submit").addEventListener("click", () => {
        const inviteCode = document.getElementById("invite-code-input").value;
        handleJoinRoom(inviteCode);
    });

    document.getElementById("add-friend-submit").addEventListener("click", () => {
        const friendUsername = document.getElementById("friend-username-input").value;
        handleAddFriend(friendUsername);
    });

    const chatForm = document.getElementById("chat-form");
    const messageInput = document.getElementById("message-input");

    chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        handleSendMessage();
    });

    messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            handleSendMessage();
        }
    });

    messageInput.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = this.scrollHeight + "px";
    });

    // Î‘ÎÎ¤Î™ÎšÎ‘Î¤Î‘Î£Î¤Î‘Î£Î— Î¤ÎŸÎ¥ copy-invite-btn EVENT LISTENER
    document.getElementById("copy-invite-btn").addEventListener("click", () => {
        if (currentRoom.isPrivate) {
            showNotification("Invite codes are not available for private chats", "info", "Private Chat");
            return;
        }
        
        const inviteCode = document.getElementById("room-invite-code").textContent;
        if (inviteCode && inviteCode !== "------" && inviteCode !== "Private Chat") {
            navigator.clipboard.writeText(inviteCode).then(() => {
                showNotification("Invite code copied!", "success", "Copied!");
            });
        }
    });

    document.getElementById("copy-username-btn").addEventListener("click", () => {
        const username = document.getElementById("display-my-username").textContent;
        navigator.clipboard.writeText(username).then(() => {
            showNotification("Username copied!", "success", "Copied!");
        });
    });

    // ğŸ”¥ FIXED: Leave room button
    document.getElementById("leave-room-btn").addEventListener("click", handleLeaveRoom);

    document.getElementById("clear-messages-btn").addEventListener("click", () => {
        showConfirmationModal("Clear all messages in this room?", "Clear Messages", () => {
            document.getElementById("messages-container").innerHTML = "";
            showNotification("Messages cleared", "info", "Cleared");
        });
    });

    // ğŸ”¥ Î•ÎÎ—ÎœÎ•Î¡Î©Î£Î—: Î‘Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Ï„Ï…Ï‡Î±Î¯Ï‰Î½ emoji Î¼Îµ file upload
    const fileUploadBtn = document.querySelector('.file-upload-btn');
    const emojiPickerBtn = document.querySelector('.emoji-picker-btn');
    
    if (fileUploadBtn) {
        fileUploadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('file-upload-input').click();
        });
    }
    
    if (emojiPickerBtn) {
        emojiPickerBtn.addEventListener('click', function(e) {
            e.preventDefault();
            showEmojiPicker();
        });
    }

    // Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—: Send file button
    const sendFileBtn = document.getElementById('send-file-btn');
    if (sendFileBtn) {
        sendFileBtn.addEventListener('click', function(e) {
            e.preventDefault();
            uploadFile();
        });
    }

    // Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—: Cancel upload button
    const cancelUploadBtn = document.getElementById('cancel-upload-btn');
    if (cancelUploadBtn) {
        cancelUploadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            cancelFileUpload();
        });
    }

    // Initialize file upload system
    initializeUploadAndEmojiListeners();

    // Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—: Initialize profile event listeners
    initializeProfileEventListeners();
}

// ===== PROFILE EVENT LISTENERS =====

function initializeProfileEventListeners() {
    // Back from profile button
    document.getElementById("back-from-profile-btn").addEventListener("click", () => {
        showPage("home-page");
    });
    
    // Change profile picture button
    document.getElementById("change-profile-pic-btn").addEventListener("click", () => {
        document.getElementById("profile-image-input").click();
    });
    
    // Profile image input
    document.getElementById("profile-image-input").addEventListener("change", function(e) {
        const file = e.target.files[0];
        if (file) {
            uploadProfilePicture(file);
        }
    });
    
    // Edit profile button
    document.getElementById("edit-profile-btn").addEventListener("click", () => {
        showModal("edit-profile-modal");
        document.getElementById("edit-username").value = currentUser.username;
        document.getElementById("edit-email").value = currentUser.email;
    });
    
    // Change password button
    document.getElementById("change-password-btn").addEventListener("click", () => {
        showModal("change-password-modal");
    });
    
    // Save profile changes
    document.getElementById("save-profile-btn").addEventListener("click", () => {
        const username = document.getElementById("edit-username").value;
        const email = document.getElementById("edit-email").value;
        saveProfileChanges(username, email);
    });
    
    // Save password
    document.getElementById("save-password-btn").addEventListener("click", () => {
        const currentPassword = document.getElementById("current-password").value;
        const newPassword = document.getElementById("new-password").value;
        const confirmPassword = document.getElementById("confirm-new-password").value;
        changePassword(currentPassword, newPassword, confirmPassword);
    });
    
    // Cancel buttons
    document.getElementById("cancel-edit-profile-btn").addEventListener("click", hideAllModals);
    document.getElementById("cancel-password-btn").addEventListener("click", hideAllModals);
    document.getElementById("close-edit-profile-modal").addEventListener("click", hideAllModals);
    document.getElementById("close-change-password-modal").addEventListener("click", hideAllModals);
    
    // User info modal actions
    document.getElementById("close-user-info-modal").addEventListener("click", hideAllModals);
    
    document.getElementById("send-private-message-btn").addEventListener("click", () => {
        if (currentViewedUser) {
            hideAllModals();
            startPrivateChatWithFriend(currentViewedUser);
        }
    });
    
    document.getElementById("add-as-friend-btn").addEventListener("click", () => {
        if (currentViewedUser) {
            handleAddFriend(currentViewedUser);
            hideAllModals();
        }
    });
    
    document.getElementById("view-mutual-rooms-btn").addEventListener("click", () => {
        showNotification("Feature coming soon!", "info", "Coming Soon");
    });
    
    // Avatar preview for registration
    document.getElementById("register-browse-btn").addEventListener("click", () => {
        document.getElementById("register-avatar-input").click();
    });
    
    document.getElementById("register-avatar-input").addEventListener("change", function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const preview = document.getElementById("register-avatar-preview");
                preview.src = event.target.result;
                preview.style.display = 'block';
                document.getElementById("register-avatar-placeholder").style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    });
}

// ===== Î’ÎŸÎ—Î˜Î—Î¤Î™ÎšÎ— Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î— Î“Î™Î‘ Î•ÎÎ—ÎœÎ•Î¡Î©Î£Î— ÎšÎ‘Î¤Î‘Î£Î¤Î‘Î£Î—Î£ Î§Î¡Î—Î£Î¤Î— =====

function updateUserStatusInUI(username, isOnline) {
    const memberItem = document.querySelector(`.member-item[data-username="${username}"]`);
    if (memberItem) {
        // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· status dot Î±Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹
        let statusDot = memberItem.querySelector('.status-dot');
        if (!statusDot) {
            const avatarContainer = memberItem.querySelector('.member-avatar');
            if (avatarContainer) {
                statusDot = document.createElement('div');
                statusDot.className = 'status-dot';
                statusDot.style.cssText = `
                    position: absolute;
                    bottom: 0;
                    right: 0;
                    width: 10px;
                    height: 10px;
                    border-radius: 50%;
                    border: 2px solid var(--background);
                `;
                avatarContainer.style.position = 'relative';
                avatarContainer.appendChild(statusDot);
            }
        }
        
        if (statusDot) {
            statusDot.style.background = isOnline ? 'var(--success)' : 'var(--warning)';
            statusDot.title = isOnline ? 'Online' : 'Offline';
        }
    }
}

// ===== MOBILE RESPONSIVE FUNCTIONALITY =====

function initMobileSidebar() {
    const sidebar = document.getElementById('sidebar');
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile && sidebar) {
        // Create overlay
        let overlay = document.querySelector('.sidebar-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.className = 'sidebar-overlay';
            document.body.appendChild(overlay);
        }
        
        // Toggle sidebar on click
        sidebar.addEventListener('click', function(e) {
            if (!e.target.closest('.btn-icon') && !e.target.closest('.action-btn')) {
                this.classList.toggle('mobile-expanded');
                overlay.classList.toggle('active');
            }
        });
        
        // Close sidebar when clicking overlay
        overlay.addEventListener('click', function() {
            sidebar.classList.remove('mobile-expanded');
            this.classList.remove('active');
        });
        
        // Close sidebar when clicking in main chat area
        const mainChat = document.getElementById('main-chat');
        if (mainChat) {
            mainChat.addEventListener('click', function() {
                sidebar.classList.remove('mobile-expanded');
                overlay.classList.remove('active');
            });
        }
    } else {
        // Remove mobile expanded state on larger screens
        if (sidebar) {
            sidebar.classList.remove('mobile-expanded');
        }
        const overlay = document.querySelector('.sidebar-overlay');
        if (overlay) {
            overlay.classList.remove('active');
        }
    }
}

// Enhanced mobile view detection
function isMobileDevice() {
    return window.innerWidth <= 768;
}

// Update UI elements based on mobile state
function updateMobileUI() {
    if (isMobileDevice()) {
        document.body.classList.add('mobile-view');
    } else {
        document.body.classList.remove('mobile-view');
    }
}

// ===== INITIALIZATION =====

document.addEventListener("DOMContentLoaded", async () => {
    console.log("ğŸ€ RatScape client initialized");

    // Create notification container first
    createNotificationContainer();
    initializeEventListeners();

    // Initialize mobile responsive features
    initMobileSidebar();
    updateMobileUI();
    window.addEventListener('resize', function() {
        initMobileSidebar();
        updateMobileUI();
    });

    // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· CSS animations Î³Î¹Î± unread system, file upload, ÎºÎ±Î¹ emoji picker
    const unreadStyle = document.createElement('style');
    unreadStyle.textContent = `
        @keyframes highlightPulse {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(139, 0, 0, 0.7);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 0 15px rgba(139, 0, 0, 0);
                transform: scale(1.02);
            }
        }
        
        @keyframes badgePop {
            0% { transform: scale(0); opacity: 0; }
            70% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .notification-count-badge {
            position: absolute;
            top: 10px;
            right: 35px;
            background: var(--primary);
            color: white;
            border-radius: 10px;
            min-width: 22px;
            height: 22px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
            font-weight: bold;
            animation: badgePop 0.3s ease-out;
        }
        
        /* CSS Î³Î¹Î± disabled copy button */
        #copy-invite-btn:disabled {
            opacity: 0.5 !important;
            cursor: not-allowed !important;
        }
        #copy-invite-btn:disabled:hover {
            background: transparent !important;
            transform: none !important;
        }
        
        /* Avatar styling */
        .member-avatar, #sidebar-avatar, .friend-avatar {
            overflow: hidden;
        }
        
        .member-avatar img, #sidebar-avatar img, .friend-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        /* Message text better wrapping */
        .message-text {
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
        }
        
        /* File upload preview styling */
        .file-preview-container {
            margin: 10px 0;
            padding: 10px;
            background: rgba(26, 26, 26, 0.7);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
        }
        
        .file-preview {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-image-preview {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: var(--radius);
            cursor: pointer;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            display: block;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 5px;
        }
        
        .file-size {
            font-size: 0.8rem;
            color: var(--text-light);
        }
        
        .file-upload-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .file-download-btn {
            background: var(--primary);
            color: white;
            padding: 8px 16px;
            border-radius: var(--radius);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .file-download-btn:hover {
            background: var(--accent-red);
        }
        
        /* Image preview modal */
        .image-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-preview-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }
        
        .full-size-image {
            max-width: 100%;
            max-height: 80vh;
            border-radius: var(--radius);
        }
        
        .close-image-preview {
            position: absolute;
            top: -40px;
            right: 0;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }
        
        .image-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        /* Emoji picker styling */
        .emoji-picker-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .emoji-picker-modal.active {
            display: flex;
        }
        
        .emoji-picker-content {
            background: var(--card-bg);
            border-radius: var(--radius);
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .emoji-categories {
            display: flex;
            gap: 5px;
            padding: 10px;
            background: rgba(38, 38, 38, 0.9);
            border-bottom: 1px solid var(--border-color);
        }
        
        .emoji-category-btn {
            background: transparent;
            border: none;
            padding: 8px 12px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s ease;
        }
        
        .emoji-category-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .emoji-category-btn:hover:not(.active) {
            background: rgba(139, 0, 0, 0.2);
        }
        
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .emoji-item {
            background: transparent;
            border: none;
            padding: 8px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.2s ease;
        }
        
        .emoji-item:hover {
            background: rgba(139, 0, 0, 0.2);
            transform: scale(1.1);
        }
        
        /* Social media footer */
        .social-media-footer {
            margin-top: 40px;
            padding: 20px;
            text-align: center;
            border-top: 1px solid var(--border-color);
        }
        
        .social-media-footer h3 {
            color: var(--text);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .social-icons {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .social-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .social-icon:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .social-icon.instagram {
            background: linear-gradient(45deg, #405DE6, #5851DB, #833AB4, #C13584, #E1306C, #FD1D1D);
        }
        
        .social-icon.facebook {
            background: #1877F2;
        }
        
        .social-icon.twitter {
            background: #1DA1F2;
        }
        
        .social-icon.youtube {
            background: #FF0000;
        }
        
        .social-icon.tiktok {
            background: #000000;
        }
        
        .social-icon.discord {
            background: #5865F2;
        }
        
        /* File item in chat */
        .message-file {
            margin-top: 5px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(38, 38, 38, 0.7);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
        }
        
        .file-item i {
            font-size: 1.5rem;
            color: var(--accent-red);
        }
        
        .file-details {
            flex: 1;
        }
        
        .file-download-link {
            color: var(--accent-red);
            text-decoration: none;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .file-download-link:hover {
            text-decoration: underline;
        }
    `;
    document.head.appendChild(unreadStyle);

    const savedUser = getUserFromLocalStorage();
    
    // ğŸ”¥ Î•Î™Î”Î™ÎšÎ— Î•Î Î•ÎÎ•Î¡Î“Î‘Î£Î™Î‘: ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÏ€Î±Î½Î±Ï†Î­ÏÎ¿Ï…Î¼Îµ chat
    const chatState = loadChatState();
    const lastPageId = localStorage.getItem('ratscape_last_page') || 'home-page';
    
    if (chatState && lastPageId === 'chat-page') {
        console.log('ğŸ”„ Î ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î± ÎµÏ€Î±Î½Î±Ï†Î¿ÏÎ¬Ï‚ chat:', chatState);
        
        // Î”ÎµÎ¯Î¾Îµ Ï„Î¿ chat page Î±Î¼Î­ÏƒÏ‰Ï‚ (Î±Î»Î»Î¬ Ï‡Ï‰ÏÎ¯Ï‚ Ï€ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿ Î±ÎºÏŒÎ¼Î±)
        showPage('chat-page');
    }

    if (savedUser && savedUser.authenticated) {
        try {
            const response = await fetch(`/verify-session/${savedUser.username}`, {
                headers: {
                    "X-Session-ID": savedUser.sessionId,
                },
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    currentUser = {
                        username: data.user.username,
                        email: data.user.email,
                        authenticated: true,
                        sessionId: savedUser.sessionId,
                    };
                    updateUIForAuthState();

                    // ğŸ”¥ Î•Î™Î”Î™ÎšÎŸ: Î‘Î½ Î­Ï‡Î¿Ï…Î¼Îµ Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Î¿ chat state, ÎµÏ€Î±Î½Î±Ï†Î­ÏÎ¿Ï…Î¼Îµ Ï„Î¿ chat
                    if (chatState && lastPageId === 'chat-page') {
                        console.log('ğŸš€ Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ chat Î±Ï€ÏŒ saved state...');
                        
                        // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Î¿Ï… currentRoom
                        currentRoom = {
                            id: chatState.roomId,
                            name: chatState.roomName,
                            inviteCode: chatState.inviteCode,
                            isPrivate: chatState.isPrivate
                        };
                        
                        // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· UI
                        document.getElementById("room-name-sidebar").textContent = chatState.roomName;
                        document.getElementById("room-name-header").textContent = chatState.roomName;
                        
                        if (chatState.isPrivate) {
                            // Private chat
                            document.getElementById("room-description").textContent = `Private conversation with ${chatState.roomName}`;
                            document.getElementById("room-status").textContent = "Private chat";
                            document.getElementById("room-status").classList.add("private-chat");
                            document.getElementById("room-invite-code").textContent = "";
                            document.getElementById("invite-code-container").classList.add("hide-for-private");
                            document.getElementById("copy-invite-btn").style.display = "none";
                            
                            // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï„Î¿Ï… avatar Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î·
                            const sidebarAvatar = document.getElementById("sidebar-avatar");
                            if (sidebarAvatar) {
                                loadUserAvatar(currentUser.username, sidebarAvatar, true);
                            }
                            
                            // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· private messages
                            loadPrivateMessages(chatState.roomName);
                            
                            // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î¼ÎµÎ»ÏÎ½
                            document.getElementById("room-members-list").innerHTML = `
                                <div class="member-item" data-username="${currentUser.username}">
                                    <div class="member-avatar"></div>
                                    <div class="member-info">
                                        <span class="member-name">${currentUser.username}</span>
                                        <span class="member-joined">You</span>
                                    </div>
                                </div>
                                <div class="member-item" data-username="${chatState.roomName}">
                                    <div class="member-avatar"></div>
                                    <div class="member-info">
                                        <span class="member-name">${chatState.roomName}</span>
                                        <span class="member-joined">Friend</span>
                                    </div>
                                </div>
                            `;
                            
                            // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· avatars Î³Î¹Î± Ï„Î± Î¼Î­Î»Î·
                            setTimeout(() => {
                                loadMemberAvatars();
                                makeMemberItemsClickable();
                            }, 100);
                            
                        } else {
                            // Group room
                            document.getElementById("room-invite-code").textContent = chatState.inviteCode || "------";
                            document.getElementById("invite-code-container").classList.remove("hide-for-private");
                            document.getElementById("copy-invite-btn").style.display = "flex";
                            document.getElementById("copy-invite-btn").disabled = false;
                            
                            // Join ÏƒÏ„Î¿ room Î¼Î­ÏƒÏ‰ WebSocket
                            socket.emit("join room", {
                                roomId: chatState.roomId,
                                username: currentUser.username,
                                sessionId: currentUser.sessionId,
                            });
                        }
                        
                        showPage('chat-page');
                        
                    } else {
                        // ÎšÎ±Î½Î¿Î½Î¹ÎºÎ® ÏÎ¿Î® - Ï‡Ï‰ÏÎ¯Ï‚ chat ÎµÏ€Î±Î½Î±Ï†Î¿ÏÎ¬
                        const lastPage = getLastPage();
                        showPage(lastPage);
                    }

                    socket.emit("authenticate", {
                        username: currentUser.username,
                        sessionId: currentUser.sessionId,
                    });

                    // ğŸ”¥ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· avatar Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î·
                    loadCurrentUserAvatar();
                    
                    // ğŸ”¥ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· offline notifications
                    await loadOfflineNotifications();

                    if (lastPageId === "rooms-page") {
                        setTimeout(() => {
                            loadUserRooms();
                        }, 500);
                    } else if (lastPageId === "friends-page") {
                        setTimeout(() => {
                            loadUserFriends();
                        }, 500);
                    }

                    console.log("âœ… User session restored");
                } else {
                    clearUserFromLocalStorage();
                    clearChatState();
                    showPage("home-page");
                    console.log("âŒ Session verification failed");
                }
            } else {
                clearUserFromLocalStorage();
                clearChatState();
                showPage("home-page");
                console.log("âŒ Session verification failed - server error");
            }
        } catch (error) {
            console.error("Error verifying user session:", error);
            clearUserFromLocalStorage();
            clearChatState();
            showPage("home-page");
        }
    } else {
        // ğŸ”¥ Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚, Î±Î»Î»Î¬ Î­Ï‡Î¿Ï…Î¼Îµ chat state, Ï„Î¿ ÎºÎ±Î¸Î±ÏÎ¯Î¶Î¿Ï…Î¼Îµ
        if (chatState) {
            clearChatState();
        }
        console.log("â„¹ï¸ No saved user, staying on current page");
    }

    console.log("âœ… Ready to chat!");
});

// Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚ Ï€ÏÎ¹Î½ Ï„Î¿ refresh
window.addEventListener('beforeunload', function() {
    if (currentRoom.id) {
        saveChatState();
    }
});
